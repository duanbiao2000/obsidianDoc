![image.png](https://cdn.jsdelivr.net/gh/duanbiao2000/BlogGallery@main/picutre/20250513152530328.png)
**文件标题：** 代码发布生产环境流程简报

**来源：** ByteByteGo | 如何将代码发布到生产环境？ (部分节选)

**主要主题：**

这份来源的核心主题是概述公司将代码从开发阶段发布到生产环境的典型工作流程。它详细阐述了软件开发生命周期中涉及的关键步骤、角色和环境。

**最重要的观点和事实：**

- **结构化的工作流程：** 来源强调了代码发布到生产环境需要一个结构化的、分阶段的流程，以确保质量和稳定性。
- **需求驱动：** 流程始于“产品负责人根据需求创建用户故事”。这表明开发工作是根据业务需求和用户需求来驱动的。
- **敏捷开发周期：** “开发团队从待办事项列表中选取用户故事，并将其纳入为期两周的开发周期中。” 这指向了敏捷开发方法的应用，使用迭代的开发周期（冲刺）。
- **版本控制的重要性：** “开发人员将源代码提交到代码仓库 Git。” Git 是一个关键的工具，用于管理代码变更和协作。
- **持续集成 (CI)：** “Jenkins 中触发构建。源代码必须通过单元测试、代码覆盖率阈值和 SonarQube 中的门禁。” 这描述了持续集成的一个关键部分，即代码提交后自动进行构建和测试，以尽早发现问题。
- **构建管理：** “构建成功后，构建会被存储在 Artifactory 中。” Artifactory（或其他类似的制品库）用于存储构建好的软件包，以便后续部署。
- **多环境部署和测试：** 流程包括多个环境，如开发环境 (dev)、QA 环境 (QA1 和 QA2) 和 UAT 环境 (UAT)。这使得代码可以在不同阶段进行独立的测试和验证，以确保在部署到生产环境之前符合要求。
- “可能会有多个开发团队处理不同的特性。特性需要独立测试，因此它们会被部署到 QA1 和 QA2。”
- “QA 团队接收新的 QA 环境并执行 QA 测试、回归测试和性能测试。”
- “一旦 QA 构建通过 QA 团队的验证，它们就会被部署到 UAT 环境。”
- **用户验收测试 (UAT)：** UAT 是一个重要的阶段，它允许最终用户或利益相关者在类似生产的环境中测试软件，以确保它满足他们的需求。
- “如果 UAT 测试成功，这些构建就成为发布候选版本，并将按计划部署到生产环境。”
- **发布候选版本：** 通过所有测试（包括 UAT）的构建才会被视为“发布候选版本”，准备部署到生产环境。
- **生产环境部署和监控：** 最后一步是将通过验证的构建部署到生产环境。“SRE (Site Reliability Engineering) 团队负责生产环境监控。” SRE 团队在代码部署到生产后负责维护系统的可靠性和性能，并通过监控来确保其正常运行。

**引文示例：**

- “流程始于产品负责人根据需求创建用户故事。”
- “开发人员将源代码提交到代码仓库 Git。”
- “Jenkins 中触发构建。源代码必须通过单元测试、代码覆盖率阈值和 SonarQube 中的门禁。”
- “QA 团队接收新的 QA 环境并执行 QA 测试、回归测试和性能测试。”
- “SRE (Site Reliability Engineering) 团队负责生产环境监控。”

**总结：**

这份来源提供了一个典型的软件代码发布到生产环境的逐步流程。它强调了需求管理、版本控制、持续集成、多环境测试（开发、QA、UAT）以及最终的生产部署和监控的关键环节。整个流程旨在确保软件的质量、稳定性和可靠性，最大限度地降低在生产环境中出现问题的风险。

---
您好！您提供的文字和图片共同描述了软件开发中将代码发布到生产环境的典型工作流程，通常被称为 **CI/CD (持续集成/持续部署)** 流程。图片标题是 **"How Companies Ship Code To Production"**（公司如何将代码发布到生产环境）。

以下是对图片和文字内容的详细解读：

这张图清晰地展示了一个现代软件开发团队从计划到最终发布和监控的循序渐进的工作流程。它将整个过程分成了几个主要阶段：计划 (Plan)、开发 (Development)、构建与打包 (Build & Package)、测试 (Test) 和发布 (Release)。

### 典型工作流程步骤分解：

1. Plan (计划阶段):

* Step 1: The process starts with a product owner creating user stories based on requirements.

* 描述： 产品负责人根据需求创建用户故事 (User Stories)。用户故事通常是在敏捷开发中用来描述用户从其角度所需功能的一种简短、简单描述。

* 图示： “Product Owner”角色和一个“Create stories”动作，指向 Jira 图标。

* 理解： 强调了需求的来源和初始规划阶段。

2. Development (开发阶段):

* Step 2: The dev team picks up the user stories from the backlog and puts them into a sprint for a two-week dev cycle.

* 描述： 开发团队从待办事项列表 (Backlog) 中选取用户故事，并将其放入一个冲刺 (Sprint) 中进行为期两周的开发周期。

* 图示： “Dev Team”从 Jira 中“Take user stories”。

* 理解： 这是敏捷开发实践的一部分，通过短周期的迭代来完成开发任务。

* Step 3: The developers commit source code into the code repository Git.

* 描述： 开发人员将源代码提交到 Git 代码仓库。

* 图示： “Developers”将代码“Commit Code to Git”（GitHub 图标）。

* 理解： 版本控制是团队协作和代码管理的基础。

3. Build & Package (构建与打包阶段):

* Step 4: A build is triggered in Jenkins. The source code must pass unit tests, code coverage threshold, and gates in SonarQube.

* 描述： Jenkins (一个常用的自动化服务器) 中触发构建。源代码必须通过单元测试 (Unit Tests)、代码覆盖率阈值 (Code Coverage threshold) 和 SonarQube 中的质量门禁 (gates)。

* 图示： GitHub 触发 Jenkins 构建，Jenkins 内部显示 JUnit (单元测试)、JaCoCo (代码覆盖率) 和 SonarQube (代码质量分析)。

* 理解： 这是持续集成 (Continuous Integration) 的核心，确保代码的质量和可靠性。

* Step 5: Once the build is successful, the build is stored in artifactory. Then the build is deployed into the dev environment.

* 描述： 构建成功后，构建产物存储在制品库 (Artifactory) 中（如 JFrog Artifactory）。然后，构建被部署到开发环境 (Dev Environment)。

* 图示： Jenkins 连接到“Store Builds”的 JFrog Artifactory，然后部署到 Docker 化的“Dev Environment” (云图标)。

* 理解： 制品库用于管理和版本化构建产物。开发环境供开发人员进行初步测试和集成。

4. Test (测试阶段):

* Step 6: There might be multiple dev teams working on different features. The features need to be tested independently, so they are deployed to QA1 and QA2.

* 描述： 可能有多个开发团队处理不同的功能。这些功能需要独立测试，因此它们被部署到 QA1 和 QA2 等不同的 QA 环境中。

* 图示： 从 Dev Environment 分支出多条线，指向多个“QA Environment”（QA1，QA2）进行“Deploy feature”。

* 理解： 允许多个团队并行测试，减少环境冲突。

* Step 7: The QA team picks up the new QA environments and performs QA testing, regression testing, and performance testing.

* 描述： QA 团队接收新的 QA 环境，并执行 QA 测试、回归测试 (Regression Testing) 和性能测试 (Performance Testing)。

* 图示： “QA Team”在 QA 环境中进行“QA testing, regression testing, performance testing”。

* 理解： 全面测试以确保功能正确、性能达标且没有引入新的缺陷。

* Step 8: Once the QA builds pass the QA team’s verification, they are deployed to the UAT environment.

* 描述： QA 构建通过 QA 团队的验证后，它们被部署到用户验收测试 (UAT - User Acceptance Testing) 环境。

* 图示： 从 QA Environment 部署到“UAT Environment”进行“UAT Testing”。

* 理解： UAT 环境允许最终用户或业务代表验证系统是否符合其业务需求。

5. Release (发布阶段):

* Step 9: If the UAT testing is successful, the builds become release candidates and will be deployed to the production environment on schedule.

* 描述： 如果 UAT 测试成功，这些构建将成为发布候选版本 (Release Candidates)，并按计划部署到生产环境 (Production Environment)。

* 图示： UAT Environment 成功后，部署到 Docker 化的“Prod Environment” (云图标)。图示还提到了“Feature toggle”、“canary deployment”和“A/B test”，这些是现代发布策略。

* 理解： 这是持续部署 (Continuous Deployment) 的最后一步，确保只有经过充分验证的代码才能上线。

* Step 10: SRE (Site Reliability Engineering) team is responsible for prod monitoring.

* 描述： SRE (网站可靠性工程) 团队负责生产环境的监控。

* 图示： “SRE Team”负责“monitoring”、“alerting”、“escalation”，并使用了 Prometheus 和 Skywalking 等监控工具。

* 理解： 发布后的持续监控对于确保系统稳定运行、快速发现和响应问题至关重要。

### 整体流程特点和关键技术：

- **敏捷开发 (Agile Development):** 采用用户故事和冲刺周期。
- **持续集成 (Continuous Integration - CI):** 频繁的代码提交、自动化构建、测试和质量检查（Jenkins, SonarQube, JUnit, JaCoCo）。
- **持续部署 (Continuous Deployment - CD):** 自动化部署到各个环境直至生产环境（Artifactory, Docker）。
- **环境隔离：** 区分 Dev, QA, UAT 和 Prod 环境，确保测试的独立性和准确性。
- **质量门禁：** 在不同阶段设置质量检查点，确保只有高质量的代码才能进入下一阶段。
- **现代部署策略：** 提及了特性开关 (Feature Toggle)、金丝雀部署 (Canary Deployment) 和 A/B 测试 (A/B Test)，这些是实现平滑、低风险发布的重要策略。
- **可观测性 (Observability)：** SRE 团队使用监控、警报和升级机制来确保生产环境的健康和性能（Prometheus, Skywalking）。

这张图清晰地展示了一个典型的 DevOps 流水线，涵盖了从需求到生产运营的整个软件生命周期，是理解现代软件交付流程的极佳参考。

---
**简报：软件部署策略和最佳实践**

本简报综合分析了所提供的资源，重点介绍了微服务部署模式、CI/CD 管道以及安全和高效软件交付的关键最佳实践。

**1. 微服务部署模式**

资源强调了几种旨在提高可用性、降低风险和最小化停机时间的微服务部署模式。

- **金丝雀部署（Canary Deployment）**
- **定义：** “这是一种微服务部署中众所周知的策略。金丝雀是微服务的新版本，它将获得一小部分流量。” 新版本首先向一小部分用户发布，并在此过程中进行严密监控。
- **优势：** “它通过尽早检测问题来提高可用性，在关键微服务暴露给整个系统之前。” 如果出现问题，可以将流量路由回稳定版本。
- **风险：** “这种方法最大的潜在缺陷是它可能过早发布微服务。” 早期发布通常是较小的微服务，流量有限，可能无法揭示在大流量下的问题。
- **实施方式：** 可以通过逐渐增加新版本接收的流量百分比来实现。另一个方法是使用“特征标志（feature flags）”，通过配置开关来控制新功能的开启或关闭，从而实现增量发布。“当开发新功能或对现有功能进行重大更改时，将更改包装在特征标志中。这种做法确保了新功能可以通过配置更改而不是代码部署来启用或禁用。”
- **蓝绿部署（Blue-Green Deployment）**
- **定义：** “蓝绿部署策略包括在生产环境中同时维护两个微服务变体。” 一个版本（蓝色）接收用户流量，而另一个版本（绿色）处于空闲状态用于更新。“一旦通过所有测试，微服务将移动到绿色状态，在那里它们获得流量并对用户可见。”
- **优势：** “蓝绿部署可以通过在开发和部署期间保持微服务可用性来提高可用性。” 由于总有另一个稳定版本提供生产流量，“开发和部署期间没有停机时间。” 如果新部署出现问题，“您可以快速回滚到以前的版本（即蓝色微服务）。”
- **风险：** 潜在风险包括“微服务版本不匹配的可能性”以及“微服务需要持续监控以检测问题。这导致成本和时间增加。”
- **暗启动（Dark Launching）**
- **定义：** “暗启动是一种部署更新的技术，这些更新仅针对一小部分用户群体的微服务。” “它不影响整个系统。” 新功能最初对大多数最终用户隐藏。“暗启动过程包括在一个独立于生产环境的环境中构建微服务的新版本。”
- **实施方式：** 测试通过后，将其部署到预生产或测试环境，并逐渐增加推出范围，直到所有用户都暴露在其中。特征标志是实现渐进式发布和控制流量路由的好方法。
- **分阶段发布（Staged Release）**
- **定义：** 资源中提到的“分阶段发布策略”似乎与微服务部署中的逐步推出或增量部署有关，但资源没有详细定义。然而，与前面提到的部署模式类似，其好处在于逐步引入变化。
- **优势：** “在测试环境中知道它们安全之前，不要在生产环境中启用微服务。” 增量部署确保每个服务的故障之间有更长时间，从而实现高可用性。“这也提供了更好的恢复能力。”
- **风险：** “在这种方法中，微服务在新环境中引入时可能会出现停机时间。” 部署大量更改可能使开发团队难以诊断和从故障中恢复。

**2. 部署环境**

软件部署通常涉及多个阶段或环境，以便进行测试、验证和逐步推出。

- **标准环境流程：** 典型的流程从“开发 (DEV)”开始，到“生产 (PROD)”结束。一个常见的四层架构是“开发、测试、模型、生产 (DEV, TEST, MODL, PROD)”。其他环境包括“质量控制 (QC)”、“沙盒或实验 (EXP)”和“灾难恢复”。
- **重要环境定义：本地（Local）：** “开发人员的桌面/工作站”。
- **开发/主干（Development / Trunk）：** “作为沙箱的开发服务器，开发人员可以在其中执行单元测试”。
- **集成（Integration）：** “CI 构建目标，或用于开发人员测试副作用”。
- **测试/QC/内部验收（Testing / Test / QC / Internal acceptance）：** “执行接口测试的环境。质量控制团队确保新代码不会对现有功能产生任何影响，并在测试环境中部署新代码后测试系统的主要功能。” “通常会有几个测试环境。例如，一个用于系统测试，另一个用于性能测试，还有一个用于用户验收测试 (UAT)。”
- **预生产/演示/外部客户端验收/模型/暂存（Staging / Stage / Model / Pre-production / External-client acceptance / Demo）：** “生产环境的镜像”。
- **生产/在线（Production / Live）：** “为最终用户/客户端提供服务”。
- **环境差异：** 不同环境的大小和配置可能差异很大。“开发通常是单个开发人员的工作站，尽管可能有数千名开发人员），而生产可能是许多地理分布的机器；测试和 QC 可能很小或很大，取决于投入的资源，而暂存可以从单台机器（类似于金丝雀）到生产环境的精确复制。”

**3. 持续集成/持续部署 (CI/CD)**

CI/CD 是一种自动化软件交付流程，对于频繁、可靠的发布至关重要。

- **定义与重要性：** “CI/CD 已成为全球许多软件开发团队不可或缺的一部分。” 它提供了从编码到满足客户要求的结构化方法。CI/CD 流程通常由一系列自动化阶段组成，称为“部署管道（deployment pipeline）”。
- **CI/CD 管道：** “部署管道是一种基本的 DevOps 测试策略，它自动化软件交付流程，确保快速可靠的应用程序部署。” 管道通常在开发人员将代码推送到版本控制存储库时触发。如果自动化测试通过，新创建的可执行文件将发送到包存储库，并进入自动部署阶段，通过额外的阶段到达用户。
- **核心实践：版本控制系统 (VCS)：** VCS（如 Git）是 CI/CD 的基础。“VCS 在 CI/CD 中的作用是维护项目中每个更改的历史记录。” 它允许开发人员在隔离环境中工作，并有助于防止意外更改进入生产。
- **自动化测试：** CI/CD 严重依赖自动化测试来验证代码更改。这包括“单元测试（Unit Tests）”，它们检查软件产品的最小可测试组件。资源还提到了其他类型的测试，如自动化用户界面测试和性能测试。
- **持续监控：** 持续监控应用程序性能和日志是 CI/CD 成功和检测问题的关键。
- **容器化：** 使用容器（如 Docker）有助于解决“‘在我机器上可以运行’的问题”，并确保开发人员环境的一致性和可靠性。容器可以在任何操作系统上运行。微服务通常与容器一起使用，因为它们使应用程序模块化，可以独立开发、测试和部署。

**4. 安全软件部署**

部署过程中的安全性与效率和可用性同样重要。

- **主要安全风险：**
- **代码篡改：** 未经授权访问和修改软件代码。通过访问控制和版本控制系统进行缓解。
- **第三方漏洞：** 使用的第三方库和组件中的漏洞。
- **配置错误：** 部署环境中的错误配置。
- **数据不一致性：** 在蓝绿部署切换期间，如果管理不当，敏感数据可能会暴露、丢失或损坏。
- **金丝雀部署风险：** 金丝雀部署可能在完整发布之前将新版本暴露给一小部分用户，可能在此阶段暴露漏洞。“还存在漏洞或恶意软件从金丝雀环境‘泄露’到主生产环境的风险。”
- **安全最佳实践：**
- **代码审查（Code Reviews）：** “代码审查，也称为同行评审，使开发人员能够相互学习，提高代码质量并确保符合编码标准。” 这有助于发现潜在的漏洞。
- **自动化测试：** 自动化测试可以帮助识别安全漏洞。
- **环境强化（Environment Hardening）：** 通过移除不必要的软件、服务和用户、设置防火墙和配置系统权限来减少系统攻击面。“环境强化的最关键方面之一是系统补丁。及时补丁确保您的系统不会受到已知安全漏洞的影响。”
- **持续监控：** 持续监控有助于检测异常活动和潜在的安全事件。“通过评估与安全事件相关的历史日志条目，可以观察导致事件的趋势。” 这使得创建监视器和警报成为可能，指示类似事件即将发生。
- **日志监控：** “日志监控可以提供有关应用程序安全性的见解，帮助您识别恶意活动或异常行为。” 不应记录个人身份信息 (PII)，也不应向最终用户暴露异常详情。
- **使用日志管理工具：** 将所有日志集中在一个位置，便于分析和监控。

**5. 部署失败缓解**

尽管有最佳实践，部署失败仍然可能发生，因此需要一个明确的缓解策略。

- **五个阶段：** 部署失败缓解策略包括：

1. **检测（Detection）：** 识别失败，例如通过冒烟测试失败、用户报告或监控警报。
2. **决策（Decision）：** 确定针对特定故障类型的最佳缓解策略。
3. **缓解（Mitigation）：** 执行确定的缓解措施。
4. **沟通（Communication）：** 通知利益相关者和受影响用户问题状态。
5. **事后分析（Postmortem）：** 进行事后分析以识别改进领域。

- **常见的缓解策略：回滚（Rollback）：** “在回滚场景中，您将更新后的系统恢复到上次已知良好配置状态。” 回滚可能很复杂，特别是涉及到数据更改时。
- **回退（Fallback）：** “在回退场景中，更新后的系统将从生产流量路由中移除。” 所有流量都被导向未更新的版本。这是一种低风险策略，尤其适用于蓝绿部署。“有了金丝雀部署，回退可能不简单甚至不可能，取决于您的基础设施和应用程序设计。”
- **绕过有问题的功能（Bypass the offending function）：** 如果可以使用特征标志或其他运行时配置属性来绕过问题，则可以继续推出。“您应该清楚地了解绕过该功能的权衡，并且应该能够将这种权衡传达给利益相关者。”
- **测试缓解策略：** “经常测试您的整个部署失败缓解策略。”

**总结：**

这些资源共同强调了在现代软件开发中采用成熟的部署策略和实践的重要性，特别是对于微服务架构。通过利用蓝绿部署、金丝雀部署和暗启动等模式，结合强大的 CI/CD 流程、严格的自动化测试、持续监控和强大的安全措施，组织可以实现频繁、高效、安全且具有高可用性的软件交付。日志监控被强调为一种主动工具，不仅用于故障排除，还用于检测安全异常和预测潜在问题。最后，建立一个明确的部署失败缓解策略并定期测试它对于最小化失败的影响至关重要。