---
view-count: 4
update: 2026-01-10 14:20
related:
  - "[[åç«¯å¼€å‘åº”çŸ¥å¿…ä¼š]]"
  - "[[2025-12-06-300è¡Œä»£ç è§£é‡Šä¾èµ–æ³¨å…¥çš„åŸç†]]"
---

å½“ç„¶å¯ä»¥ï¼æˆ‘ä»¬ç”¨ä¸€ä¸ª**è´´è¿‘å®é™…å¼€å‘åœºæ™¯çš„ä¾‹å­**ï¼Œå¸®ä½ å¿«é€Ÿç†è§£ **Python è£…é¥°å™¨ï¼ˆDecoratorï¼‰** çš„ä½œç”¨ã€åŸç†å’Œå†™æ³•ã€‚

---

## ğŸ¯ åœºæ™¯ï¼šç»™ç”µå•†ç³»ç»Ÿçš„â€œä¸‹å•æ¥å£â€æ·»åŠ é€šç”¨åŠŸèƒ½

ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªç”µå•†ç³»ç»Ÿï¼Œæœ‰ä¸€ä¸ªæ ¸å¿ƒå‡½æ•°ï¼š

```python
def create_order(user_id, product_id):
    print(f"ç”¨æˆ· {user_id} æˆåŠŸä¸‹å•å•†å“ {product_id}")
    return {"order_id": "ORD123", "status": "success"}
```

ç°åœ¨ï¼Œäº§å“ç»ç†è¦æ±‚ä½ ï¼š

1. **è®°å½•æ¯æ¬¡è°ƒç”¨çš„æ—¶é—´å’Œå‚æ•°ï¼ˆæ—¥å¿—ï¼‰**
2. **é™åˆ¶æ¯ç§’æœ€å¤š 10 æ¬¡è°ƒç”¨ï¼ˆé™æµï¼‰**
3. **å¦‚æœå‡ºé”™ï¼Œè‡ªåŠ¨é‡è¯• 3 æ¬¡**

å¦‚æœç›´æ¥åœ¨ `create_order` é‡Œå†™è¿™äº›é€»è¾‘ï¼Œä»£ç ä¼šå˜å¾—åˆé•¿åˆä¹±ï¼Œè€Œä¸”å…¶ä»–å‡½æ•°ï¼ˆå¦‚ `cancel_order`ï¼‰ä¹Ÿéœ€è¦ç±»ä¼¼åŠŸèƒ½ã€‚

ğŸ‘‰ **è£…é¥°å™¨å°±æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼**

---

## âœ… ç¬¬ä¸€æ­¥ï¼šæœ€ç®€å•çš„è£…é¥°å™¨ â€”â€” æ·»åŠ æ—¥å¿—

```python
import time
from functools import wraps

def log_calls(func):
    @wraps(func)  # ä¿ç•™åŸå‡½æ•°çš„ __name__ã€__doc__ ç­‰ä¿¡æ¯
    def wrapper(*args, **kwargs):
        print(f"[LOG] è°ƒç”¨ {func.__name__}ï¼Œå‚æ•°: args={args}, kwargs={kwargs}")
        start = time.time()
        result = func(*args, **kwargs)  # æ‰§è¡ŒåŸå‡½æ•°
        end = time.time()
        print(f"[LOG] {func.__name__} è¿”å›: {result}ï¼Œè€—æ—¶: {end - start:.4f}s")
        return result
    return wrapper

# ä½¿ç”¨è£…é¥°å™¨
@log_calls
def create_order(user_id, product_id):
    time.sleep(0.1)  # æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
    return {"order_id": f"ORD_{user_id}_{product_id}", "status": "success"}

# è°ƒç”¨
create_order("U1001", "P2002")
```

### è¾“å‡ºï¼š

```
[LOG] è°ƒç”¨ create_orderï¼Œå‚æ•°: args=('U1001', 'P2002'), kwargs={}
[LOG] create_order è¿”å›: {'order_id': 'ORD_U1001_P2002', 'status': 'success'}ï¼Œè€—æ—¶: 0.1002s
```

> âœ… **è£…é¥°å™¨æœ¬è´¨**ï¼š
> `@log_calls` ç­‰ä»·äº `create_order = log_calls(create_order)`
> å®ƒ**åŒ…è£…äº†åŸå‡½æ•°**ï¼Œåœ¨ä¸ä¿®æ”¹åŸå‡½æ•°ä»£ç çš„æƒ…å†µä¸‹å¢å¼ºåŠŸèƒ½ã€‚

---

## âœ… ç¬¬äºŒæ­¥ï¼šå¸¦å‚æ•°çš„è£…é¥°å™¨ â€”â€” é™æµ

```python
import time
from collections import defaultdict

# å­˜å‚¨æ¯ä¸ªå‡½æ•°çš„è°ƒç”¨æ—¶é—´
call_times = defaultdict(list)

def rate_limit(max_calls=10, window=1):  # è£…é¥°å™¨å·¥å‚
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            now = time.time()
            # æ¸…ç†çª—å£å¤–çš„è®°å½•
            call_times[func.__name__] = [
                t for t in call_times[func.__name__] if now - t < window
            ]
            if len(call_times[func.__name__]) >= max_calls:
                raise Exception(f"è¯·æ±‚å¤ªé¢‘ç¹ï¼{func.__name__} è¶…è¿‡ {max_calls}/ç§’")
            call_times[func.__name__].append(now)
            return func(*args, **kwargs)
        return wrapper
    return decorator

# ä½¿ç”¨ï¼šé™åˆ¶æ¯ç§’æœ€å¤š 2 æ¬¡è°ƒç”¨ï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰
@rate_limit(max_calls=2, window=1)
def create_order(user_id, product_id):
    return {"order_id": f"ORD_{user_id}_{product_id}"}

# æµ‹è¯•
for i in range(3):
    try:
        print(create_order("U1", f"P{i}"))
    except Exception as e:
        print(e)
```

### è¾“å‡ºï¼ˆç¬¬3æ¬¡è¢«é™æµï¼‰ï¼š

```
{'order_id': 'ORD_U1_P0'}
{'order_id': 'ORD_U1_P1'}
è¯·æ±‚å¤ªé¢‘ç¹ï¼create_order è¶…è¿‡ 2/ç§’
```

> âœ… **å¸¦å‚æ•°çš„è£…é¥°å™¨** = **ä¸‰å±‚å‡½æ•°**ï¼š
> `rate_limit(...)` è¿”å› `decorator`ï¼Œå†è¿”å› `wrapper`

---

## âœ… ç¬¬ä¸‰æ­¥ï¼šé‡è¯•è£…é¥°å™¨ â€”â€” è‡ªåŠ¨é‡è¯•å¤±è´¥æ“ä½œ

```python
import random

def retry(max_attempts=3, delay=1):
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            for attempt in range(max_attempts):
                try:
                    return func(*args, **kwargs)
                except Exception as e:
                    print(f"[RETRY] {func.__name__} ç¬¬ {attempt+1} æ¬¡å¤±è´¥: {e}")
                    if attempt == max_attempts - 1:
                        raise e
                    time.sleep(delay)
        return wrapper
    return decorator

# æ¨¡æ‹Ÿä¸€ä¸ªå¯èƒ½å¤±è´¥çš„å‡½æ•°
@retry(max_attempts=3, delay=0.5)
def create_order(user_id, product_id):
    if random.random() < 0.7:  # 70% æ¦‚ç‡å¤±è´¥
        raise Exception("æ”¯ä»˜ç½‘å…³è¶…æ—¶")
    return {"order_id": f"ORD_{user_id}_{product_id}"}

# è°ƒç”¨
result = create_order("U1001", "P2002")
print("æœ€ç»ˆç»“æœ:", result)
```

---

## ğŸ§  è£…é¥°å™¨çš„æ ¸å¿ƒæ€æƒ³

| é—®é¢˜                   | è£…é¥°å™¨å¦‚ä½•è§£å†³             |
| -------------------- | ------------------- |
| å¤šä¸ªå‡½æ•°éœ€è¦ç›¸åŒé€»è¾‘ï¼ˆæ—¥å¿—ã€æƒé™ã€ç¼“å­˜ï¼‰ | **æŠ½ç¦»å…¬å…±é€»è¾‘ï¼Œå¤ç”¨**       |
| ä¸æƒ³ä¿®æ”¹åŸå‡½æ•°ä»£ç             | **é€šè¿‡åŒ…è£…é€æ˜å¢å¼º**        |
| éœ€è¦æ§åˆ¶å‡½æ•°æ‰§è¡Œå‰åè¡Œä¸º         | **åœ¨ wrapper ä¸­æ’å…¥é€»è¾‘** |

---

## âœ… å¸¸è§è£…é¥°å™¨åº”ç”¨åœºæ™¯

| åœºæ™¯       | ç¤ºä¾‹                      |
| -------- | ----------------------- |
| **æ—¥å¿—è®°å½•** | `@log_calls`            |
| **æ€§èƒ½è®¡æ—¶** | `@timeit`               |
| **æƒé™æ ¡éªŒ** | `@require_admin`        |
| **ç¼“å­˜ç»“æœ** | `@lru_cache`ï¼ˆPython å†…ç½®ï¼‰ |
| **é™æµç†”æ–­** | `@rate_limit`           |
| **è‡ªåŠ¨é‡è¯•** | `@retry`                |
| **è¾“å…¥éªŒè¯** | `@validate_schema`      |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¸€å®šè¦ç”¨ `@wraps(func)`**
   å¦åˆ™åŸå‡½æ•°çš„ `__name__`ã€`__doc__` ä¼šå˜æˆ `wrapper`ï¼Œå½±å“è°ƒè¯•å’Œæ–‡æ¡£ã€‚

2. **è£…é¥°å™¨ä¼šæ”¹å˜å‡½æ•°ç­¾å**
   å¦‚æœéœ€è¦ä¸¥æ ¼ä¿æŒç­¾åï¼Œå¯ç”¨ `inspect.signature` æˆ–ç¬¬ä¸‰æ–¹åº“ï¼ˆå¦‚ `decorator`ï¼‰ã€‚

3. **å¤šä¸ªè£…é¥°å™¨çš„æ‰§è¡Œé¡ºåº**
   ```python
   @A
   @B
   def f(): ...
   # ç­‰ä»·äº f = A(B(f))ï¼Œå…ˆ B å A
   ```

---

## âœ… æ€»ç»“ä¸€å¥è¯

> **è£…é¥°å™¨ = å‡½æ•°çš„â€œå¤–å¥—â€** â€”â€”
> ä¸æ”¹å˜å‡½æ•°æœ¬èº«ï¼Œå´èƒ½ç»™å®ƒç©¿ä¸Šâ€œæ—¥å¿—è¡£â€ã€â€œé™æµç›”ç”²â€æˆ–â€œé‡è¯•æ–—ç¯·â€ï¼Œè®©ä»£ç æ›´å¹²å‡€ã€æ›´å¯ç»´æŠ¤ï¼

å¦‚æœä½ æœ‰å…·ä½“éœ€æ±‚ï¼ˆæ¯”å¦‚â€œå¦‚ä½•å†™ä¸€ä¸ªç¼“å­˜è£…é¥°å™¨ï¼Ÿâ€ã€â€œå¦‚ä½•è£…é¥°ç±»æ–¹æ³•ï¼Ÿâ€ï¼‰ï¼Œæ¬¢è¿å‘Šè¯‰æˆ‘ï¼Œæˆ‘å¯ä»¥ç»™å‡ºå®Œæ•´ä»£ç ï¼
