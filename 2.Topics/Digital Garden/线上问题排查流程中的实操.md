---
view-count: 7
update: 2026-01-16 12:42
related:
  - "[[线上应用性能瓶颈与报错排查思路]]"
---

# 订单查询接口日志在哪？

## 笔记类型

- 类型：实践经验 / 运维排查
- 主题：线上问题排查中的“日志在哪找”
- 场景：订单查询接口响应慢，需定位慢 SQL

---

## 核心结论（What）

> 线上排查“订单查询接口变慢”时，最应该去的日志位置是：\
> **公司统一的日志平台（如 Kibana）或 APM 系统（如 SkyWalking）**，\
> 而不是盲目上服务器找本地 log 文件。

---

## 1. 需要的到底是哪种“日志”？（Log 类型区分）

### 1.1 访问日志（Access Log / Request Log）

- 内容：URL、状态码、总耗时、IP、traceId
- 作用：知道「哪个请求慢」「慢了多久」
- 局限：通常看不到具体 SQL

### 1.2 业务日志（Application Log）

- 内容：内部执行信息，如 SQL、异常堆栈、业务关键流程
- 作用：看到「接口内部发生了什么」，包括 SQL 语句及耗时
- 你要找的：**包含 SQL 和耗时信息的业务日志（可能由 ORM 打印）**

---

## 2. 日志最常见的存放位置（Where）

### 2.1 集中式日志平台（生产环境最常见）

- 典型实现：
  - ELK：Elasticsearch + Logstash + Kibana
  - Graylog / Splunk
  - 云日志：阿里云 SLS、腾讯云 CLS、AWS CloudWatch Logs
- 查找方式（示例）：
  - 在 Kibana 搜索条件：
    - `service: order-service`
    - `uri: "/api/order/query"` 或 `/order/detail`
    - `duration > 1000`（筛 >1s 请求）
- 价值：
  - 按服务 / 路径 / 耗时过滤
  - 通常能通过 traceId 关联到 SQL 日志

---

### 2.2 APM（应用性能监控）

- 常见工具：
  - SkyWalking、Pinpoint
  - Datadog APM、New Relic
  - 阿里云 ARMS、腾讯云 APM
- 能看到的东西：
  - 完整调用链（Trace）：HTTP → Service → DAO → SQL
  - 每条 SQL 的耗时
  - 慢 SQL 排行
- 实际操作方式（典型闭环）：
  1. 在 APM 按接口 `/order/query` 或服务 `order-service` 筛选
  2. 按「耗时倒序」看最慢的请求
  3. 点开 trace，看是哪条 SQL 占用时间
- 解释：
  - 能在「5 分钟内发现慢 SQL」的典型路径，就是靠 APM。

---

### 2.3 数据库慢查询日志（DB Slow Log）

- 适用场景：应用层没打印 SQL，或只是做 DB 侧审计
- MySQL：
  - `slow_query_log=ON`
  - `long_query_time = 1`（记录 >1s SQL）
  - 日志文件如：`/var/log/mysql/slow.log`
- PostgreSQL：
  - `log_min_duration_statement = 1000`（>1s）
- 局限：
  - 知道「哪条 SQL 慢」，但不知道「是哪个接口触发的」
  - 需要结合时间和 SQL 反推到接口

---

### 2.4 应用本地日志文件（传统 / 小公司常见）

- 示例路径：
  - Java：`/var/log/order-service/app.log`
  - Node.js：`/home/app/logs/order-api.log`
  - Docker 临时日志：`docker logs <container_id>`
- 问题：
  - 容器化+弹性扩缩后，本地日志不稳定
  - 生产一般不鼓励 SSH 上机翻 log
- 只适合作为：**最后兜底方案**，而非常规手段

---

## 3. 实战排查流程（How）

> 目标：定位「订单查询接口」对应的慢 SQL

### 3.1 推荐流程（有日志平台 / APM）

1. 打开公司统一的日志平台或 APM
2. 选中服务：`order-service`（或类似订单相关服务名）
3. 按接口路径过滤：`/order/query`、`/order/detail` 等
4. 按「耗时」降序排列，筛选例如 `> 1000ms`
5. 打开某条慢请求详情：
   - 如果是 APM：直接在调用链中看 SQL 及其耗时
   - 如果是日志平台：用 traceId 去搜索 SQL 打印日志

**一句话操作模板：**

> 「在 [Kibana/SkyWalking] 里选 `order-service`，按 `/order/query` + 耗时 >1s 过滤，点某条慢请求，看调用链里的 SQL。」

---

### 3.2 如果没有 APM / 集中式日志怎么办？

1. 确认应用是否打印 SQL（如 MyBatis 日志级别）
2. 直接在日志文件中 grep 关键字段：
   - `grep "/order/query" app.log | grep "cost"`（请求耗时）
   - 再拿对应 traceId 去找 SQL 打印
3. 辅以数据库 slow log 分析工具（如 `pt-query-digest`）

---

## 4. 常见误区（Pitfalls）

- 误区 1：\
  「日志在服务器上，SSH 上去看就行」\
  → 大型线上环境通常禁止这样操作，而且效率和可靠性都低。

- 误区 2：\
  「看 Nginx access.log 就够了」\
  → 只能看到整体响应时间，**看不到内部 SQL 分布**。

- 误区 3：\
  「有问题就找 DBA 看 slow log」\
  → 无法直接对应到具体业务接口，请求上下文缺失。

---

## 5. 元信息与行动建议

- 隐含前提：
  - 已有统一日志平台或 APM
  - 日志里有 traceId / requestId 串起全链路
  - ORM 或业务层有 SQL 打印（至少对慢请求）
- 组织实践建议：
  - 新人入职时，必须问清楚：
    - 「我们系统的日志平台入口地址是？」
    - 「APM 系统在哪看 trace？」
  - 把入口链接 + 常用查询语句记录到个人知识库

---
