---
aliases: 
theme: 
high_priority: false
tags:
---
### @route.ts 的执行调用顺序总结

1. **接收请求**
    
    - 接收到一个 `POST` 请求。
2. **获取客户端 IP 地址**
    
    - 使用 `requestIp.getClientIp()` 获取客户端 IP 地址，并将其作为限流标识符。
3. **创建新的 Headers 对象**
    
    - 创建一个新的 `Headers` 对象，用于后续添加自定义限流头信息。
4. **条件性限流检查**
    
    - 检查是否需要执行限流。
    - 如果需要限流且环境变量配置正确，则执行限流检查。
    - 根据限流结果设置自定义头信息。
    - 如果限流失败，返回 429 状态码。
5. **解析请求体中的 JSON 数据**
    
    - 从请求体中解析出 JSON 数据。
6. **提取请求参数**
    
    - 从解析出的 JSON 数据中提取 `imageUrl`, `roomType`, `roomTheme`, `buildingType`, `buildingTheme` 等参数。
7. **开始图像生成过程**
    
    - 向 `https://api.replicate.com/v1/predictions` 发送 `POST` 请求，开始图像生成过程。
    - 设置请求头信息和请求体内容。
8. **解析初始化响应的 JSON 数据**
    
    - 解析初始化响应的 JSON 数据，提取预测 ID (`id`)。
9. **轮询 API 直到图像生成完成**
    
    - 每隔一秒轮询 `https://api.replicate.com/v1/predictions/{id}`，直到图像生成完成。
    - 如果生成成功，获取生成的图像 URL。
    - 如果生成失败，抛出错误。
10. **返回生成的图像 URL**
    
    - 将生成的图像 URL 作为响应返回。如果生成失败，则返回错误信息。