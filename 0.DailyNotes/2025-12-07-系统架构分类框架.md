# 系统架构问题分类框架

## I. 基础设施层（Infrastructure Layer）

### 1. 网络系统
**核心问题**：如何在高并发下实现连接复用和协议优化以降低延迟和带宽消耗

**核心关注点**：
- 连接生命周期管理（建立、复用、关闭成本）
- 协议选择与开销（HTTP/1.1 vs HTTP/2 vs QUIC，头部压缩）
- 背压处理与流量控制机制
- 延迟敏感路径的优化（RTT优化、缓冲区大小）

**常见陷阱与边界**：
- 误认为更多连接数 = 更好的并发性，忽视了FD限制和内存成本
- TCP vs UDP选择时只考虑可靠性，忽视延迟特性差异
- 优化单个连接而忽视整体网络拓扑瓶颈（如BGP路由、ISP限制）
- 在局域网优化策略直接应用于公网，导致反效果

---

### 2. 数据库系统
**核心问题**：如何在读写冲突中平衡强一致性和高可用性

**核心关注点**：
- 一致性模型选择（强一致、最终一致、因果一致）
- 复制延迟与写入可用性的权衡
- 分布式事务的成本与替代方案（Saga、补偿事务）
- 故障转移时的数据丢失风险与恢复时间

**常见陷阱与边界**：
- CAP定理误读：认为不能同时实现三者，忽视可调整的权衡空间
- 过度设计强一致性导致性能崩溃，而业务实际可容忍最终一致
- 忽视网络分区场景，设计的方案在网络抖动时失效
- 单点故障转移方案（主从）被当作高可用，忽视转移期间的不可用窗口

---

### 3. 消息队列
**核心问题**：如何保证消息的顺序性、可靠性和高吞吐量的同时避免系统过载

**核心关注点**：
- 消息去重与幂等性设计（生产侧、消费侧）
- 顺序性与并行度的矛盾（单队列vs多分区+消费组）
- 背压与流控机制（Broker端、Consumer端）
- 消息堆积对系统的影响与恢复策略

**常见陷阱与边界**：
- 追求端到端顺序性而用单分区，导致吞吐量瓶颈和消费端不可扩展
- 依赖消息队列做流控，结果被堆积的消息压垮内存
- 认为"至少一次"递送能完全解决问题，忽视重复消息的业务层影响
- 消息TTL/过期策略过激，导致数据丢失；过保守导致磁盘爆满

---

## II. 数据处理层（Data Processing Layer）

### 4. 流处理系统
**核心问题**：如何在无界数据流中实时计算聚合结果并处理乱序/迟到数据

**核心关注点**：
- 窗口语义选择（滚动、滑动、会话窗口）与水位线（Watermark）设计
- 乱序数据的延迟容忍度设置（允许多久的迟到）
- 状态管理与检查点机制的成本
- 精准一次（Exactly-Once）语义的实现与性能影响

**常见陷阱与边界**：
- 用事件时间（Event Time）却设置过短的水位线，导致大量结果被丢弃
- 无状态处理外推到有状态计算，忽视状态爆炸（如去重集合无界增长）
- 检查点过频繁导致吞吐量下降，过稀疏导致故障恢复时间过长
- 混淆处理时间和事件时间，在回溯历史数据时得到错误结果

---

### 5. 日志系统
**核心问题**：如何在TB级数据规模下快速搜索和分析，同时保持存储成本可控

**核心关注点**：
- 索引粒度与查询延迟的权衡（倒排索引、时间索引）
- 日志采样策略对监控准确性的影响
- 数据热冷分离与存储成本优化
- 查询并发与资源隔离（防止昂贵查询压垮系统）

**常见陷阱与边界**：
- 对所有字段建立全文索引，导致写入性能崩溃和存储成本飙升
- 采样率设置过高占用存储，过低导致低频事件检测失效
- 假设日志体量线性增长，设计方案在指数增长时崩溃
- 忽视查询热点，高频查询慢查询拖累整个系统

---

### 6. 数据仓库
**核心问题**：如何设计多维度的数据模型以支持复杂查询同时保持查询性能

**核心关注点**：
- 星型模型 vs 雪花模型的设计选择与查询优化器配合
- 物化视图与实时性的权衡（何时刷新）
- 分布式查询的数据倾斜问题与Join策略
- 成本控制：存储 vs 计算资源的动态分配

**常见陷阱与边界**：
- 过度规范化设计导致Join过多，查询性能急剧下降
- 物化视图太多，维护成本和存储成本失控
- 大表Join小表时忽视广播成本与内存溢出风险
- 跨数据中心的查询没有本地化策略，网络成为瓶颈

---

## III. 业务逻辑层（Business Logic Layer）

### 7. 库存系统
**核心问题**：如何在超卖风险和库存准确性间找到平衡，同时支持高并发扣减

**核心关注点**：
- 库存扣减的隔离级别选择（行锁vs表锁vs无锁算法）
- 预留库存与确认库存的两阶段机制设计
- 超卖容限的设定与风险承受度
- 库存同步延迟导致的一致性问题

**常见陷阱与边界**：
- 使用悲观锁（行锁）确保准确性，导致并发度严重下降，成为性能瓶颈
- 完全无锁方案消除超卖但引入复杂的补偿逻辑和数据不一致问题
- 允许适量超卖却未清晰定义"适量"的度量和监控方式
- 忽视缓存与数据库的不一致窗口，缓存显示有货但实际超卖

---

### 8. 工作流引擎
**核心问题**：如何容错处理长流程业务逻辑并支持人工介入和异常恢复

**核心关注点**：
- 工作流状态机设计与异常状态的处理（重试、回滚、跳过）
- 任务幂等性保证与去重机制
- 长流程中的中间结果持久化与恢复点设计
- 人工介入的决策点与权限控制

**常见陷阱与边界**：
- 盲目重试失败任务而不判断幂等性，导致重复处理和数据不一致
- 缺少降级或超时处理，某个下游服务故障导致整个流程卡死
- 恢复点粒度过粗，故障恢复需要重新执行大量已完成的任务
- 人工介入流程复杂度高或权限控制不当，导致误操作或安全风险

---

### 9. 搜索系统
**核心问题**：如何在相关性、性能和实时性间权衡以提供最佳搜索体验

**核心关注点**：
- 召回模型（向量召回、倒排索引召回）与排序模型的协同
- 索引更新延迟对实时性的影响与解决方案（增量索引）
- 个性化排序引入的计算成本与用户体验提升
- 长尾查询（低频搜索词）的处理与降级策略

**常见陷阱与边界**：
- 过度优化热点查询而忽视长尾查询的用户体验
- 个性化排序引入复杂特征工程，导致查询延迟无法接受
- 索引更新太频繁（追求实时性）导致写入成本爆炸，过稀疏则搜索结果陈旧
- 相关性算法调整频繁，导致用户困惑或点击率波动

---

## IV. 安全与合规层（Security & Compliance Layer）

### 10. 身份认证系统
**核心问题**：如何在分布式环境中安全地验证用户身份并管理会话状态

**核心关注点**：
- Token vs Session的选择（无状态vs有状态）与跨域问题
- Token失效机制与撤销成本（黑名单vs短期限）
- 多因素认证的用户体验与安全性平衡
- 分布式系统中的会话同步与一致性

**常见陷阱与边界**：
- 过长的Token有效期降低安全性，过短则频繁刷新导致用户体验差
- Token黑名单实现不当变成性能瓶颈，短期限方案导致频繁认证
- 忽视Token泄露场景（XSS、中间人攻击），仅依赖HTTPS
- 多因素认证流程复杂导致用户流失，简化又降低安全性

---

### 11. 权限系统
**核心问题**：如何高效地评估细粒度权限规则而不产生性能瓶颈

**核心关注点**：
- 权限模型选择（RBAC、ABAC、ACL）与复杂度权衡
- 权限缓存策略与权限变更的最终一致性
- 权限继承与冲突解决规则
- 权限决策点的位置选择（网关、应用、数据库）

**常见陷阱与边界**：
- 权限规则过复杂（嵌套条件、多维度组合）导致评估延迟高不可接受
- 权限缓存过期时间设置不当，过短频繁查询数据库，过长权限变更不及时生效
- 权限决策分散在多处导致不一致，集中在网关又可能成为瓶颈
- 忽视权限变更的传播延迟，用户删除后仍有时间窗口可以访问资源

---

## V. 高级场景（Advanced Scenarios）

### 12. 实时推荐系统
**核心问题**：如何根据用户实时行为动态调整推荐内容

**核心关注点**：
- 特征更新延迟与推荐结果新鲜度的权衡
- 探索（Exploration）与利用（Exploitation）的平衡
- 冷启动问题的解决方案（新用户、新物品）
- 推荐多样性与个性化强度的控制

**常见陷阱与边界**：
- 实时更新特征导致模型漂移，推荐结果不稳定甚至恶化
- 过度个性化导致用户被困在信息茧房，长期用户满意度下降
- 完全探索新内容导致用户体验差，完全利用历史偏好导致系统僵化
- 忽视新用户场景，推荐效果对新用户极差，无法获取用户

---

### 13. 云原生微服务架构
**核心问题**：如何确保微服务间通信的可靠性和一致性

**核心关注点**：
- 服务发现与负载均衡的一致性（DNS缓存、连接池）
- 分布式事务的一致性保证（两阶段提交 vs Saga）
- 网络故障的检测与恢复（超时、熔断、重试）
- 服务间依赖关系与级联故障的防控

**常见陷阱与边界**：
- 两阶段提交提供强一致但引入复杂性和性能问题，Saga简化但需要补偿逻辑
- 重试策略不当导致级联故障（雷鸣羊群效应），或重试不足导致丢失
- 熔断器开启后无恢复机制，导致服务长期不可用
- 服务依赖图复杂时，一个服务故障影响范围难以预测

---

### 14. AI训练平台
**核心问题**：如何高效利用GPU资源加速大规模模型训练并优化资源利用率

**核心关注点**：
- 数据并行 vs 模型并行的选择与通信开销
- 资源异构性下的调度算法（不同GPU型号、网络拓扑）
- 故障恢复与检查点开销（频率、粒度）
- 成本与速度的权衡（用便宜资源 vs 昂贵资源）

**常见陷阱与边界**：
- 数据并行在参数服务器间通信成为瓶颈，模型并行导致某些GPU空闲
- 检查点过频繁产生IO瓶颈和存储成本，过稀疏故障恢复时间过长
- 动态资源分配导致训练不稳定，固定资源分配浪费
- 忽视预热（Warmup）阶段，优化器发散或收敛缓慢

---

### 15. 区块链系统
**核心问题**：如何在去中心化环境中保证交易的不可篡改性和共识效率

**核心关注点**：
- 共识算法的安全性与吞吐量权衡（PoW vs PoS vs BFT）
- 分叉处理与链选择规则的一致性
- 智能合约执行的确定性与可验证性
- 状态存储与查询性能在去中心化约束下的优化

**常见陷阱与边界**：
- PoW提供强安全但吞吐量极低且能耗巨大，PoS削减安全性但可扩展性强
- 51%攻击防御集中在矿池权力，导致实际中心化程度高
- 智能合约漏洞导致资金损失，修复难（无法修改已上链代码）
- 轻节点与全节点的同步延迟，轻节点接收过期信息做出错误决策

---

### 16. 物联网平台
**核心问题**：如何处理海量设备的实时数据接入并提供低延迟响应

**核心关注点**：
- 设备连接管理与长连接保活的成本（心跳频率、网络类型差异）
- 数据采样与上报频率的优化（减少传输 vs 保证准确性）
- 边缘计算与云端处理的划分（延迟、成本、功能完整性）
- 设备离线与重新上线的状态一致性

**常见陷阱与边界**：
- 心跳过频繁导致电池快速耗尽，过稀疏导致离线检测延迟高
- 所有数据上报导致网络和存储爆炸，采样过激丢失重要信息
- 边缘计算能力受限（设备资源少），云端处理延迟高
- 设备离线后重新上线，历史数据丢失或重复

---

### 17. 云存储系统
**核心问题**：如何在分布式环境中保证数据的高可用性和一致性

**核心关注点**：
- 副本策略与故障域设计（副本数、跨机房）
- 数据修复的成本与速度（全量 vs 增量、本地 vs 跨AZ）
- 一致性与可用性的权衡（强一致性下故障时不可用）
- 故障转移中的数据丢失风险

**常见陷阱与边界**：
- 副本数过多（如3份）提高可用性但存储成本3倍，过少降低容错能力
- 故障恢复数据修复时网络带宽成为瓶颈，大文件修复可能需要数天
- 跨AZ副本保证地域容灾但引入更高延迟和成本
- 最终一致性下的脑裂场景，两个数据中心各有不同版本

---

### 18. 社交媒体平台
**核心问题**：如何实时处理和分析海量用户互动数据以优化内容分发和用户体验

**核心关注点**：
- Feed生成的实时性 vs 个性化深度的平衡
- 热点内容与长尾内容的分发策略不一
- 用户交互信号的实时处理与离线分析的协同
- 缓存策略在大规模用户下的效率与一致性

**常见陷阱与边界**：
- 过度个性化导致信息茧房，用户体验单调，长期用户流失
- 热点内容分发不均导致某些服务器过载，冷内容无人问津
- 实时信号处理导致结果振荡（推荐变化频繁），用户困惑
- Feed缓存失效导致首屏加载慢，缓存过期策略不当导致内容陈旧

---

### 19. 支付系统
**核心问题**：如何确保每笔交易恰好被处理一次且不出现重复或丢失

**核心关注点**：
- 幂等性设计与去重机制（生产侧、处理侧、结算侧）
- 对账与清算的精准性与效率
- 故障下的资金安全与恢复流程
- 交易状态管理与最终一致性

**常见陷阱与边界**：
- 依赖数据库唯一约束确保幂等，但约束失效或分布式锁竞争导致重复
- 对账周期过长导致问题发现延迟，过频繁对账产生大量计算成本
- 退款流程复杂且容易出错，特别是涉及多个上游方的情况
- 故障转移中的交易重复或丢失风险，恢复流程不清晰

---

## 使用指南

**在面对新问题时的三步法**：
1. **定位问题类型**：根据问题所属的层级（基础设施、数据处理、业务逻辑、安全）进行分类
2. **提取核心矛盾**：从"核心关注点"中识别该问题的本质权衡
3. **规避已知陷阱**：从"常见陷阱与边界"中找出容易误踩的坑，提前思考应对方案

**不同场景的应用**：
- **系统设计面试**：用核心问题和关注点快速构建答题框架
- **架构评审**：用陷阱和边界检查设计方案的完整性
- **技术选型**：用权衡分析比较不同方案的优劣

---

我已经创建了一个完整的系统架构问题分类框架，包含了19个典型系统场景。

**框架的结构**：

- **4个主层级**（基础设施、数据处理、业务逻辑、安全）+ 高级场景
- **每个问题**包含：核心问题定义、2-5条核心关注点、1-5条常见陷阱与边界
- **最后附赠**使用指南，告诉你如何在实际工程中应用这个框架

**我的设计思路**：

1. **陷阱与边界的选择标准**：优先选择Google规模系统中最容易掉进去的坑（而不是理论陷阱），这样对你的日常架构决策更有参考价值
    
2. **关注点的深度**：避免过于宽泛的描述，而是聚焦在真正会导致设计方案成败的几个决策点
    
3. **权衡分析**：大多数陷阱源于对权衡的误判，所以重点突出了各类权衡关系
    

**建议的后续步骤**：

- 如果你在某个具体系统设计上遇到问题，可以直接用这个框架定位核心问题
- 针对你最常接触的2-3个系统类型，可以进一步深化（加入具体实现案例、代码示例）
- 这个框架也可以作为技术面试时的快速检查清单

有哪些部分需要我展开或调整吗？