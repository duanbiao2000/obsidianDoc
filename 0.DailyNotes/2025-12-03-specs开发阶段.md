基于 `specs/[###-feature]/` 目录结构，以下是各阶段文件的实例说明：

## 第0阶段：研究阶段

- `research.md` - 包含技术调研结果、可行性分析、风险评估等内容
- 示例内容可能包括：
  - 技术选型比较
  - 市场竞品分析
  - 技术难点预估

## 第1阶段：设计阶段

- `data-model.md` - 数据模型设计文档
  - 实体关系图(ERD)
  - 数据库表结构定义
  - API数据结构定义

- `quickstart.md` - 快速开始指南
  - 环境配置说明
  - 基础使用示例
  - 开发环境搭建步骤

- `contracts/` 目录 - 接口契约文件
  - API接口定义文件
  - 数据传输对象(DTO)规范
  - 服务间通信协议

## 第2阶段：实施阶段

- `tasks.md` - 详细任务分解
  - 具体开发任务列表
  - 责任人分配
  - 时间节点规划
  - 优先级排序

## 核心文件

- `plan.md` - 整体实施计划
  - 项目时间线
  - 资源需求
  - 风险管控措施
---

## 实例

好的，遵照您的要求，我将基于您提供的 `specs/[###-feature]/` 目录结构，为一个商业级功能——**“用户头像管理”**——生成一套完整的开发实例。

---

### **`specs/015-user-avatar-management/`**

### **核心文件**

#### `plan.md` - 整体实施计划

- **项目概述**:
  - 本项目旨在为用户提供上传、裁剪和管理个人头像的功能。系统将自动生成多种尺寸的头像，以优化不同场景下的加载性能。
- **项目时间线**:
  - **Week 1**: 技术研究与设计阶段完成 (产出 `research.md`, `data-model.md`, `contracts/`)。
  - **Week 2-3**: 后端 API 开发与测试。
  - **Week 3-4**: 前端组件开发与集成。
  - **Week 5**: E2E 测试、安全审计与部署准备。
  - **发布日期**: 预计在 Week 5 结束时发布。
- **资源需求**:
  - **后端**: 1名工程师 (Alex)
  - **前端**: 1名工程师 (Brenda)
  - **QA**: 0.5名工程师 (Chris)
  - **基础设施**: 需要配置对象存储服务 (AWS S3) 和 CDN。
- **风险管控措施**:
  - **风险1 (高)**: 用户上传恶意文件（如脚本）导致安全漏洞。
    - **缓解措施**: 后端必须进行严格的文件类型和 MIME 类型校验；对上传文件进行病毒扫描；使用独立的域名提供图片服务。
  - **风险2 (中)**: 图片处理服务（裁剪、缩放）CPU 负载过高，影响主服务性能。
    - **缓解措施**: 将图片处理逻辑放在一个独立的、异步的 worker 队列中执行。
  - **风险3 (低)**: 对象存储成本超出预期。
    - **缓解措施**: 设置合理的图片大小和分辨率上限；实施生命周期策略，清理未被引用的旧头像文件。

---

### **第0阶段：研究阶段**

#### `research.md`

- **1. 技术选型比较**
  - **对象存储服务**:
    - **AWS S3 (选用)**: 行业标准，生态成熟，与我们的现有 AWS 基础设施无缝集成。
    - **Google Cloud Storage**: 功能对等，但会引入跨云管理复杂性。
    - **自建 MinIO**: 运维成本高，不适合当前团队规模。
  - **后端图片处理库 (Node.js)**:
    - **Sharp (选用)**: 基于 `libvips`，性能极高，内存占用低，API 现代。
    - **ImageMagick**: 功能强大但较重，性能不如 Sharp。
  - **前端图片裁剪库**:
    - **React-Image-Crop (选用)**: 功能完善，社区活跃，满足所有UI需求。
    - **Cropper.js**: 原生 JS 库，但集成到 React 中需要额外封装。

- **2. 市场竞品分析**
  - **GitHub**: 提供简单的方形裁剪框，UI 简洁。
  - **Discord**: 允许上传 GIF 动图作为头像，支持圆形预览。
  - **结论**: 我们的 MVP (最小可行产品) 将实现方形裁剪，支持 JPG/PNG，文件上限为 5MB，与行业标准保持一致。

- **3. 技术难点预估**
  - **前端性能**: 在浏览器中实现大尺寸图片（>2MB）的流畅裁剪预览可能存在性能瓶颈。
  - **事务一致性**: 如何确保图片上传到 S3 和数据库记录更新这两个操作的原子性？需要设计补偿机制或采用两阶段提交模式。
  - **CDN 缓存刷新**: 用户更新头像后，需要有机制能快速刷新 CDN 缓存，确保用户能立即看到新头像。

---

### **第1阶段：设计阶段**

#### `data-model.md`

- **1. 实体关系图 (ERD)**
  - `Users` 表与 `Avatars` 表建立一对多关系 (一个用户可以有多个历史头像，但只有一个是当前激活的)。
  - `Users (1) --- (*) Avatars`

- **2. 数据库表结构定义 (PostgreSQL)**
  ```sql
  -- 在 users 表中增加当前头像的外键引用
  ALTER TABLE users ADD COLUMN current_avatar_id UUID REFERENCES avatars(id);

  -- 新建 avatars 表
  CREATE TABLE avatars (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      user_id UUID NOT NULL REFERENCES users(id),
      original_url TEXT NOT NULL,
      variants JSONB NOT NULL, -- 存储不同尺寸的URL, e.g., {"64x64": "...", "256x256": "..."}
      file_size_bytes INT NOT NULL,
      mime_type VARCHAR(50) NOT NULL,
      is_active BOOLEAN DEFAULT true,
      created_at TIMESTAMPTZ NOT NULL DEFAULT now()
  );
  CREATE INDEX idx_avatars_user_id ON avatars(user_id);
  ```

- **3. API 数据结构定义**
  - 更新后的 `User` 对象将包含 `avatarUrls` 字段：
  ```json
  {
    "id": "user-uuid-123",
    "name": "Alice",
    "avatarUrls": {
      "original": "https://cdn.example.com/avatars/...",
      "size64": "https://cdn.example.com/avatars/..._64x64.png",
      "size256": "https://cdn.example.com/avatars/..._256x256.png"
    }
  }
  ```

#### `quickstart.md`

- **1. 环境配置说明**
  - 需要在 `.env` 文件中配置以下变量：
    ```
    AWS_S3_BUCKET_NAME=projecthub-avatars-dev
    AWS_ACCESS_KEY_ID=...
    AWS_SECRET_ACCESS_KEY=...
    ```
  - 本地开发推荐使用 [MinIO](https://min.io/) 来模拟 S3 服务。

- **2. 开发环境搭建步骤**
  1. `npm install`
  2. 启动本地 MinIO 容器: `docker-compose up minio`
  3. 运行数据库迁移: `npm run db:migrate`
  4. 启动开发服务器: `npm run dev`

#### `contracts/` 目录

- **`api.yaml` (OpenAPI 3.0 片段)**
  ```yaml
  paths:
    /users/me/avatar:
      post:
        summary: Upload a new user avatar
        security:
          - bearerAuth: []
        requestBody:
          required: true
          content:
            multipart/form-data:
              schema:
                type: object
                properties:
                  file:
                    type: string
                    format: binary
                  cropData: # JSON string e.g., '{"x":10,"y":10,"width":100,"height":100}'
                    type: string
        responses:
          '200':
            description: Avatar updated successfully
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/User'
          '400':
            description: Invalid file type or crop data
          '413':
            description: File size exceeds the 5MB limit
  ```

---

### **第2阶段：实施阶段**

#### `tasks.md`

- **P0 - 必须完成, P1 - 应该完成, P2 - 可以完成**

- **后端 (负责人: Alex)**
  - [P0] 创建数据库迁移脚本 (`avatars` 表) - **Est: 2h**
  - [P0] 实现文件上传端点 `POST /users/me/avatar` - **Est: 8h**
    - [ ] 增加文件大小/类型验证中间件
    - [ ] 集成 Sharp 库进行图片裁剪和缩放 (64x64, 256x256)
  - [P0] 实现 S3 上传逻辑 - **Est: 6h**
  - [P1] 设计事务管理，确保 DB 和 S3 的一致性 - **Est: 4h**
  - [P0] 编写单元测试和集成测试 - **Est: 8h**

- **前端 (负责人: Brenda)**
  - [P0] 创建 `AvatarUploadModal` React 组件 - **Est: 8h**
  - [P0] 集成 `react-image-crop` 库，实现裁剪 UI - **Est: 12h**
  - [P0] 实现调用后端 API 的服务 - **Est: 4h**
  - [P1] 实现上传进度条和乐观更新 UI - **Est: 6h**
  - [P2] 增加键盘辅助功能，支持键盘操作裁剪框 - **Est: 4h**

- **QA (负责人: Chris)**
  - [P0] 编写测试用例 (覆盖不同图片格式、尺寸、异常情况) - **Est: 4h**
  - [P1] 进行安全测试 (上传非图片文件、构造恶意请求) - **Est: 8h**