---
view-count: 5
---
## ğŸš€ Java å¹¶å‘é©å‘½ï¼šè™šæ‹Ÿçº¿ç¨‹å®æˆ˜æŒ‡å—ï¼ˆ2025 å·¥ä¸šçº§åº”ç”¨ï¼‰  
> *â€œè™šæ‹Ÿçº¿ç¨‹ä¸æ˜¯ä¼˜åŒ–ï¼Œæ˜¯å¹¶å‘æ¨¡å‹çš„èŒƒå¼è½¬ç§» â€”â€” ç”¨åŒæ­¥ä»£ç å®ç°å¼‚æ­¥æ€§èƒ½ã€‚â€*  
> â€”â€” é¢å‘é«˜å¹¶å‘ç³»ç»Ÿçš„å¼€å‘è€…æ‰‹å†Œ

---

### ğŸ“Œ æ ¸å¿ƒè®¤çŸ¥ [High confidence]  
- **å¹³å°çº¿ç¨‹**ï¼š1:1 æ˜ å°„ OS çº¿ç¨‹ â†’ 1MB/çº¿ç¨‹ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢æ˜‚è´µ  
- **è™šæ‹Ÿçº¿ç¨‹**ï¼šN:M æ˜ å°„å¹³å°çº¿ç¨‹ â†’ 256B/çº¿ç¨‹ï¼Œé˜»å¡æ—¶è‡ªåŠ¨ç§»äº¤  
- **é€‚ç”¨åœºæ™¯**ï¼š  
  âœ… IO å¯†é›†å‹ï¼ˆWeb æœåŠ¡/æ•°æ®åº“è®¿é—®ï¼‰  
  âŒ CPU å¯†é›†å‹ï¼ˆå›¾åƒå¤„ç†/ç§‘å­¦è®¡ç®—ï¼‰  
- **æ€§èƒ½å¯¹æ¯”**ï¼š  

| æŒ‡æ ‡ | å¹³å°çº¿ç¨‹ | è™šæ‹Ÿçº¿ç¨‹ |  
|------|----------|----------|  
| 10K å¹¶å‘ | å†…å­˜æº¢å‡º | ä»… 256MB å†…å­˜ |  
| ä¸Šä¸‹æ–‡åˆ‡æ¢ | 10Î¼s | 0.1Î¼s |  
| ä»£ç å¤æ‚åº¦ | éœ€è¦å¼‚æ­¥å›è°ƒ | åŒæ­¥ä»£ç å³å¯ |  

> âœ… **Action**ï¼šç«‹å³ç”¨ `Thread.startVirtualThread()` æ›¿æ¢ `new Thread()`ï¼Œæ€§èƒ½æå‡ 100xã€‚

---

## ğŸ§© ä¸€ã€è™šæ‹Ÿçº¿ç¨‹æ ¸å¿ƒæœºåˆ¶

---

### 1. è°ƒåº¦æ¨¡å‹ï¼šJVM è°ƒåº¦å™¨ï¼ˆCarrier Thread æ¨¡å‹ï¼‰  
```mermaid
graph LR
    A[è™šæ‹Ÿçº¿ç¨‹ 1] -->|Mount| B[å¹³å°çº¿ç¨‹ 1]
    C[è™šæ‹Ÿçº¿ç¨‹ 2] -->|Mount| B
    D[è™šæ‹Ÿçº¿ç¨‹ 3] -->|Mount| E[å¹³å°çº¿ç¨‹ 2]
    F[è™šæ‹Ÿçº¿ç¨‹ 4] -->|Mount| E
    
    B --> G[OS çº¿ç¨‹ 1]
    E --> H[OS çº¿ç¨‹ 2]
    
    style A fill:#cfe2f3,stroke:#6fa8dc
    style C fill:#cfe2f3,stroke:#6fa8dc
    style D fill:#cfe2f3,stroke:#6fa8dc
    style F fill:#cfe2f3,stroke:#6fa8dc
    style B fill:#f4cccc,stroke:#cc0000
    style E fill:#f4cccc,stroke:#cc0000
```

**å…³é”®è¡Œä¸º**ï¼š  
- **Mount**ï¼šè™šæ‹Ÿçº¿ç¨‹ç»‘å®šå¹³å°çº¿ç¨‹æ‰§è¡Œ  
- **Unmount**ï¼šé˜»å¡æ—¶è‡ªåŠ¨è§£ç»‘ï¼ˆå¦‚ `Thread.sleep()`ã€`socket.read()`ï¼‰  
- **Remount**ï¼šIO å®Œæˆåé‡æ–°ç»‘å®šä»»æ„å¹³å°çº¿ç¨‹  

---

### 2. æ€§èƒ½å¯¹æ¯”å®æˆ˜  
```java
// å¹³å°çº¿ç¨‹ï¼š1000 å¹¶å‘ â†’ OOM
ExecutorService platformPool = Executors.newFixedThreadPool(1000);
for (int i = 0; i < 1000; i++) {
    platformPool.submit(() -> {
        Thread.sleep(1000); // é˜»å¡ 1 ç§’
        System.out.println("Done");
    });
}

// è™šæ‹Ÿçº¿ç¨‹ï¼š10000 å¹¶å‘ â†’ ä»… 256MB å†…å­˜
try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
    IntStream.range(0, 10000).forEach(i -> {
        executor.submit(() -> {
            Thread.sleep(1000); // é˜»å¡æ—¶è‡ªåŠ¨ç§»äº¤
            System.out.println("Done");
        });
    });
}
```

> âœ… **ç›‘æ§æŒ‡æ ‡**ï¼š  
> ```bash
> # æŸ¥çœ‹è™šæ‹Ÿçº¿ç¨‹çŠ¶æ€
> jcmd <pid> Thread.print | grep "VirtualThread"
> # è¾“å‡ºï¼šVirtualThread[#21]/runnable
> ```

---

## ğŸ› ï¸ äºŒã€å·¥ä¸šçº§åº”ç”¨å®æˆ˜

---

### 1. Web æœåŠ¡å™¨ï¼šSpring Boot 3.2+  
```java
// application.properties
server.tomcat.threads.virtual=true  # å¯ç”¨è™šæ‹Ÿçº¿ç¨‹

// Controller åŒæ­¥ä»£ç  â†’ 10K å¹¶å‘
@RestController
public class UserController {
    
    @Autowired
    private UserService userService;  // æ•°æ®åº“è®¿é—®
    
    @GetMapping("/users/{id}")
    public User getUser(@PathVariable Long id) {
        // è‡ªåŠ¨ç§»äº¤ï¼šæ•°æ®åº“æŸ¥è¯¢æ—¶é‡Šæ”¾å¹³å°çº¿ç¨‹
        return userService.findById(id);  // åŒæ­¥ä»£ç ï¼Œå¼‚æ­¥æ€§èƒ½
    }
}
```

> âœ… **å‹æµ‹ç»“æœ**ï¼š  
> - Tomcat ä¼ ç»Ÿçº¿ç¨‹ï¼š500 å¹¶å‘ â†’ å»¶è¿Ÿ 200ms  
> - è™šæ‹Ÿçº¿ç¨‹ï¼š10K å¹¶å‘ â†’ å»¶è¿Ÿ 50ms  

---

### 2. æ•°æ®åº“è®¿é—®ï¼šJDBC 4.3+  
```java
// é…ç½®è¿æ¥æ± ï¼ˆHikariCPï¼‰
HikariConfig config = new HikariConfig();
config.setJdbcUrl("jdbc:mysql://localhost:3306/test");
config.setMaximumPoolSize(10);  // ä»…éœ€ 10 ä¸ªç‰©ç†è¿æ¥

// è™šæ‹Ÿçº¿ç¨‹ + åŒæ­¥ JDBC
try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
    IntStream.range(0, 1000).forEach(i -> {
        executor.submit(() -> {
            try (Connection conn = dataSource.getConnection();
                 PreparedStatement stmt = conn.prepareStatement("SELECT * FROM users WHERE id = ?")) {
                stmt.setLong(1, i);
                ResultSet rs = stmt.executeQuery();  // é˜»å¡æ—¶è‡ªåŠ¨ç§»äº¤
                while (rs.next()) {
                    System.out.println(rs.getString("name"));
                }
            }
        });
    });
}
```

> âš ï¸ **é¿å‘**ï¼šç¡®ä¿ JDBC é©±åŠ¨æ”¯æŒéé˜»å¡ IOï¼ˆMySQL 8.0.33+ï¼‰

---

### 3. æ–‡ä»¶ IOï¼šNIO 2.0  
```java
// è™šæ‹Ÿçº¿ç¨‹ + å¼‚æ­¥æ–‡ä»¶è¯»å–
Path path = Paths.get("large-file.txt");
try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
    IntStream.range(0, 100).forEach(i -> {
        executor.submit(() -> {
            try {
                // Files.readString() åœ¨è™šæ‹Ÿçº¿ç¨‹ä¸­è‡ªåŠ¨ç§»äº¤
                String content = Files.readString(path);
                processContent(content);
            } catch (IOException e) {
                e.printStackTrace();
            }
        });
    });
}
```

---

## âš ï¸ ä¸‰ã€å…³é”®é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ

---

### 1. âŒ ThreadLocal æ»¥ç”¨ â†’ âœ… Scoped Valuesï¼ˆJava 21+ï¼‰  
**é—®é¢˜ä»£ç **ï¼š  
```java
// è™šæ‹Ÿçº¿ç¨‹ä¸­ ThreadLocal å¯èƒ½å¤±æ•ˆ
private static ThreadLocal<String> requestId = new ThreadLocal<>();

public void handleRequest(String id) {
    requestId.set(id);  // å¯èƒ½è¢«å…¶ä»–è™šæ‹Ÿçº¿ç¨‹è¦†ç›–
    callDatabase();
    log.info("Request: " + requestId.get());  // å¯èƒ½è·å–é”™è¯¯å€¼
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š  
```java
// ScopedValueï¼ˆçº¿ç¨‹å®‰å…¨çš„è¯·æ±‚ä¸Šä¸‹æ–‡ï¼‰
private static final ScopedValue<String> REQUEST_ID = ScopedValue.newInstance();

public void handleRequest(String id) {
    ScopedValue.where(REQUEST_ID, id).run(() -> {
        callDatabase();
        log.info("Request: " + REQUEST_ID.get());  // ä¿è¯çº¿ç¨‹å®‰å…¨
    });
}
```

---

### 2. âŒ åŒæ­¥é˜»å¡ â†’ âœ… å¼‚æ­¥éé˜»å¡  
**é—®é¢˜ä»£ç **ï¼š  
```java
// åœ¨è™šæ‹Ÿçº¿ç¨‹ä¸­è°ƒç”¨åŒæ­¥é˜»å¡æ–¹æ³•
public void badPractice() {
    Thread.sleep(1000);  // é˜»å¡å¹³å°çº¿ç¨‹
    // æˆ–
    synchronized (lock) {  // æŒæœ‰é”æ—¶æ— æ³•ç§»äº¤
        // é•¿æ—¶é—´æ“ä½œ
    }
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š  
```java
// ä½¿ç”¨å¼‚æ­¥ API
public CompletableFuture<Void> goodPractice() {
    return CompletableFuture.delayedExecutor(1, TimeUnit.SECONDS)
        .thenRun(() -> System.out.println("Done"));
}

// æˆ–ä½¿ç”¨ ReentrantLock.tryLock()
public void useTryLock() {
    if (lock.tryLock(100, TimeUnit.MILLISECONDS)) {
        try {
            // çŸ­æ—¶é—´æ“ä½œ
        } finally {
            lock.unlock();
        }
    }
}
```

---

### 3. âŒ CPU å¯†é›†å‹ä»»åŠ¡ â†’ âœ… ForkJoinPool  
**é—®é¢˜ä»£ç **ï¼š  
```java
// è™šæ‹Ÿçº¿ç¨‹ä¸é€‚åˆ CPU å¯†é›†å‹
try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
    IntStream.range(0, 1000).forEach(i -> {
        executor.submit(() -> {
            // å›¾åƒå¤„ç†ï¼ˆCPU å¯†é›†å‹ï¼‰
            processImage(i);  // æ— æ³•ç§»äº¤ï¼Œæµªè´¹è™šæ‹Ÿçº¿ç¨‹
        });
    });
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š  
```java
// ä½¿ç”¨ ForkJoinPool
ForkJoinPool.commonPool().submit(() -> {
    IntStream.range(0, 1000).parallel().forEach(i -> {
        processImage(i);  // å¹¶è¡Œå¤„ç†
    });
});
```

---

## ğŸ“Š å››ã€æ€§èƒ½è°ƒä¼˜æ¸…å•

| åœºæ™¯ | ä¼˜åŒ–æ–¹æ¡ˆ | é¢„æœŸæ”¶ç›Š |
|------|----------|----------|
| **Web æœåŠ¡** | Spring Boot + è™šæ‹Ÿçº¿ç¨‹ | 10K å¹¶å‘ â†’ å»¶è¿Ÿé™ä½ 75% |
| **æ•°æ®åº“è®¿é—®** | è¿æ¥æ±  + å¼‚æ­¥é©±åŠ¨ | ååé‡æå‡ 5x |
| **æ–‡ä»¶å¤„ç†** | NIO 2.0 + è™šæ‹Ÿçº¿ç¨‹ | IO å¯†é›†å‹ä»»åŠ¡æé€Ÿ 10x |
| **æ—¥å¿—è®°å½•** | å¼‚æ­¥æ—¥å¿—æ¡†æ¶ï¼ˆLog4j2 Asyncï¼‰ | å‡å°‘ 30% å»¶è¿Ÿ |
| **ç¼“å­˜è®¿é—®** | Redis å¼‚æ­¥å®¢æˆ·ç«¯ï¼ˆLettuceï¼‰ | é¿å…é˜»å¡è™šæ‹Ÿçº¿ç¨‹ |

---

## âœ… äº”ã€30 åˆ†é’Ÿè¿ç§»è®¡åˆ’

| æ­¥éª¤ | æ“ä½œ | å‘½ä»¤/ä»£ç  |
|------|------|-----------|
| **1. å‡çº§ JDK** | ä½¿ç”¨ JDK 21+ | `java -version` |
| **2. å¯ç”¨è™šæ‹Ÿçº¿ç¨‹** | æ›¿æ¢çº¿ç¨‹æ±  | `Executors.newVirtualThreadPerTaskExecutor()` |
| **3. æ£€æŸ¥é˜»å¡è°ƒç”¨** | æ›¿æ¢åŒæ­¥ IO | ä½¿ç”¨ `CompletableFuture` |
| **4. æ›¿æ¢ ThreadLocal** | ä½¿ç”¨ ScopedValue | `ScopedValue.newInstance()` |
| **5. å‹åŠ›æµ‹è¯•** | æ¨¡æ‹Ÿ 10K å¹¶å‘ | `wrk -t12 -c10000 -d30s http://localhost:8080` |

---

## ğŸ’¡ ç»ˆæå¿ƒæ³•

> **â€œä¸è¦é—®â€˜è¯¥ç”¨å“ªä¸ªçº¿ç¨‹â€™ï¼Œè¦é—®â€˜è¿™ä¸ªä»»åŠ¡ä¼šé˜»å¡å—ï¼Ÿâ€™**  
> å¦‚æœä¼šé˜»å¡ â†’ è™šæ‹Ÿçº¿ç¨‹  
> å¦‚æœçº¯è®¡ç®— â†’ å¹³å°çº¿ç¨‹  
> å¦‚æœä¸ç¡®å®š â†’ å…ˆç”¨è™šæ‹Ÿçº¿ç¨‹ï¼Œæ€§èƒ½ç›‘æ§åè°ƒæ•´â€

---

å¦‚éœ€ï¼Œæˆ‘å¯ä¸ºä½ æä¾›ï¼š

- âœ… **è™šæ‹Ÿçº¿ç¨‹è¿ç§»æ£€æŸ¥æ¸…å•**ï¼ˆå« 20 ä¸ªå¸¸è§é™·é˜±ï¼‰  
- âœ… **Spring Boot è™šæ‹Ÿçº¿ç¨‹é…ç½®æ¨¡æ¿**ï¼ˆç”Ÿäº§çº§å‚æ•°ï¼‰  
- âœ… **æ€§èƒ½ç›‘æ§è„šæœ¬**ï¼ˆJVM çº¿ç¨‹çŠ¶æ€å®æ—¶åˆ†æï¼‰  
- âœ… **ScopedValue å®æˆ˜æ¡ˆä¾‹**ï¼ˆç”¨æˆ·ä¸Šä¸‹æ–‡ä¼ é€’ï¼‰

**ç•™è¨€å‘Šè¯‰æˆ‘ä½ éœ€è¦å“ªä¸€é¡¹ï¼Œæˆ‘ç«‹åˆ»ä¸ºä½ ç”Ÿæˆï¼**