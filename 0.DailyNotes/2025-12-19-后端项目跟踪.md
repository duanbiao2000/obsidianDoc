å¯¹åç«¯é¡¹ç›®è¿›è¡Œ **Traceï¼ˆè¿½è¸ªï¼‰**ï¼Œä¸»è¦æ˜¯ä¸ºäº†å®ç°**åˆ†å¸ƒå¼è¿½è¸ªï¼ˆDistributed Tracingï¼‰**ï¼Œå¸®åŠ©å¼€å‘è€…ç†è§£è¯·æ±‚åœ¨å¤šä¸ªæœåŠ¡ä¹‹é—´çš„æµè½¬è·¯å¾„ã€è¯†åˆ«æ€§èƒ½ç“¶é¢ˆã€æ’æŸ¥é”™è¯¯ã€‚ä»¥ä¸‹æ˜¯ç³»ç»Ÿæ€§çš„æ–¹æ³•å’Œå·¥å…·æŒ‡å—ï¼š

---

## ä¸€ã€æ ¸å¿ƒæ¦‚å¿µ

- **Traceï¼ˆè¿½è¸ªï¼‰**ï¼šä¸€æ¬¡å®Œæ•´ç”¨æˆ·è¯·æ±‚åœ¨ç³»ç»Ÿä¸­çš„æ‰§è¡Œè·¯å¾„ã€‚
- **Spanï¼ˆè·¨åº¦ï¼‰**ï¼šTrace ä¸­çš„å•ä¸ªæ“ä½œå•å…ƒï¼ˆå¦‚ä¸€æ¬¡å‡½æ•°è°ƒç”¨ã€æ•°æ®åº“æŸ¥è¯¢ã€HTTP è¯·æ±‚ï¼‰ã€‚
- **Context Propagationï¼ˆä¸Šä¸‹æ–‡ä¼ æ’­ï¼‰**ï¼šåœ¨æœåŠ¡é—´ä¼ é€’ Trace ID å’Œ Span IDï¼Œç¡®ä¿é“¾è·¯è¿è´¯ã€‚

---

## äºŒã€é€šç”¨æ­¥éª¤

### 1. **é€‰æ‹©è¿½è¸ªæ ‡å‡†ä¸åè®®**

æ¨èé‡‡ç”¨ **OpenTelemetryï¼ˆOTelï¼‰** â€”â€” å½“å‰ä¸šç•Œæ ‡å‡†ï¼ˆCNCF æ¯•ä¸šé¡¹ç›®ï¼‰ï¼Œç»Ÿä¸€äº†æŒ‡æ ‡ã€æ—¥å¿—ã€è¿½è¸ªã€‚

> æ›¿ä»£æ–¹æ¡ˆï¼šOpenTracing + OpenCensusï¼ˆå·²åˆå¹¶ä¸º OpenTelemetryï¼‰

### 2. **é›†æˆ OpenTelemetry SDK åˆ°åç«¯é¡¹ç›®**

ä»¥å¸¸è§è¯­è¨€ä¸ºä¾‹ï¼š

#### âœ… Go

```go
import (
  "go.opentelemetry.io/otel"
  "go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp"
  "go.opentelemetry.io/otel/sdk/trace"
)

// åˆå§‹åŒ– OTLP Exporter å¹¶è®¾ç½®å…¨å±€ TracerProvider
exp, _ := otlptracehttp.New(ctx)
tp := trace.NewTracerProvider(trace.WithBatcher(exp))
otel.SetTracerProvider(tp)
```

#### âœ… Javaï¼ˆSpring Bootï¼‰

æ·»åŠ ä¾èµ–ï¼š

```xml
<dependency>
  <groupId>io.opentelemetry.instrumentation</groupId>
  <artifactId>opentelemetry-spring-boot-starter</artifactId>
  <version>2.0.0</version> <!-- ä½¿ç”¨æœ€æ–°ç‰ˆ -->
</dependency>
```

é€šè¿‡ç¯å¢ƒå˜é‡é…ç½® exporterï¼š

```bash
OTEL_TRACES_EXPORTER=otlp
OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318
```

#### âœ… Pythonï¼ˆFastAPI / Flaskï¼‰

```python
from opentelemetry import trace
from opentelemetry.exporter.otlp.proto.http.trace_exporter import OTLPSpanExporter
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import BatchSpanProcessor

trace.set_tracer_provider(TracerProvider())
otlp_exporter = OTLPSpanExporter(endpoint="http://localhost:4318/v1/traces")
trace.get_tracer_provider().add_span_processor(BatchSpanProcessor(otlp_exporter))
```

> ğŸ’¡ ä¹Ÿå¯ä»¥ä½¿ç”¨ **è‡ªåŠ¨æ’æ¡©ï¼ˆAuto-instrumentationï¼‰**ï¼Œæ— éœ€æ”¹ä»£ç ï¼š
> 
> ```bash
> opentelemetry-instrument --traces_exporter console python app.py
> ```

---

### 3. **éƒ¨ç½²åç«¯æ”¶é›†å™¨ï¼ˆCollectorï¼‰**

OpenTelemetry Collector æ˜¯ä¸€ä¸ªä»£ç†ï¼Œæ¥æ”¶æ¥è‡ªåº”ç”¨çš„ trace æ•°æ®ï¼Œå¹¶è½¬å‘åˆ°åç«¯å­˜å‚¨ï¼ˆå¦‚ Jaegerã€Zipkinã€Prometheusã€Datadog ç­‰ï¼‰ã€‚

**docker-compose.yml ç¤ºä¾‹ï¼š**

```yaml
services:
  otel-collector:
    image: otel/opentelemetry-collector:latest
    command: ["--config=/conf/otel-config.yaml"]
    volumes:
      - ./otel-config.yaml:/conf/otel-config.yaml
    ports:
      - "4317:4317"   # gRPC
      - "4318:4318"   # HTTP
```

**otel-config.yaml ç¤ºä¾‹ï¼š**

```yaml
receivers:
  otlp:
    protocols:
      grpc:
      http:

exporters:
  jaeger:
    endpoint: "jaeger:14250"
    tls:
      insecure: true

processors:
  batch:

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [batch]
      exporters: [jaeger]
```

---

### 4. **éƒ¨ç½²å¯è§†åŒ–åç«¯ï¼ˆå¦‚ Jaeger / Zipkinï¼‰**

#### ä½¿ç”¨ Jaegerï¼ˆæ¨èï¼‰ï¼š

```yaml
# docker-compose ä¸­æ·»åŠ 
jaeger:
  image: jaegertracing/all-in-one:latest
  ports:
    - "16686:16686"  # UI
    - "14250:14250"  # gRPC for OTEL
```

è®¿é—® `http://localhost:16686` æŸ¥çœ‹å®Œæ•´è°ƒç”¨é“¾ã€‚

---

### 5. **ç¡®ä¿ä¸Šä¸‹æ–‡ä¼ æ’­ï¼ˆå…³é”®ï¼ï¼‰**

- HTTP æœåŠ¡ï¼šè‡ªåŠ¨é€šè¿‡ headersï¼ˆå¦‚ `traceparent`ï¼‰ä¼ æ’­ã€‚
- æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆKafka/RabbitMQï¼‰ï¼šéœ€æ‰‹åŠ¨æ³¨å…¥/æå– contextã€‚
- gRPCï¼šOpenTelemetry æä¾›æ‹¦æˆªå™¨è‡ªåŠ¨å¤„ç†ã€‚

ç¤ºä¾‹ï¼ˆGo HTTP å®¢æˆ·ç«¯ï¼‰ï¼š

```go
req = req.WithContext(ctx) // ctx åŒ…å«å½“å‰ span
client.Do(req) // è‡ªåŠ¨æºå¸¦ traceparent header
```

---

## ä¸‰ã€é«˜çº§æŠ€å·§

|åœºæ™¯|å»ºè®®|
|---|---|
|**æ•°æ®åº“æ…¢æŸ¥è¯¢**|ä½¿ç”¨ OTel DB æ’ä»¶ï¼ˆå¦‚ `go-sql-driver/mysql` + OTel instrumentationï¼‰|
|**å¼‚æ­¥ä»»åŠ¡**|åœ¨ goroutine / thread å¯åŠ¨æ—¶ä¼ é€’ context|
|**é‡‡æ ·ç­–ç•¥**|åœ¨ Collector æˆ– SDK ä¸­é…ç½® `AlwaysOn`, `ParentBased`, `TraceIDRatio`|
|**æ—¥å¿—å…³è”**|åœ¨æ—¥å¿—ä¸­æ³¨å…¥ `trace_id` å’Œ `span_id`ï¼Œä¾¿äºè”åŠ¨æ’æŸ¥|

---

## å››ã€å¸¸ç”¨å·¥å…·æ ˆç»„åˆ

|ç»„ä»¶|æ¨èæ–¹æ¡ˆ|
|---|---|
|æ ‡å‡†|OpenTelemetry|
|æ”¶é›†å™¨|OpenTelemetry Collector|
|å­˜å‚¨ & å¯è§†åŒ–|Jaegerï¼ˆè½»é‡ï¼‰ã€Tempoï¼ˆGrafana ç”Ÿæ€ï¼‰ã€Datadog / New Relicï¼ˆå•†ä¸šï¼‰|
|è‡ªåŠ¨æ’æ¡©|OTel Auto-instrumentation Agentï¼ˆJava/Python/Node.jsï¼‰|

---

## äº”ã€éªŒè¯æ˜¯å¦ç”Ÿæ•ˆ

1. å‘èµ·ä¸€ä¸ª HTTP è¯·æ±‚åˆ°ä½ çš„åç«¯ã€‚
2. æ‰“å¼€ Jaeger UI (`http://localhost:16686`)ã€‚
3. æœç´¢æœåŠ¡åï¼Œåº”èƒ½çœ‹åˆ°å®Œæ•´çš„ Trace é“¾è·¯ï¼ŒåŒ…å«ï¼š
    - å¤šä¸ª Spanï¼ˆå¦‚ `/api/login` â†’ DB query â†’ auth service callï¼‰
    - è€—æ—¶ã€é”™è¯¯æ ‡è®°ã€æ ‡ç­¾ï¼ˆtagsï¼‰

---

âœ… **æ€»ç»“**ï¼š  
å¯¹åç«¯é¡¹ç›®åš Traceï¼Œå…³é”®æ˜¯ **â€œåŸ‹ç‚¹ + ä¼ æ’­ + æ”¶é›† + å¯è§†åŒ–â€**ã€‚ä½¿ç”¨ **OpenTelemetry + Collector + Jaeger** æ˜¯å½“å‰æœ€ä¸»æµã€å¯ç§»æ¤æ€§æœ€å¼ºçš„æ–¹æ¡ˆï¼Œæ”¯æŒå¤šè¯­è¨€ã€äº‘åŸç”Ÿã€æ··åˆæ¶æ„ã€‚

å¦‚éœ€å…·ä½“è¯­è¨€æˆ–æ¡†æ¶çš„å®Œæ•´ç¤ºä¾‹ï¼ˆå¦‚ Spring Boot + MySQL + Kafkaï¼‰ï¼Œå¯è¿›ä¸€æ­¥è¯´æ˜ä½ çš„æŠ€æœ¯æ ˆï¼Œæˆ‘å¯ä»¥æä¾›é’ˆå¯¹æ€§ä»£ç æ¨¡æ¿ã€‚