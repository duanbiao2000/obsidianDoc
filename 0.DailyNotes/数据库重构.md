åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿›è¡Œæ•°æ®åº“é‡æ„éœ€è¦è°¨æ…è§„åˆ’ï¼Œä»¥ç¡®ä¿æ•°æ®å®‰å…¨ã€ä¸šåŠ¡è¿ç»­æ€§å’Œæœ€å°åŒ–åœæœºæ—¶é—´ã€‚ç»“åˆã€Šé‡æ„ï¼šæ”¹å–„æ—¢æœ‰ä»£ç çš„è®¾è®¡ã€‹ä¸­æåˆ°çš„æ•°æ®åº“é‡æ„æ€æƒ³ï¼ˆå¦‚æ¸è¿›å¼ä¿®æ”¹ã€å°æ­¥è°ƒæ•´ã€ä¾èµ–æµ‹è¯•ç­‰ï¼‰ï¼Œä»¥ä¸‹æ˜¯å…·ä½“å®æ–½æ–¹æ³•å’Œæ³¨æ„äº‹é¡¹ï¼š


### **ä¸€ã€æ•°æ®åº“é‡æ„çš„æ ¸å¿ƒåŸåˆ™**
1. **å°æ­¥ä¿®æ”¹ï¼Œé¢‘ç¹éªŒè¯**  
   æ•°æ®åº“é‡æ„åº”åˆ†è§£ä¸ºä¸€ç³»åˆ—å¾®å°çš„ã€å¯é€†çš„æ­¥éª¤ï¼Œæ¯ä¸ªæ­¥éª¤åéƒ½éœ€éªŒè¯æ•°æ®ä¸€è‡´æ€§å’Œç³»ç»Ÿå¯ç”¨æ€§ã€‚é¿å…ä¸€æ¬¡æ€§è¿›è¡Œå¤§è§„æ¨¡ schema å˜æ›´ï¼ˆå¦‚æ‰¹é‡ä¿®æ”¹å¤šä¸ªè¡¨ç»“æ„ï¼‰ã€‚  
   - ç¤ºä¾‹ï¼šå°†â€œæ‹†åˆ†å¤§è¡¨â€æ‹†åˆ†ä¸ºâ€œåˆ›å»ºæ–°è¡¨â†’åŒæ­¥æ•°æ®â†’åˆ‡æ¢è¯»å†™â†’åˆ é™¤æ—§è¡¨â€å››ä¸ªæ­¥éª¤ï¼Œæ¯æ­¥å®ŒæˆåéªŒè¯æ•°æ®å‡†ç¡®æ€§ã€‚

2. **ä¿æŒå‘åå…¼å®¹**  
   ç¡®ä¿é‡æ„è¿‡ç¨‹ä¸­ï¼Œæ–°æ—§ schema èƒ½åŒæ—¶å·¥ä½œï¼Œé¿å…å› ç»“æ„å˜æ›´å¯¼è‡´åº”ç”¨ç¨‹åºä¸­æ–­ã€‚å¯é€šè¿‡â€œå¹¶è¡Œä¿®æ”¹â€ç­–ç•¥å®ç°ï¼š  
   - å…ˆæ·»åŠ æ–°å­—æ®µ/è¡¨ï¼Œç¡®ä¿åº”ç”¨èƒ½åŒæ—¶è¯»å†™æ–°æ—§ç»“æ„ï¼›  
   - é€æ­¥è¿ç§»æ•°æ®å’Œæµé‡åˆ°æ–°ç»“æ„ï¼›  
   - ç¡®è®¤æ— è¯¯åç§»é™¤æ—§ç»“æ„ã€‚

3. **ä¾èµ–è‡ªåŠ¨åŒ–æµ‹è¯•**  
   ä¸ºæ•°æ®åº“æ“ä½œç¼–å†™è‡ªåŠ¨åŒ–æµ‹è¯•ï¼ˆå¦‚æ•°æ®å®Œæ•´æ€§æ ¡éªŒã€æŸ¥è¯¢å…¼å®¹æ€§æµ‹è¯•ï¼‰ï¼Œç¡®ä¿é‡æ„åæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚è½¬è´¦ã€è®¢å•ç”Ÿæˆï¼‰ä»èƒ½æ­£å¸¸è¿è¡Œã€‚  
   - å…³é”®æµ‹è¯•ç‚¹ï¼šä¸»é”®çº¦æŸã€å¤–é”®å…³è”ã€ç´¢å¼•æœ‰æ•ˆæ€§ã€å­˜å‚¨è¿‡ç¨‹/è§¦å‘å™¨é€»è¾‘ã€‚

4. **å……åˆ†å¤‡ä»½ä¸å›æ»šæ–¹æ¡ˆ**  
   é‡æ„å‰å¿…é¡»å¤‡ä»½å…¨é‡æ•°æ®ï¼Œå¹¶æµ‹è¯•å›æ»šæµç¨‹ã€‚å¯¹äºæ ¸å¿ƒä¸šåŠ¡åº“ï¼Œå»ºè®®é‡‡ç”¨â€œæ—¶é—´ç‚¹æ¢å¤â€ï¼ˆPITRï¼‰æœºåˆ¶ï¼Œç¡®ä¿åœ¨å‡ºç°é—®é¢˜æ—¶èƒ½å¿«é€Ÿæ¢å¤åˆ°é‡æ„å‰çŠ¶æ€ã€‚


### **äºŒã€ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“é‡æ„çš„æ­¥éª¤**

#### **1. å‡†å¤‡é˜¶æ®µ**
- **åˆ†æé‡æ„ç›®æ ‡ä¸å½±å“èŒƒå›´**  
  æ˜ç¡®é‡æ„ç›®çš„ï¼ˆå¦‚ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ã€æ‹†åˆ†å†—ä½™å­—æ®µã€è§„èŒƒåŒ–è®¾è®¡ï¼‰ï¼Œè¯„ä¼°å—å½±å“çš„åº”ç”¨æ¨¡å—ã€SQL è¯­å¥ã€ETL æµç¨‹ç­‰ã€‚  
  - å·¥å…·æ¨èï¼šä½¿ç”¨æ•°æ®åº“å®¡è®¡å·¥å…·ï¼ˆå¦‚ MySQL çš„ `pt-query-digest`ï¼‰åˆ†æé«˜é¢‘æŸ¥è¯¢ï¼Œè¯†åˆ«é‡æ„å¯èƒ½å½±å“çš„ SQLã€‚

- **è®¾è®¡å…¼å®¹æ–¹æ¡ˆ**  
  å¯¹äºéœ€è¦ä¿®æ”¹çš„è¡¨ç»“æ„ï¼ˆå¦‚å­—æ®µæ”¹åã€ç±»å‹å˜æ›´ï¼‰ï¼Œå…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯å…¼å®¹æ€§ï¼š  
  - å­—æ®µæ”¹åï¼šä¿ç•™æ—§å­—æ®µä½œä¸ºè¿‡æ¸¡ï¼Œé€šè¿‡è§¦å‘å™¨åŒæ­¥æ–°æ—§å­—æ®µæ•°æ®ï¼›  
  - è¡¨æ‹†åˆ†ï¼šåˆ›å»ºæ–°è¡¨åï¼Œé€šè¿‡è§†å›¾å…³è”æ–°æ—§è¡¨ï¼Œç¡®ä¿æŸ¥è¯¢å…¼å®¹æ€§ã€‚

- **åˆ¶å®šæ‰§è¡Œè®¡åˆ’ä¸æ—¶é—´çª—å£**  
  é€‰æ‹©ä¸šåŠ¡ä½å³°æœŸï¼ˆå¦‚å‡Œæ™¨ï¼‰æ‰§è¡Œé‡æ„ï¼Œé¢„ç•™è¶³å¤Ÿçš„å›æ»šæ—¶é—´ï¼ˆé€šå¸¸æ˜¯æ‰§è¡Œæ—¶é—´çš„ 2-3 å€ï¼‰ã€‚


#### **2. æ‰§è¡Œé˜¶æ®µ**
- **åˆ†æ­¥å®æ–½é‡æ„**  
  ä»¥â€œå­—æ®µæ”¹åâ€ä¸ºä¾‹ï¼Œå…·ä½“æ­¥éª¤ï¼š  
  1. **æ·»åŠ æ–°å­—æ®µ**ï¼šåœ¨è¡¨ä¸­æ–°å¢ç›®æ ‡å­—æ®µï¼ˆå¦‚å°† `user_name` æ”¹ä¸º `username`ï¼Œå…ˆæ·»åŠ  `username` å­—æ®µï¼‰ã€‚  
     ```sql
     ALTER TABLE users ADD COLUMN username VARCHAR(50);
     ```  
  2. **åŒæ­¥æ•°æ®**ï¼šé€šè¿‡è§¦å‘å™¨æˆ–æ‰¹é‡è„šæœ¬å°†æ—§å­—æ®µæ•°æ®åŒæ­¥åˆ°æ–°å­—æ®µã€‚  
     ```sql
     UPDATE users SET username = user_name; -- åˆå§‹åŒæ­¥
     CREATE TRIGGER sync_username BEFORE UPDATE ON users
     FOR EACH ROW SET NEW.username = NEW.user_name; -- å®æ—¶åŒæ­¥
     ```  
  3. **åˆ‡æ¢åº”ç”¨è¯»å†™**ï¼šä¿®æ”¹åº”ç”¨ä»£ç ï¼Œé€æ­¥åˆ‡æ¢åˆ°ä½¿ç”¨æ–°å­—æ®µï¼ˆ`username`ï¼‰ï¼Œä¿ç•™å¯¹æ—§å­—æ®µçš„è¯»å–å…¼å®¹ã€‚  
  4. **ç§»é™¤æ—§å­—æ®µä¸è§¦å‘å™¨**ï¼šç¡®è®¤æ–°å­—æ®µå®Œå…¨æ›¿ä»£æ—§å­—æ®µåï¼Œåˆ é™¤ `user_name` å’Œè§¦å‘å™¨ã€‚  

- **å®æ—¶ç›‘æ§ä¸éªŒè¯**  
  é‡æ„è¿‡ç¨‹ä¸­ç›‘æ§æ•°æ®åº“æ€§èƒ½ï¼ˆCPUã€é”ç­‰å¾…ã€äº‹åŠ¡é‡ï¼‰å’Œåº”ç”¨æ—¥å¿—ï¼Œé€šè¿‡ä»¥ä¸‹æ–¹å¼éªŒè¯ï¼š  
  - å¯¹æ¯”é‡æ„å‰åçš„æ ¸å¿ƒæŒ‡æ ‡ï¼ˆå¦‚æŸ¥è¯¢å“åº”æ—¶é—´ã€äº‹åŠ¡æˆåŠŸç‡ï¼‰ï¼›  
  - æ‰§è¡Œå†’çƒŸæµ‹è¯•ï¼ˆå¦‚ç”¨æˆ·ç™»å½•ã€è®¢å•æäº¤ï¼‰ï¼Œç¡®ä¿å…³é”®æµç¨‹æ— å¼‚å¸¸ã€‚


#### **3. æ”¶å°¾é˜¶æ®µ**
- **æ¸…ç†å†—ä½™ç»“æ„**  
  åˆ é™¤ä¸å†ä½¿ç”¨çš„å­—æ®µã€è¡¨ã€ç´¢å¼•æˆ–è§†å›¾ï¼Œé¿å…å†—ä½™æ•°æ®å ç”¨ç©ºé—´æˆ–å¯¼è‡´åç»­æ··æ·†ã€‚  

- **æ–‡æ¡£æ›´æ–°**  
  åŒæ­¥æ›´æ–°æ•°æ®åº“è®¾è®¡æ–‡æ¡£ã€ER å›¾å’Œåº”ç”¨ä»£ç æ³¨é‡Šï¼Œç¡®ä¿å›¢é˜Ÿæˆå‘˜äº†è§£é‡æ„åçš„ç»“æ„ã€‚  

- **å¤ç›˜ä¸ä¼˜åŒ–**  
  è®°å½•é‡æ„è¿‡ç¨‹ä¸­çš„é—®é¢˜ï¼ˆå¦‚é”è¶…æ—¶ã€æ•°æ®ä¸ä¸€è‡´ï¼‰ï¼Œä¼˜åŒ–ä¸‹æ¬¡é‡æ„çš„æµç¨‹ï¼ˆå¦‚è°ƒæ•´æ‰¹é‡æ›´æ–°çš„æ‰¹æ¬¡å¤§å°ï¼‰ã€‚


### **ä¸‰ã€å¸¸è§åœºæ™¯ä¸è§£å†³æ–¹æ¡ˆ**
| **é‡æ„åœºæ™¯**               | **ç”Ÿäº§ç¯å¢ƒå®æ–½ç­–ç•¥**                                                                 |
|----------------------------|----------------------------------------------------------------------------------|
| å­—æ®µç±»å‹å˜æ›´ï¼ˆå¦‚ `INT` è½¬ `BIGINT`ï¼‰ | 1. æ–°å¢ `BIGINT` ç±»å‹çš„ä¸´æ—¶å­—æ®µï¼›2. åŒæ­¥æ•°æ®å¹¶éªŒè¯ï¼›3. åˆ‡æ¢åº”ç”¨åˆ°ä¸´æ—¶å­—æ®µï¼›4. æ›¿æ¢åŸå­—æ®µå¹¶åˆ é™¤ä¸´æ—¶å­—æ®µã€‚ |
| è¡¨æ‹†åˆ†ï¼ˆå¤§è¡¨æ‹†åˆ†ä¸ºå¤šè¡¨ï¼‰   | 1. æŒ‰ä¸šåŠ¡è§„åˆ™åˆ›å»ºæ‹†åˆ†åçš„æ–°è¡¨ï¼›2. é€šè¿‡ ETL å·¥å…·å¢é‡åŒæ­¥æ•°æ®ï¼›3. å…ˆå°†è¯»è¯·æ±‚è·¯ç”±åˆ°æ–°è¡¨ï¼Œå†åˆ‡æ¢å†™è¯·æ±‚ï¼›4. å½’æ¡£æ—§è¡¨æ•°æ®ã€‚ |
| ç´¢å¼•ä¼˜åŒ–ï¼ˆæ–°å¢/åˆ é™¤ç´¢å¼•ï¼‰   | 1. éé«˜å³°æ—¶æ®µåˆ›å»º/åˆ é™¤ç´¢å¼•ï¼ˆé¿å…é•¿æ—¶é—´é”è¡¨ï¼‰ï¼›2. å¯¹å¤§è¡¨ä½¿ç”¨ `ONLINE` æ–¹å¼ï¼ˆå¦‚ MySQL 8.0 çš„ `ALTER TABLE ... ALGORITHM=INPLACE`ï¼‰ã€‚ |
| å¤–é”®çº¦æŸè°ƒæ•´               | 1. å…ˆåˆ é™¤æ—§å¤–é”®ï¼›2. è°ƒæ•´å…³è”å­—æ®µæˆ–è¡¨ç»“æ„ï¼›3. é‡æ–°åˆ›å»ºå¤–é”®ï¼›4. éªŒè¯å…³è”æŸ¥è¯¢å’Œåˆ é™¤/æ›´æ–°æ“ä½œçš„çº¦æŸæ•ˆæœã€‚ |


### **å››ã€é£é™©è§„é¿ä¸æ³¨æ„äº‹é¡¹**
1. **é¿å…é•¿äº‹åŠ¡é˜»å¡**  
   é‡æ„æ“ä½œï¼ˆå¦‚ `ALTER TABLE`ï¼‰å¯èƒ½æŒæœ‰è¡¨çº§é”ï¼Œå¯¼è‡´ä¸šåŠ¡å†™å…¥é˜»å¡ã€‚è§£å†³æ–¹æ¡ˆï¼š  
   - å¯¹å¤§è¡¨ä½¿ç”¨åœ¨çº¿ DDL å·¥å…·ï¼ˆå¦‚ Percona çš„ `pt-online-schema-change`ï¼‰ï¼›  
   - å°†æ‰¹é‡æ›´æ–°æ‹†åˆ†ä¸ºå°æ‰¹æ¬¡ï¼ˆå¦‚æ¯æ¬¡æ›´æ–° 1000 è¡Œï¼‰ï¼Œå‡å°‘é”æŒæœ‰æ—¶é—´ã€‚

2. **å¤„ç†åˆ†å¸ƒå¼ç¯å¢ƒä¸€è‡´æ€§**  
   è‹¥æ•°æ®åº“æ˜¯åˆ†å¸ƒå¼é›†ç¾¤ï¼ˆå¦‚åˆ†åº“åˆ†è¡¨ï¼‰ï¼Œéœ€ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹çš„ schema å˜æ›´ä¸€è‡´ï¼Œå¯é€šè¿‡ä»¥ä¸‹æ–¹å¼ï¼š  
   - ä½¿ç”¨é›†ç¾¤ç®¡ç†å·¥å…·ï¼ˆå¦‚ MyCatã€ShardingSphereï¼‰ç»Ÿä¸€æ‰§è¡Œ DDLï¼›  
   - å…ˆåœ¨ä»èŠ‚ç‚¹æ‰§è¡Œé‡æ„ï¼ŒéªŒè¯åå†åŒæ­¥åˆ°ä¸»èŠ‚ç‚¹ã€‚

3. **è­¦æƒ•æ•°æ®ä¸¢å¤±**  
   é‡æ„å‰å¿…é¡»å¤‡ä»½æ•°æ®ï¼Œå¯¹äºåˆ é™¤å­—æ®µ/è¡¨çš„æ“ä½œï¼Œå»ºè®®å…ˆå½’æ¡£ï¼ˆå¦‚ rename ä¸º `xxx_old`ï¼‰ï¼Œè§‚å¯Ÿä¸€æ®µæ—¶é—´åå†å½»åº•åˆ é™¤ã€‚


### **æ€»ç»“**  
ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“é‡æ„çš„æ ¸å¿ƒæ˜¯â€œæ¸è¿›å¼ä¿®æ”¹ + å…¨é¢éªŒè¯â€ï¼Œé€šè¿‡å°æ­¥è°ƒæ•´é™ä½é£é™©ï¼Œä¾èµ–è‡ªåŠ¨åŒ–æµ‹è¯•å’Œç›‘æ§ç¡®ä¿ä¸šåŠ¡è¿ç»­æ€§ã€‚å…³é”®åœ¨äºå¹³è¡¡é‡æ„æ”¶ç›Šï¼ˆå¦‚æ€§èƒ½æå‡ã€å¯ç»´æŠ¤æ€§æ”¹å–„ï¼‰ä¸æ“ä½œé£é™©ï¼Œé¿å…å› æ¿€è¿›å˜æ›´å¯¼è‡´ç”Ÿäº§äº‹æ•…ã€‚

---

å½“ç„¶å¯ä»¥ï¼ä»¥ä¸‹æ˜¯ä¸€ä¸ª**ä¸­ç­‰ä»¥ä¸Šéš¾åº¦çš„ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“é‡æ„å®ä¾‹**ï¼ŒçœŸå®ã€å¤æ‚ã€æœ‰æŒ‘æˆ˜ï¼Œä½†å®Œå…¨å¯æ‰§è¡Œï¼Œæ˜¯èµ„æ·±åç«¯å·¥ç¨‹å¸ˆæˆ–æ•°æ®åº“æ¶æ„å¸ˆå¸¸é¢å¯¹çš„å…¸å‹åœºæ™¯ã€‚

---

## ğŸ§© å®ä¾‹ï¼šä»â€œå•ä½“ç”¨æˆ·è¡¨â€åˆ°â€œç”¨æˆ·ä¸­å¿ƒå¾®æœåŠ¡â€çš„æ•°æ®åº“æ‹†åˆ†é‡æ„

> **èƒŒæ™¯**ï¼šæŸç”µå•†å¹³å°å‘å±•ä¸‰å¹´ï¼Œç”¨æˆ·ç›¸å…³åŠŸèƒ½è¶Šæ¥è¶Šå¤æ‚ï¼ŒåŸ `users` è¡¨å·²ä¸å ªé‡è´Ÿã€‚

---

### ğŸ” ä¸€ã€é‡æ„å‰çš„ç—›ç‚¹ï¼ˆä¸ºä»€ä¹ˆå¿…é¡»é‡æ„ï¼Ÿï¼‰

| é—®é¢˜ | æè¿° |
|------|------|
| ğŸ¢ **è¡¨è¿‡å¤§** | `users` è¡¨ 5000 ä¸‡è¡Œï¼ŒæŸ¥è¯¢ç¼“æ…¢ |
| ğŸ”¥ **å­—æ®µçˆ†ç‚¸** | ä»æœ€åˆ 5 ä¸ªå­—æ®µ â†’ æ‰©å±•åˆ° 80+ å­—æ®µï¼ˆç§¯åˆ†ã€åå¥½ã€è®¾å¤‡ä¿¡æ¯ã€é£æ§æ ‡ç­¾ç­‰ï¼‰ |
| âš ï¸ **è€¦åˆä¸¥é‡** | è®¢å•ã€æ”¯ä»˜ã€æ¨èã€é£æ§éƒ½ç›´æ¥ä¾èµ–è¿™å¼ è¡¨ï¼Œæ”¹å­—æ®µå¦‚å±¥è–„å†° |
| ğŸ“‰ **æ€§èƒ½ç“¶é¢ˆ** | `UPDATE users SET last_login = ...` å¯¼è‡´ä¸»åº“ CPU 100% |
| ğŸ” **å®‰å…¨é£é™©** | æ‰€æœ‰æœåŠ¡éƒ½èƒ½è¯»å†™æ•æ„Ÿå­—æ®µï¼ˆå¦‚èº«ä»½è¯ã€æ‰‹æœºå·ï¼‰ |
| ğŸ”„ **æ‰©å±•å›°éš¾** | æƒ³åŠ â€œç”¨æˆ·ç”»åƒâ€åŠŸèƒ½ï¼Œä½†ä¸æ•¢åŠ¨ä¸»è¡¨ |

> âœ… **ç»“è®º**ï¼šè¿™å¼ è¡¨å·²æˆä¸ºç³»ç»Ÿçš„â€œå•ç‚¹æ•…éšœâ€å’Œâ€œæ¼”è¿›ç“¶é¢ˆâ€ã€‚

---

### ğŸ¯ äºŒã€é‡æ„ç›®æ ‡

| ç›®æ ‡ | è¯´æ˜ |
|------|------|
| âœ… æ‹†åˆ†èŒè´£ | å°† `users` è¡¨æŒ‰ä¸šåŠ¡åŸŸæ‹†åˆ†ä¸ºå¤šä¸ªä¸“ç”¨è¡¨/æœåŠ¡ |
| âœ… æå‡æ€§èƒ½ | å‡å°‘å•è¡¨å‹åŠ›ï¼Œæå‡æŸ¥è¯¢æ•ˆç‡ |
| âœ… å¢å¼ºå®‰å…¨ | æ•æ„Ÿæ•°æ®éš”ç¦»ï¼Œæƒé™åˆ†çº§ |
| âœ… æ”¯æŒç‹¬ç«‹æ¼”è¿› | ç”¨æˆ·æ ¸å¿ƒã€ç”¨æˆ·ç”»åƒã€é£æ§å¯ç‹¬ç«‹è¿­ä»£ |
| âœ… é›¶åœæœºè¿ç§» | ç”Ÿäº§ç¯å¢ƒæ— ç¼åˆ‡æ¢ï¼Œä¸å½±å“ç”¨æˆ·ç™»å½• |

---

### ğŸ—ºï¸ ä¸‰ã€é‡æ„æ–¹æ¡ˆè®¾è®¡

#### 1. æ‹†åˆ†ç­–ç•¥ï¼š**å‚ç›´åˆ†è¡¨ + æœåŠ¡åŒ–**

| åŸè¡¨å­—æ®µ | æ‹†åˆ†åå½’å± |
|---------|-----------|
| `id`, `username`, `password_hash`, `status` | `user_core`ï¼ˆç”¨æˆ·æ ¸å¿ƒæœåŠ¡ï¼‰ |
| `phone`, `email`, `real_name`, `id_card` | `user_profile`ï¼ˆç”¨æˆ·èµ„æ–™æœåŠ¡ï¼‰ |
| `points`, `level`, `vip_expire` | `user_account`ï¼ˆè´¦æˆ·æœåŠ¡ï¼‰ |
| `tags`, `interests`, `behavior_score` | `user_insight`ï¼ˆç”¨æˆ·ç”»åƒæœåŠ¡ï¼‰ |
| `risk_level`, `fraud_score`, `blacklist_reason` | `user_risk`ï¼ˆé£æ§æœåŠ¡ï¼‰ |

> âœ… æ¯ä¸ªæœåŠ¡æ‹¥æœ‰è‡ªå·±çš„æ•°æ®åº“ï¼Œé€šè¿‡ API æˆ–æ¶ˆæ¯é˜Ÿåˆ—é€šä¿¡ã€‚

---

#### 2. æ•°æ®è¿ç§»ç­–ç•¥ï¼š**åŒå†™ + åå‘åŒæ­¥ + åˆ‡æµ**

> ç›®æ ‡ï¼š**ä¸ä¸­æ–­æœåŠ¡ï¼Œé€æ­¥è¿ç§»**

| é˜¶æ®µ | æ“ä½œ | æ—¶é—´ |
|------|------|------|
| **Phase 1ï¼šå»ºç«‹æ–°è¡¨ç»“æ„** | åœ¨æ–°åº“ä¸­åˆ›å»º `user_core`, `user_profile` ç­‰è¡¨ | Day 1 |
| **Phase 2ï¼šåŒå†™æ¨¡å¼** | æ‰€æœ‰å†™æ“ä½œåŒæ—¶å†™æ—§ `users` è¡¨å’Œæ–°è¡¨ | Day 2-7 |
| **Phase 3ï¼šåå‘åŒæ­¥** | ç”¨è„šæœ¬å°†å†å²æ•°æ®ä» `users` åŒæ­¥åˆ°æ–°è¡¨ï¼ˆåˆ†æ‰¹ï¼‰ | Day 3-10 |
| **Phase 4ï¼šè¯»æµé‡åˆ‡æ¢** | é€æ­¥å°†è¯»è¯·æ±‚ä»æ—§è¡¨åˆ‡åˆ°æ–°æœåŠ¡ï¼ˆæŒ‰ç”¨æˆ· ID åˆ†ç‰‡ï¼‰ | Day 8-14 |
| **Phase 5ï¼šåœå†™æ—§è¡¨** | å…³é—­åŒå†™ï¼Œæ‰€æœ‰å†™å…¥èµ°æ–°æœåŠ¡ | Day 15 |
| **Phase 6ï¼šæ•°æ®æ ¡éªŒä¸ä¸‹çº¿** | å¯¹æ¯”æ–°æ—§æ•°æ®ä¸€è‡´æ€§ï¼Œæœ€ç»ˆä¸‹çº¿æ—§è¡¨ | Day 16-20 |

---

### âš™ï¸ å››ã€å…³é”®æŠ€æœ¯å®ç°

#### 1. **åŒå†™ä¸€è‡´æ€§ä¿éšœ**

```python
# ä¼ªä»£ç ï¼šç”¨æˆ·æ›´æ–°èµ„æ–™
def update_user_profile(user_id, data):
    # 1. å†™å…¥æ—§è¡¨ï¼ˆå…¼å®¹ç°æœ‰é€»è¾‘ï¼‰
    db_old.execute("""
        UPDATE users SET phone=?, real_name=? WHERE id=?
    """, [data['phone'], data['name'], user_id])

    # 2. å†™å…¥æ–°æœåŠ¡ï¼ˆå¼‚æ­¥ + é‡è¯•ï¼‰
    try:
        user_profile_service.update(user_id, data)
    except RPCError as e:
        # è®°å½•å¤±è´¥ï¼Œè¿›å…¥è¡¥å¿é˜Ÿåˆ—
        retry_queue.push({
            'user_id': user_id,
            'data': data,
            'retry_count': 0
        })

    # 3. å‘äº‹ä»¶ï¼ˆç”¨äºåç»­æœåŠ¡æ›´æ–°ï¼‰
    event_bus.publish('user.profile.updated', {
        'user_id': user_id,
        'changes': ['phone', 'name']
    })
```

> âœ… åŒå†™å¤±è´¥ä¸å½±å“ä¸»æµç¨‹ï¼Œä½†éœ€ç›‘æ§è¡¥å¿é˜Ÿåˆ—ã€‚

---

#### 2. **å†å²æ•°æ®è¿ç§»è„šæœ¬**

```python
# åˆ†æ‰¹è¿ç§»ç”¨æˆ·èµ„æ–™
def migrate_user_profile(batch_size=1000):
    last_id = 0
    while True:
        users = db_old.query("""
            SELECT id, phone, real_name, email 
            FROM users 
            WHERE id > %s 
            ORDER BY id 
            LIMIT %s
        """, [last_id, batch_size])

        if not users:
            break

        for user in users:
            user_profile_service.create_or_update(user)

        last_id = users[-1]['id']
        log(f"Migrated up to ID {last_id}")
```

> âœ… ä½¿ç”¨ `pt-archiver` æˆ–è‡ªå®šä¹‰è„šæœ¬ï¼Œé¿å…é”è¡¨ã€‚

---

#### 3. **è¯»æµé‡åˆ‡æ¢ï¼ˆç°åº¦å‘å¸ƒï¼‰**

```nginx
# Nginx é…ç½®ç¤ºä¾‹ï¼šæŒ‰ç”¨æˆ· ID åˆ†ç‰‡
if ($arg_user_id ~ "^[1-5]\d{8}$") {
    set $backend "new-user-service";
} else {
    set $backend "legacy-user-db";
}
```

æˆ–åœ¨ä»£ç ä¸­ï¼š

```python
def get_user_profile(user_id):
    if user_id % 100 < 70:  # 70% æµé‡èµ°æ–°æœåŠ¡
        return new_service.get(user_id)
    else:
        return legacy_db.query("SELECT ... FROM users WHERE id=?")
```

---

#### 4. **æ•°æ®ä¸€è‡´æ€§æ ¡éªŒ**

```python
# æ¯”å¯¹æ–°æ—§æ•°æ®å·®å¼‚
def verify_consistency():
    sample_ids = random.sample(range(1, 50_000_000), 10000)
    mismatch = []

    for user_id in sample_ids:
        old_data = legacy_db.get(user_id)
        new_data = user_profile_service.get(user_id)

        if old_data['phone'] != new_data['phone']:
            mismatch.append({
                'user_id': user_id,
                'old': old_data['phone'],
                'new': new_data['phone']
            })

    return mismatch
```

> âœ… å·®å¼‚ç‡ < 0.01% â†’ å¯ç»§ç»­åˆ‡æµ

---

### ğŸš¨ äº”ã€é£é™©ä¸åº”å¯¹

| é£é™© | åº”å¯¹æªæ–½ |
|------|----------|
| åŒå†™å¤±è´¥å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ | å¼‚æ­¥è¡¥å¿ + ç›‘æ§å‘Šè­¦ |
| è¿ç§»è„šæœ¬æ‹–å®æ•°æ®åº“ | é™é€Ÿã€åˆ†æ‰¹ã€ä½å³°æœŸæ‰§è¡Œ |
| æ–°æœåŠ¡æ€§èƒ½ä¸è¶³ | æå‰å‹æµ‹ï¼ŒåŠ ç¼“å­˜ï¼ˆRedisï¼‰ |
| å›æ»šå›°éš¾ | ä¿ç•™æ—§è¡¨ï¼Œæ”¯æŒåå‘åˆ‡æµ |
| è·¨æœåŠ¡è°ƒç”¨å»¶è¿Ÿ | ä½¿ç”¨å¼‚æ­¥äº‹ä»¶ï¼ˆKafkaï¼‰æ›¿ä»£åŒæ­¥ RPC |

---

### âœ… å…­ã€é‡æ„æˆæœ

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å |
|------|--------|--------|
| `users` è¡¨è¡Œæ•° | 5000 ä¸‡ | 0ï¼ˆä¸‹çº¿ï¼‰ |
| ç”¨æˆ·æŸ¥è¯¢ P99 å»¶è¿Ÿ | 480ms | 80ms |
| ä¸»åº“å†™å…¥å‹åŠ› | CPU 90%+ | CPU 40% |
| æ–°åŠŸèƒ½ä¸Šçº¿å‘¨æœŸ | 2å‘¨ï¼ˆéœ€è¯„å®¡ï¼‰ | 3å¤©ï¼ˆç‹¬ç«‹å‘å¸ƒï¼‰ |
| å®‰å…¨åˆè§„ | æ‰€æœ‰æœåŠ¡å¯è¯»æ•æ„Ÿä¿¡æ¯ | æƒé™åˆ†çº§ï¼Œå®¡è®¡æ—¥å¿— |

> ğŸ‰ **ç”¨æˆ·æ— æ„ŸçŸ¥å®Œæˆé‡æ„ï¼Œç³»ç»Ÿç¨³å®šæ€§å¤§å¹…æå‡**

---

## ğŸ§  ä¸ƒã€èµ„æ·±å¼€å‘è€…çš„å…³é”®å†³ç­–ç‚¹

| å†³ç­– | è¯´æ˜ |
|------|------|
| âŒ ä¸åšâ€œä¸€æ¬¡æ€§å¤§çˆ†ç‚¸è¿ç§»â€ | é£é™©å¤ªé«˜ï¼Œä¸å¯æ§ |
| âœ… é‡‡ç”¨â€œæ¸è¿›å¼æ¼”è¿›â€ | åŒå†™ + ç°åº¦ + æ ¡éªŒ |
| âœ… ä¿ç•™æ—§è¡¨ç›´åˆ°å®Œå…¨éªŒè¯ | å®‰å…¨ç¬¬ä¸€ |
| âœ… ç”¨äº‹ä»¶é©±åŠ¨æ›¿ä»£å¼ºä¾èµ– | é™ä½è€¦åˆ |
| âœ… å»ºç«‹æ•°æ®ä¸€è‡´æ€§ç›‘æ§ | é•¿æœŸä¿éšœ |

---

## ğŸ“Œ æ€»ç»“ï¼šç”Ÿäº§ç¯å¢ƒæ•°æ®åº“é‡æ„çš„é»„é‡‘æ³•åˆ™

> **â€œä¸æ±‚å¿«ï¼Œä½†æ±‚ç¨³ï¼›ä¸æ±‚å…¨ï¼Œä½†æ±‚å‡†â€**

### é‡æ„ checklistï¼š
- [ ] æœ‰å®Œæ•´çš„å›æ»šæ–¹æ¡ˆ
- [ ] æœ‰æ•°æ®ä¸€è‡´æ€§æ ¡éªŒæœºåˆ¶
- [ ] æœ‰ç›‘æ§å’Œå‘Šè­¦
- [ ] æœ‰ç°åº¦å‘å¸ƒèƒ½åŠ›
- [ ] å›¢é˜Ÿè¾¾æˆå…±è¯†ï¼ŒPM/è¿ç»´/å®‰å…¨éƒ½çŸ¥æƒ…

---

## ğŸ¯ ä¸€å¥è¯æ”¶å°¾

> **çœŸæ­£çš„æ•°æ®åº“é‡æ„ï¼Œä¸æ˜¯â€œæ”¹è¡¨ç»“æ„â€ï¼Œè€Œæ˜¯â€œé‡æ–°è®¾è®¡æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸä¸è¾¹ç•Œâ€**ã€‚  
> å®ƒè€ƒéªŒçš„ä¸ä»…æ˜¯æŠ€æœ¯ï¼Œæ›´æ˜¯**ç³»ç»Ÿæ€ç»´ã€é£é™©æ§åˆ¶å’Œå›¢é˜Ÿåä½œèƒ½åŠ›**ã€‚

è¿™æ­£æ˜¯èµ„æ·±å·¥ç¨‹å¸ˆä¸æ™®é€šå¼€å‘è€…çš„åˆ†æ°´å²­ã€‚