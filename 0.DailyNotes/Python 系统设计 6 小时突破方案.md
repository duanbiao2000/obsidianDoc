---
aliases:
date: 2025-12-03 13:14
tags:
source:
update:
rating:
related:
  - "[[é«˜æ•ˆå­¦ä¹  Python ç³»ç»Ÿè®¾è®¡]]"
---

# Python ç³»ç»Ÿè®¾è®¡ 6 å°æ—¶çªç ´æ–¹æ¡ˆ

## ç›®æ ‡ï¼šè®¾è®¡å®Œæ•´çš„ç§’æ€ç³»ç»Ÿï¼ˆé«˜å¹¶å‘ + æ¶ˆæ¯é˜Ÿåˆ— + API è®¾è®¡ï¼‰

---

## ğŸ“‹ æ–¹æ¡ˆæ€»è§ˆ

| é˜¶æ®µ       | æ—¶é—´    | æ ¸å¿ƒç›®æ ‡     | è¾“å‡º        |
| -------- | ----- | -------- | --------- |
| **é˜¶æ®µ 1** | 30min | ç³»ç»Ÿè®¾è®¡å¿ƒæ™ºæ¨¡å‹ | æ€ç»´æ¡†æ¶æ¸…å•    |
| **é˜¶æ®µ 2** | 1.5h  | ç§’æ€ç³»ç»Ÿéœ€æ±‚æ‹†è§£ | æ¶æ„è®¾è®¡æ–‡æ¡£    |
| **é˜¶æ®µ 3** | 2h    | æ ¸å¿ƒä»£ç å®ç°   | å¯è¿è¡Œçš„ Demo |
| **é˜¶æ®µ 4** | 1h    | æ€§èƒ½ä¼˜åŒ–ä¸æƒè¡¡  | ä¼˜åŒ–æ–¹æ¡ˆå¯¹æ¯”    |
| **é˜¶æ®µ 5** | 1h    | é¢è¯•æ¨¡æ‹Ÿè®²è§£   | ç­”é¢˜æ¨¡æ¿      |

**æ€»è®¡ï¼š6 å°æ—¶**

---

# é˜¶æ®µ 1ï¼šç³»ç»Ÿè®¾è®¡å¿ƒæ™ºæ¨¡å‹ï¼ˆ30 åˆ†é’Ÿï¼‰

## ğŸ§  æ ¸å¿ƒæ€ç»´æ¡†æ¶ï¼ˆä¸èƒŒçŸ¥è¯†ç‚¹ï¼Œç†è§£å†³ç­–é€»è¾‘ï¼‰

### ç³»ç»Ÿè®¾è®¡çš„ä¸‡èƒ½é—®é¢˜é“¾

```
1. éœ€æ±‚ç†è§£ï¼ˆAsk Clarifying Questionsï¼‰
   â”œâ”€ åŠŸèƒ½æ€§éœ€æ±‚ï¼šç³»ç»Ÿåšä»€ä¹ˆï¼Ÿ
   â”œâ”€ éåŠŸèƒ½æ€§éœ€æ±‚ï¼šæ€§èƒ½/å¯ç”¨æ€§/æ‰©å±•æ€§è¦æ±‚ï¼Ÿ
   â””â”€ çº¦æŸæ¡ä»¶ï¼šæˆæœ¬/æŠ€æœ¯æ ˆ/æ—¶é—´é™åˆ¶ï¼Ÿ

2. èƒ½åŠ›è¯„ä¼°ï¼ˆCapacity Estimationï¼‰
   â”œâ”€ æ—¥æ´»/ç§’çº§æµé‡æ¨ç®—
   â”œâ”€ å­˜å‚¨éœ€æ±‚è®¡ç®—
   â””â”€ å¸¦å®½é¢„ä¼°

3. æ¶æ„è®¾è®¡ï¼ˆHigh-Level Architectureï¼‰
   â”œâ”€ æ ¸å¿ƒæ¨¡å—è¯†åˆ«
   â”œâ”€ ç»„ä»¶é—´äº¤äº’
   â””â”€ ç“¶é¢ˆç‚¹é¢„åˆ¤

4. æ·±åº¦ä¼˜åŒ–ï¼ˆDeep Diveï¼‰
   â”œâ”€ ç“¶é¢ˆä¼˜åŒ–æ–¹æ¡ˆ
   â”œâ”€ ä¸€è‡´æ€§æƒè¡¡ï¼ˆCAPï¼‰
   â””â”€ å®¹é”™ä¸ç›‘æ§

5. æ‰©å±•è®¨è®ºï¼ˆTrade-offs & Scenariosï¼‰
   â”œâ”€ å¦‚æœ X å˜åŒ–ï¼Œç³»ç»Ÿå¦‚ä½•åº”å¯¹ï¼Ÿ
   â””â”€ ä¸ºä»€ä¹ˆé€‰ A è€Œé Bï¼Ÿ
```

### ç§’æ€ç³»ç»Ÿçš„è®¾è®¡æ ¸å¿ƒï¼ˆä¸‰ä¸ªå†³ç­–ç‚¹ï¼‰

| å†³ç­–ç‚¹      | é€‰é¡¹ A  | é€‰é¡¹ B    | ç§’æ€åœºæ™¯æœ€ä¼˜         |
| -------- | ----- | ------- | -------------- |
| **å¹¶å‘æ§åˆ¶** | æ•°æ®åº“è¡Œé” | åº”ç”¨å±‚é™æµ   | åº”ç”¨å±‚é™æµï¼ˆDB å‹åŠ›å¤ªå¤§ï¼‰ |
| **åº“å­˜æ‰£å‡** | å®æ—¶æ‰£å‡  | é¢„å‡+å¼‚æ­¥ç¡®è®¤ | é¢„å‡+å¼‚æ­¥ç¡®è®¤ï¼ˆç§’çº§å“åº”ï¼‰  |
| **ç»“æœé€šçŸ¥** | è½®è¯¢    | æ¶ˆæ¯é˜Ÿåˆ—    | æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆè§£è€¦+å¯é ï¼‰    |

**å¿ƒæ™ºæ¨¡å‹é€Ÿè®°**ï¼šç§’æ€ = é«˜å¹¶å‘å†™å…¥ â†’ ç“¶é¢ˆåœ¨"åº“å­˜æ‰£å‡" â†’ è§£å†³æ–¹æ¡ˆæ˜¯"å¼‚æ­¥åŒ– + å‰Šå³°"

---

## ğŸ“Š YAGNI åŸåˆ™åœ¨ç³»ç»Ÿè®¾è®¡ä¸­çš„åº”ç”¨

åœ¨è¿™ 6 å°æ—¶å†…ï¼Œ**ä¸éœ€è¦å­¦**ï¼š

- âŒ åˆ†å¸ƒå¼äº‹åŠ¡çš„ 7 ç§æ–¹æ¡ˆï¼ˆåªå­¦ 2-3 ç§æ ¸å¿ƒçš„ï¼‰
- âŒ å„ç§æ•°æ®åº“çš„ä¼˜ç¼ºç‚¹å¯¹æ¯”ï¼ˆé€‰ä¸€ä¸ªç”¨ï¼‰
- âŒ Kafka vs RabbitMQ vs Redis çš„æ·±åº¦è¯„æµ‹ï¼ˆé€‰ä¸€ä¸ªç”¨ï¼‰
- âŒ å®Œæ•´çš„ç›‘æ§å‘Šè­¦ä½“ç³»ï¼ˆçŸ¥é“è¦æœ‰å°±è¡Œï¼‰

**åªéœ€è¦å­¦**ï¼š

- âœ… ä¸ºä»€ä¹ˆè¿™ä¸ªæ–¹æ¡ˆè€Œä¸æ˜¯é‚£ä¸ª
- âœ… è¿™ä¸ªæ–¹æ¡ˆåœ¨ç§’æ€åœºæ™¯çš„å…·ä½“å®ç°
- âœ… é‡åˆ°é—®é¢˜æ—¶çš„æ•…éšœæ’æŸ¥æ€è·¯

---

# é˜¶æ®µ 2ï¼šç§’æ€ç³»ç»Ÿéœ€æ±‚æ‹†è§£ä¸æ¶æ„è®¾è®¡ï¼ˆ1.5 å°æ—¶ï¼‰

## ç¬¬ä¸€æ­¥ï¼šæ˜ç¡®éœ€æ±‚ï¼ˆ15 åˆ†é’Ÿï¼‰

### åŠŸèƒ½æ€§éœ€æ±‚

- ç”¨æˆ·å¯ä»¥åœ¨ç§’æ€å¼€å§‹æ—¶å¿«é€Ÿä¸‹å•
- æœ‰åº“å­˜é™åˆ¶ï¼ˆå¦‚ 1000 ä»¶ï¼‰
- å…ˆæ¥å…ˆå¾—ï¼Œä¸èƒ½è¶…å–
- ä¸‹å•åç”Ÿæˆè®¢å•ï¼Œæ”¯ä»˜ï¼Œå‘è´§

### éåŠŸèƒ½æ€§éœ€æ±‚ï¼ˆç§’æ€çš„æ ¸å¿ƒï¼‰

- **ååé‡**ï¼šå‡è®¾ 10000 QPSï¼ˆ10 ç§’å†…å–å®Œ 100000 ä»¶ï¼‰
- **å»¶è¿Ÿ**ï¼šP99 å»¶è¿Ÿ < 500ms
- **å¯ç”¨æ€§**ï¼š99.9%ï¼ˆå…è®¸çŸ­æ—¶é—´ä¸å¯ç”¨ï¼‰
- **ä¸€è‡´æ€§**ï¼šå¼ºä¸€è‡´ï¼ˆä¸èƒ½è¶…å–ï¼‰

### çº¦æŸæ¡ä»¶

- Python + Flask æŠ€æœ¯æ ˆ
- å•æœºæˆ–å°è§„æ¨¡åˆ†å¸ƒå¼ï¼ˆä¸æ˜¯å…¨çƒçº§ç³»ç»Ÿï¼‰
- æˆæœ¬è€ƒè™‘ï¼ˆä¸å †ç Œé«˜ç«¯ä¸­é—´ä»¶ï¼‰

---

## ç¬¬äºŒæ­¥ï¼šèƒ½åŠ›è¯„ä¼°ï¼ˆ15 åˆ†é’Ÿï¼‰

### æµé‡è®¡ç®—

```
ç§’æ€æ—¶é—´çª—å£ï¼š10 ç§’
æ€»è®¢å•é‡ï¼š100000
QPS = 100000 / 10 = 10000 QPS

å³°å€¼è€ƒè™‘ï¼šå®é™…å¯èƒ½é›†ä¸­åœ¨å‰ 2 ç§’
å³°å€¼ QPS â‰ˆ 100000 / 2 = 50000 QPS
```

### å­˜å‚¨è®¡ç®—

```
è®¢å•æ•°æ®ï¼šæ¯æ¡ 1KB
100000 è®¢å• Ã— 1KB = 100MBï¼ˆå¯æ¥å—ï¼‰

ç”¨æˆ·æ•°æ®ï¼šå‡è®¾ 100 ä¸‡ç”¨æˆ·ï¼Œæ¯æ¡ 0.5KB
= 500MBï¼ˆå¯æ¥å—ï¼‰

æ€»å­˜å‚¨ï¼š1-2GBï¼ˆå•æœº SSD å®Œå…¨å¤Ÿï¼‰
```

### æ•°æ®åº“èƒ½åŠ›è¯„ä¼°

```
å• MySQL æ‰¿å—èƒ½åŠ›ï¼š1000-5000 QPS
æˆ‘ä»¬éœ€è¦ï¼š10000 QPS
ç»“è®ºï¼šéœ€è¦åˆ†æµï¼Œä¸èƒ½è®©æ‰€æœ‰å†™éƒ½æ‰“åˆ° DB
```

---

## ç¬¬ä¸‰æ­¥ï¼šé«˜çº§æ¶æ„è®¾è®¡ï¼ˆ45 åˆ†é’Ÿï¼‰

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Client (Web/App)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ HTTP Request
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Gateway / Load Balancer                             â”‚
â”‚  - é™æµï¼ˆå‰Šå³°ï¼‰                                           â”‚
â”‚  - èº«ä»½éªŒè¯                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼              â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚Flask 1 â”‚   â”‚Flask 2 â”‚   â”‚Flask N â”‚  (åº”ç”¨å±‚)
    â”‚- éªŒè¯  â”‚   â”‚- éªŒè¯  â”‚   â”‚- éªŒè¯  â”‚
    â”‚- é™æµ  â”‚   â”‚- é™æµ  â”‚   â”‚- é™æµ  â”‚
    â”‚- åº“å­˜  â”‚   â”‚- åº“å­˜  â”‚   â”‚- åº“å­˜  â”‚
    â”‚ é¢„å‡   â”‚   â”‚ é¢„å‡   â”‚   â”‚ é¢„å‡   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
         â”‚             â”‚            â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼              â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Redis   â”‚  â”‚ Message  â”‚  â”‚ MySQL    â”‚
    â”‚ åº“å­˜ç¼“å­˜ â”‚  â”‚ Queue    â”‚  â”‚ æŒä¹…åŒ–   â”‚
    â”‚(é¢„å‡)   â”‚  â”‚(RabbitMQ)â”‚  â”‚ è®¢å•è¡¨   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â–¼             â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚è®¢å•å¤„ç†æœåŠ¡ â”‚ â”‚é€šçŸ¥æœåŠ¡  â”‚
                   â”‚- çœŸå®æ‰£å‡   â”‚ â”‚- å‘é€SMS â”‚
                   â”‚- æ”¯ä»˜/å‘è´§  â”‚ â”‚- é‚®ä»¶   â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒè®¾è®¡å†³ç­–

#### å†³ç­– 1ï¼šé™æµä¸å‰Šå³°

```
ä½ç½®ï¼šAPI Gateway å±‚
æ–¹æ¡ˆï¼šä»¤ç‰Œæ¡¶ç®—æ³• or æ¼æ¡¶
åŸå› ï¼š
  - 50000 QPS æ¥ä¸´æ—¶ï¼Œç›´æ¥æ‰“åˆ°åº”ç”¨å±‚ä¼šå‹æ­»
  - åœ¨ç½‘å…³å±‚é¢é™æµï¼Œæ‹’ç»è¯·æ±‚æˆæœ¬æœ€ä½ï¼ˆä¸è¿›å…¥åº”ç”¨ï¼‰
  - å®¢æˆ·ç«¯èƒ½å¿«é€Ÿå¾—åˆ°åé¦ˆ

é™æµå€¼è®¾ç½®ï¼šæ ¹æ®åç«¯èƒ½åŠ›ï¼Œå‡è®¾åº”ç”¨å±‚èƒ½å¤„ç† 15000 QPS
åˆ™é™æµé˜ˆå€¼ = 15000 QPS
```

#### å†³ç­– 2ï¼šåº“å­˜æ‰£å‡æ–¹æ¡ˆ

```
æ™®é€šæ–¹æ¡ˆçš„é—®é¢˜ï¼š
  SELECT stock FROM products WHERE id=1;  // æŸ¥
  if stock > 0:
      UPDATE products SET stock=stock-1 WHERE id=1;  // æ‰£
  é—®é¢˜ï¼šå¹¶å‘æ—¶ä¼šè¶…å–

æ–¹æ¡ˆå¯¹æ¯”ï¼š
A. æ•°æ®åº“è¡Œé”ï¼ˆSELECT FOR UPDATEï¼‰
   ä¼˜ç‚¹ï¼šå¼ºä¸€è‡´æ€§
   ç¼ºç‚¹ï¼šé”ç«äº‰ä¸¥é‡ï¼Œååé‡ä½ï¼ˆ1000 QPS maxï¼‰
   âŒ ä¸é€‚åˆç§’æ€

B. é¢„å‡ + å¼‚æ­¥ç¡®è®¤ï¼ˆæ¨èï¼‰
   ç¬¬ä¸€æ­¥ï¼šRedis é¢„å‡ï¼ˆç§’çº§ï¼‰
     - DECR stock_cache:1  // åŸå­æ“ä½œ
     - å¦‚æœè¿”å› < 0ï¼Œè¯´æ˜è¶…å–ï¼Œç›´æ¥æ‹’ç»
     - æˆåŠŸåˆ™è¿”å› token ç»™å®¢æˆ·ç«¯
   
   ç¬¬äºŒæ­¥ï¼šå‘é€æ¶ˆæ¯é˜Ÿåˆ—
     - æ¶ˆæ¯å†…å®¹ï¼š{user_id, product_id, order_id}
     - MQ ä¿è¯å¯é æ€§
   
   ç¬¬ä¸‰æ­¥ï¼šåç«¯è®¢å•æœåŠ¡å¤„ç†
     - æ¶ˆè´¹ MQ ä¸­çš„æ¶ˆæ¯
     - æ•°æ®åº“çœŸå®æ‰£å‡åº“å­˜
     - å¦‚æœæ•°æ®åº“æ‰£å‡å¤±è´¥ï¼Œè¡¥å¿æœºåˆ¶
   
   ä¼˜ç‚¹ï¼š
     - å‰ç«¯å“åº”å¿«ï¼ˆåªéœ€ Redis é¢„å‡ï¼‰
     - ååé‡é«˜ï¼ˆRedis å¯æ”¯æŒ 100000+ QPSï¼‰
     - æœ€ç»ˆä¸€è‡´æ€§ï¼ˆå…è®¸çŸ­æš‚ä¸ä¸€è‡´ï¼‰
   
   âœ… æœ€é€‚åˆç§’æ€åœºæ™¯
```

#### å†³ç­– 3ï¼šæ¶ˆæ¯é˜Ÿåˆ—çš„ä½œç”¨

```
ä¸ºä»€ä¹ˆéœ€è¦ MQï¼Ÿ

ä¸ç”¨ MQ çš„æ–¹æ¡ˆï¼š
  1. ç”¨æˆ·ä¸‹å•ï¼ˆRedis é¢„å‡åº“å­˜ï¼‰
  2. Flask ç›´æ¥æ“ä½œæ•°æ®åº“ï¼ˆçœŸå®æ‰£å‡ã€ç”Ÿæˆè®¢å•ï¼‰
  é—®é¢˜ï¼š
    - Flask å¤„ç†æµç¨‹é•¿ï¼Œå“åº”æ…¢
    - æ•°æ®åº“å‹åŠ›å¤§ï¼ˆ50000 QPS å…¨éƒ¨æ¥ï¼‰
    - ä¸€ä¸ªä¸‹æ¸¸æ•…éšœå¯¼è‡´æ•´ä¸ªæµç¨‹å¡ä½

ç”¨ MQ çš„æ–¹æ¡ˆï¼š
  1. ç”¨æˆ·ä¸‹å•ï¼ˆRedis é¢„å‡ï¼‰
  2. Flask å‘é€æ¶ˆæ¯åˆ° MQï¼ˆç«‹å³è¿”å›ï¼‰
  3. åç«¯è®¢å•æœåŠ¡å¼‚æ­¥æ¶ˆè´¹ MQ
  ä¼˜ç‚¹ï¼š
    - å‰ç«¯å“åº”å¿«ï¼ˆä¸ç­‰æ•°æ®åº“ï¼‰
    - æ•°æ®åº“å‹åŠ›å‡è¡¡ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
    - è§£è€¦ï¼šè®¢å•æœåŠ¡æ•…éšœä¸å½±å“ä¸‹å•
    - å¯é‡è¯•ï¼šå¦‚æœå¤„ç†å¤±è´¥ï¼ŒMQ è‡ªåŠ¨é‡è¯•
```

---

# é˜¶æ®µ 3ï¼šæ ¸å¿ƒä»£ç å®ç°ï¼ˆ2 å°æ—¶ï¼‰

## ç¯å¢ƒä¸ä¾èµ–

```bash
pip install flask redis pika sqlalchemy psycopg2-binary gunicorn
```

æ ¸å¿ƒåº“è¯´æ˜ï¼š

- `redis`ï¼šåº“å­˜ç¼“å­˜ä¸é¢„å‡
- `pika`ï¼šRabbitMQ å®¢æˆ·ç«¯ï¼ˆMQï¼‰
- `sqlalchemy`ï¼šORM æ¡†æ¶
- `gunicorn`ï¼šç”Ÿäº§çº§ WSGI æœåŠ¡å™¨

---

## å®Œæ•´ä»£ç å®ç°

### 1. æ•°æ®åº“æ¨¡å‹

```python
# models.py
from sqlalchemy import create_engine, Column, Integer, String, DateTime, Float
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from datetime import datetime

Base = declarative_base()

class Product(Base):
    __tablename__ = 'products'
    
    id = Column(Integer, primary_key=True)
    name = Column(String(100))
    stock = Column(Integer, default=0)
    price = Column(Float)
    created_at = Column(DateTime, default=datetime.utcnow)

class Order(Base):
    __tablename__ = 'orders'
    
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer)
    product_id = Column(Integer)
    quantity = Column(Integer, default=1)
    status = Column(String(20), default='pending')  # pending/confirmed/failed
    created_at = Column(DateTime, default=datetime.utcnow)

# æ•°æ®åº“è¿æ¥
DATABASE_URL = "postgresql://user:password@localhost/seckill"
engine = create_engine(DATABASE_URL)
SessionLocal = sessionmaker(bind=engine)
```

### 2. Redis æ“ä½œå±‚

```python
# cache.py
import redis
from typing import Optional

class RedisCache:
    def __init__(self, host='localhost', port=6379, db=0):
        self.client = redis.Redis(host=host, port=port, db=db, decode_responses=True)
    
    def get_stock(self, product_id: int) -> Optional[int]:
        """è·å–ç¼“å­˜åº“å­˜"""
        key = f"stock:{product_id}"
        stock = self.client.get(key)
        return int(stock) if stock else None
    
    def init_stock(self, product_id: int, stock: int) -> bool:
        """åˆå§‹åŒ–åº“å­˜åˆ° Redisï¼ˆç§’æ€å¼€å§‹å‰è°ƒç”¨ï¼‰"""
        key = f"stock:{product_id}"
        return self.client.set(key, stock)
    
    def decr_stock(self, product_id: int, quantity: int = 1) -> int:
        """
        åŸå­æ€§åœ°æ‰£å‡åº“å­˜
        è¿”å›æ‰£å‡åçš„åº“å­˜ï¼Œå¦‚æœ < 0 è¡¨ç¤ºè¶…å–
        """
        key = f"stock:{product_id}"
        result = self.client.decrby(key, quantity)
        return result
    
    def incr_stock(self, product_id: int, quantity: int = 1) -> int:
        """è¡¥å¿ï¼šåº“å­˜ä¸è¶³æ—¶å›æ»š"""
        key = f"stock:{product_id}"
        return self.client.incrby(key, quantity)

# å…¨å±€å®ä¾‹
cache = RedisCache()
```

### 3. æ¶ˆæ¯é˜Ÿåˆ—å°è£…

```python
# mq.py
import pika
import json
from typing import Dict, Callable

class RabbitMQProducer:
    def __init__(self, host='localhost', queue_name='seckill_orders'):
        self.connection = pika.BlockingConnection(
            pika.ConnectionParameters(host=host)
        )
        self.channel = self.connection.channel()
        self.queue_name = queue_name
        
        # å£°æ˜é˜Ÿåˆ—ï¼ˆæŒä¹…åŒ–ï¼‰
        self.channel.queue_declare(
            queue=queue_name,
            durable=True
        )
    
    def send_order(self, order_data: Dict):
        """
        å‘é€è®¢å•æ¶ˆæ¯åˆ° MQ
        order_data: {user_id, product_id, quantity, order_id}
        """
        message = json.dumps(order_data)
        self.channel.basic_publish(
            exchange='',
            routing_key=self.queue_name,
            body=message,
            properties=pika.BasicProperties(
                delivery_mode=pika.spec.PERSISTENT_DELIVERY_MODE  # æ¶ˆæ¯æŒä¹…åŒ–
            )
        )
    
    def close(self):
        self.connection.close()

class RabbitMQConsumer:
    def __init__(self, host='localhost', queue_name='seckill_orders'):
        self.connection = pika.BlockingConnection(
            pika.ConnectionParameters(host=host)
        )
        self.channel = self.connection.channel()
        self.queue_name = queue_name
        self.channel.queue_declare(queue=queue_name, durable=True)
        
        # æœåŠ¡è´¨é‡ï¼šæ¯æ¬¡å¤„ç†ä¸€æ¡æ¶ˆæ¯
        self.channel.basic_qos(prefetch_count=1)
    
    def start_consuming(self, callback: Callable):
        """
        å¯åŠ¨æ¶ˆè´¹
        callback: å¤„ç†æ¶ˆæ¯çš„å›è°ƒå‡½æ•°ï¼Œç­¾åä¸º (channel, method, properties, body)
        """
        self.channel.basic_consume(
            queue=self.queue_name,
            on_message_callback=callback
        )
        
        print(f'[*] Waiting for messages in {self.queue_name}...')
        self.channel.start_consuming()

# ç”Ÿäº§è€…å…¨å±€å®ä¾‹
producer = RabbitMQProducer()
```

### 4. é™æµå™¨

```python
# rate_limiter.py
from collections import defaultdict
from time import time
from threading import Lock

class TokenBucket:
    """ä»¤ç‰Œæ¡¶ç®—æ³•å®ç°"""
    def __init__(self, capacity: int, refill_rate: float):
        """
        capacity: æ¡¶çš„å®¹é‡ï¼ˆæœ€å¤šå­˜å‚¨çš„ä»¤ç‰Œæ•°ï¼‰
        refill_rate: æ¯ç§’è¡¥å……çš„ä»¤ç‰Œæ•°
        """
        self.capacity = capacity
        self.refill_rate = refill_rate
        self.tokens = capacity
        self.last_refill = time()
        self.lock = Lock()
    
    def allow_request(self, tokens_needed: int = 1) -> bool:
        """
        æ£€æŸ¥æ˜¯å¦å…è®¸è¯·æ±‚
        è¿”å› True è¡¨ç¤ºé€šè¿‡é™æµï¼ŒFalse è¡¨ç¤ºè¢«é™æµ
        """
        with self.lock:
            now = time()
            # è®¡ç®—éœ€è¦è¡¥å……çš„ä»¤ç‰Œ
            elapsed = now - self.last_refill
            new_tokens = elapsed * self.refill_rate
            self.tokens = min(self.capacity, self.tokens + new_tokens)
            self.last_refill = now
            
            if self.tokens >= tokens_needed:
                self.tokens -= tokens_needed
                return True
            return False

# æ¯ä¸ªç”¨æˆ·çš„é™æµå™¨
user_limiters = defaultdict(lambda: TokenBucket(capacity=10, refill_rate=1))

def check_user_rate_limit(user_id: int) -> bool:
    """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¶…è¿‡é™æµ"""
    return user_limiters[user_id].allow_request()
```

### 5. Flask åº”ç”¨æ ¸å¿ƒé€»è¾‘

```python
# app.py
from flask import Flask, request, jsonify
from sqlalchemy.orm import Session
import uuid
from cache import cache
from mq import producer
from rate_limiter import check_user_rate_limit
from models import SessionLocal, Order, Product

app = Flask(__name__)

PRODUCT_ID = 1  # ç§’æ€äº§å“ ID

class OrderService:
    @staticmethod
    def create_order(user_id: int, product_id: int, quantity: int = 1):
        """
        ç§’æ€æ ¸å¿ƒé€»è¾‘
        è¿”å›: (success, order_id, message)
        """
        
        # ç¬¬ä¸€é“é˜²çº¿ï¼šç”¨æˆ·é™æµ
        if not check_user_rate_limit(user_id):
            return False, None, "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•"
        
        # ç¬¬äºŒé“é˜²çº¿ï¼šRedis é¢„å‡åº“å­˜
        remaining_stock = cache.decr_stock(product_id, quantity)
        
        if remaining_stock < 0:
            # åº“å­˜ä¸è¶³ï¼Œå›æ»š
            cache.incr_stock(product_id, quantity)
            return False, None, "åº“å­˜ä¸è¶³"
        
        # ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆè®¢å• ID
        order_id = str(uuid.uuid4())
        
        # ç¬¬å››æ­¥ï¼šå‘é€åˆ° MQï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
        order_data = {
            'order_id': order_id,
            'user_id': user_id,
            'product_id': product_id,
            'quantity': quantity
        }
        producer.send_order(order_data)
        
        return True, order_id, "ä¸‹å•æˆåŠŸï¼Œè¯·ç­‰å¾…ç¡®è®¤"

@app.route('/api/seckill', methods=['POST'])
def seckill():
    """ç§’æ€æ¥å£"""
    data = request.get_json()
    user_id = data.get('user_id')
    quantity = data.get('quantity', 1)
    
    if not user_id:
        return jsonify({'error': 'ç¼ºå°‘ user_id'}), 400
    
    success, order_id, message = OrderService.create_order(
        user_id=user_id,
        product_id=PRODUCT_ID,
        quantity=quantity
    )
    
    return jsonify({
        'success': success,
        'order_id': order_id,
        'message': message
    }), 200 if success else 409

@app.route('/api/stock', methods=['GET'])
def get_stock():
    """æŸ¥çœ‹å®æ—¶åº“å­˜"""
    stock = cache.get_stock(PRODUCT_ID)
    return jsonify({'stock': stock or 0})

@app.route('/api/init-stock', methods=['POST'])
def init_stock():
    """åˆå§‹åŒ–åº“å­˜ï¼ˆç§’æ€å¼€å§‹å‰è°ƒç”¨ï¼‰"""
    data = request.get_json()
    stock = data.get('stock', 1000)
    cache.init_stock(PRODUCT_ID, stock)
    return jsonify({'message': f'åº“å­˜å·²åˆå§‹åŒ–ä¸º {stock}'})

if __name__ == '__main__':
    app.run(debug=False, threaded=True)
```

### 6. åç«¯è®¢å•å¤„ç†æœåŠ¡

```python
# order_consumer.py
import json
from mq import RabbitMQConsumer
from models import SessionLocal, Order
from cache import cache

def process_order(channel, method, properties, body):
    """
    æ¶ˆè´¹ MQ ä¸­çš„è®¢å•æ¶ˆæ¯
    æ‰§è¡ŒçœŸå®çš„æ•°æ®åº“æ‰£å‡ä¸è®¢å•åˆ›å»º
    """
    try:
        order_data = json.loads(body)
        
        db = SessionLocal()
        try:
            # åœ¨æ•°æ®åº“ä¸­åˆ›å»ºè®¢å•è®°å½•
            order = Order(
                user_id=order_data['user_id'],
                product_id=order_data['product_id'],
                quantity=order_data['quantity'],
                status='confirmed'
            )
            db.add(order)
            db.commit()
            
            print(f"âœ“ è®¢å• {order_data['order_id']} å·²ç¡®è®¤")
            
            # ç¡®è®¤æ¶ˆæ¯ï¼ŒMQ å¯ä»¥åˆ é™¤
            channel.basic_ack(delivery_tag=method.delivery_tag)
            
        except Exception as e:
            print(f"âœ— è®¢å•å¤„ç†å¤±è´¥: {e}")
            db.rollback()
            
            # å¦å®šç¡®è®¤ï¼Œæ¶ˆæ¯ä¼šé‡æ–°å…¥é˜Ÿï¼ˆé‡è¯•ï¼‰
            channel.basic_nack(delivery_tag=method.delivery_tag, requeue=True)
        finally:
            db.close()
    
    except json.JSONDecodeError:
        print(f"æ¶ˆæ¯æ ¼å¼é”™è¯¯: {body}")
        channel.basic_ack(delivery_tag=method.delivery_tag)

if __name__ == '__main__':
    consumer = RabbitMQConsumer()
    consumer.start_consuming(process_order)
```

### 7. å‹æµ‹è„šæœ¬

```python
# load_test.py
import requests
import time
from concurrent.futures import ThreadPoolExecutor, as_completed

BASE_URL = "http://localhost:5000"
NUM_USERS = 100
REQUESTS_PER_USER = 50

def seckill_request(user_id: int) -> dict:
    """å•ä¸ªç§’æ€è¯·æ±‚"""
    try:
        response = requests.post(
            f"{BASE_URL}/api/seckill",
            json={'user_id': user_id, 'quantity': 1},
            timeout=2
        )
        return {
            'user_id': user_id,
            'status': response.status_code,
            'success': response.json().get('success', False)
        }
    except Exception as e:
        return {
            'user_id': user_id,
            'error': str(e)
        }

def load_test():
    """å¹¶å‘å‹æµ‹"""
    print(f"[*] åˆå§‹åŒ–åº“å­˜...")
    requests.post(f"{BASE_URL}/api/init-stock", json={'stock': 1000})
    
    print(f"[*] å¼€å§‹å‹æµ‹: {NUM_USERS} ç”¨æˆ· x {REQUESTS_PER_USER} è¯·æ±‚")
    start_time = time.time()
    
    results = {'success': 0, 'failed': 0, 'errors': 0}
    
    with ThreadPoolExecutor(max_workers=50) as executor:
        futures = []
        
        for user_id in range(NUM_USERS):
            for _ in range(REQUESTS_PER_USER):
                future = executor.submit(seckill_request, user_id)
                futures.append(future)
        
        for future in as_completed(futures):
            result = future.result()
            
            if 'error' in result:
                results['errors'] += 1
            elif result.get('success'):
                results['success'] += 1
            else:
                results['failed'] += 1
    
    elapsed = time.time() - start_time
    total_requests = NUM_USERS * REQUESTS_PER_USER
    qps = total_requests / elapsed
    
    print(f"\n[*] å‹æµ‹å®Œæˆ")
    print(f"æ€»è¯·æ±‚æ•°: {total_requests}")
    print(f"æˆåŠŸ: {results['success']}")
    print(f"å¤±è´¥: {results['failed']}")
    print(f"é”™è¯¯: {results['errors']}")
    print(f"è€—æ—¶: {elapsed:.2f}s")
    print(f"QPS: {qps:.0f}")

if __name__ == '__main__':
    load_test()
```

---

## ä»£ç æ‰§è¡Œæµç¨‹å›¾

```
ç”¨æˆ·è¯·æ±‚
    â†“
[é™æµæ£€æŸ¥] â† ä»¤ç‰Œæ¡¶
    â†“
[Redis é¢„å‡åº“å­˜] â† åŸå­æ“ä½œ
    â†“
[ç”Ÿæˆè®¢å• ID]
    â†“
[å‘é€åˆ° MQ] â† ç«‹å³è¿”å›å“åº”ç»™ç”¨æˆ·
    â†“
ç”¨æˆ·æ”¶åˆ°: "ä¸‹å•æˆåŠŸ"
    â†“
(åå°å¼‚æ­¥)
    â†“
[MQ æ¶ˆè´¹] â† order_consumer.py
    â†“
[æ•°æ®åº“çœŸå®æ‰£å‡] â† å†™å…¥ Order è¡¨
    â†“
[å‘é€ç¡®è®¤æ¶ˆæ¯] â† MQ ACK
```

---

# é˜¶æ®µ 4ï¼šæ€§èƒ½ä¼˜åŒ–ä¸æƒè¡¡åˆ†æï¼ˆ1 å°æ—¶ï¼‰

## ç“¶é¢ˆè¯†åˆ«

### å½“å‰æ¶æ„èƒ½å¤„ç†å¤šå°‘ QPSï¼Ÿ

```
é™åˆ¶å› ç´ åˆ†æï¼š

1. Flask å•æœºååé‡ï¼š
   - Gunicorn é»˜è®¤ worker æ•° = CPU æ ¸æ•°
   - 4 æ ¸æœºå™¨ â†’ 4 ä¸ª worker
   - æ¯ä¸ª worker æ¯ç§’å¤„ç† 200-300 ä¸ªè¯·æ±‚
   - æ€»ååé‡ â‰ˆ 800-1200 QPS

2. Redis ååé‡ï¼š
   - å•æœºå¯æ”¯æŒ 100000+ QPSï¼ˆåªæ˜¯ DECR æ“ä½œï¼‰
   - ä¸æ˜¯ç“¶é¢ˆ

3. MySQL ååé‡ï¼š
   - å¼‚æ­¥å¤„ç†ï¼Œä¸å½±å“å‰ç«¯å“åº”
   - è®¢å•å¤„ç†é€Ÿåº¦å¯æ§ï¼ˆæ¯ç§’ 100-500 æ¡ï¼‰
   - ä¸æ˜¯ç“¶é¢ˆ

4. MQ ååé‡ï¼š
   - RabbitMQ å•æœºï¼š10000+ QPS
   - å¦‚æœæ¶ˆè´¹å¤ªæ…¢ï¼Œé˜Ÿåˆ—å †ç§¯ï¼ˆå¯æ¥å—ï¼Œå¼‚æ­¥å˜›ï¼‰

ç»“è®ºï¼šå½“å‰æ¶æ„ç“¶é¢ˆæ˜¯ Flask åº”ç”¨å±‚
```

## ä¼˜åŒ–æ–¹æ¡ˆ 1ï¼šæ°´å¹³æ‰©å±•

```
æå‡ QPS ä» 1000 åˆ° 10000ï¼š

å½“å‰ï¼š1 ä¸ª Flask å®ä¾‹
      â†“
æ”¹è¿›ï¼šå¤šä¸ª Flask å®ä¾‹ + LB

è¯·æ±‚æµç¨‹ï¼š
  å®¢æˆ·ç«¯ â†’ Nginx (è´Ÿè½½å‡è¡¡) â†’ Flask 1/2/3/4
           â†“
         åˆ†æ•£è¯·æ±‚

é…ç½®ç¤ºä¾‹ï¼ˆNginxï¼‰ï¼š
```

```nginx
upstream flask_backend {
    server 127.0.0.1:5001;
    server 127.0.0.1:5002;
    server 127.0.0.1:5003;
    server 127.0.0.1:5004;
}

server {
    listen 80;
    
    location /api {
        proxy_pass http://flask_backend;
    }
}
```

```
å¯åŠ¨å¤šä¸ª Flask å®ä¾‹ï¼š
$ gunicorn -w 4 -b 127.0.0.1:5001 app:app
$ gunicorn -w 4 -b 127.0.0.1:5002 app:app
$ gunicorn -w 4 -b 127.0.0.1:5003 app:app
$ gunicorn -w 4 -b 127.0.0.1:5004 app:app

æ­¤æ—¶ QPS â‰ˆ 4000-5000ï¼ˆ4 ä¸ªå®ä¾‹ Ã— 1000-1200 QPSï¼‰
```

## ä¼˜åŒ–æ–¹æ¡ˆ 2ï¼šå¼‚æ­¥æ¡†æ¶å‡çº§

ä» Flask åŒæ­¥ â†’ FastAPI/Sanic å¼‚æ­¥æ¡†æ¶ï¼š

```python
# å¯¹æ¯”ï¼šFlask åŒæ­¥ vs FastAPI å¼‚æ­¥

# Flaskï¼ˆåŒæ­¥ï¼‰
@app.route('/api/seckill', methods=['POST'])
def seckill():
    result = cache.decr_stock(product_id)  # é˜»å¡ç­‰å¾…
    producer.send_order(order_data)        # é˜»å¡ç­‰å¾…
    return jsonify(result)
# é—®é¢˜ï¼šæ¯ä¸ªè¯·æ±‚å ç”¨ä¸€ä¸ª worker çº¿ç¨‹ï¼Œç›´åˆ°å®Œæˆ

# FastAPIï¼ˆå¼‚æ­¥ï¼‰
@app.post('/api/seckill')
async def seckill(data: OrderData):
    result = await async_cache.decr_stock(product_id)  # éé˜»å¡
    await async_producer.send_order(order_data)        # éé˜»å¡
    return result
# ä¼˜ç‚¹ï¼šä¸€ä¸ª worker å¯ä»¥åŒæ—¶å¤„ç†æ•°ç™¾ä¸ªç­‰å¾…ä¸­çš„è¯·æ±‚
```

**æ€§èƒ½æå‡**ï¼š

- Flask åŒæ­¥ï¼š1 worker Ã— 200 req/s = 200 req/s per worker
- FastAPI å¼‚æ­¥ï¼š1 worker Ã— 5000 req/s = 5000 req/s per worker
- ç›¸åŒç¡¬ä»¶ä¸‹æå‡ **25 å€**

```python
# FastAPI ç‰ˆç§’æ€æœåŠ¡ï¼ˆæ ¸å¿ƒéƒ¨åˆ†ï¼‰
from fastapi import FastAPI
from aioredis import Redis
import aio_pika

app = FastAPI()

redis_pool: Redis = None
mq_connection: aio_pika.Connection = None

@app.on_event("startup")
async def startup():
    global redis_pool, mq_connection
    redis_pool = await aioredis.create_redis_pool('redis://localhost')
    mq_connection = await aio_pika.connect_robust("amqp://guest:guest@localhost/")

@app.post('/api/seckill')
async def seckill(data: OrderData):
    user_id = data.user_id
    
    # é™æµæ£€æŸ¥
    if not await check_user_rate_limit(user_id):
        return {'success': False, 'message': 'è¯·æ±‚è¿‡äºé¢‘ç¹'}
    
    # Redis é¢„å‡ï¼ˆå¼‚æ­¥ï¼‰
    remaining = await redis_pool.decrby(f'stock:{PRODUCT_ID}', 1)
    
    if remaining < 0:
        await redis_pool.incrby(f'stock:{PRODUCT_ID}', 1)
        return {'success': False, 'message': 'åº“å­˜ä¸è¶³'}
    
    order_id = str(uuid.uuid4())
    
    # å‘é€ MQï¼ˆå¼‚æ­¥ï¼‰
    channel = await mq_connection.channel()
    queue = await channel.get_queue('seckill_orders')
    await queue.put(
        aio_pika.Message(
            body=json.dumps({
                'order_id': order_id,
                'user_id': user_id,
                'product_id': PRODUCT_ID
            }).encode()
        )
    )
    
    return {'success': True, 'order_id': order_id, 'message': 'ä¸‹å•æˆåŠŸ'}
```

## ä¼˜åŒ–æ–¹æ¡ˆ 3ï¼šæœ¬åœ°åº“å­˜æ‰£å‡ï¼ˆä¸èµ° Redisï¼‰

é—®é¢˜è¯†åˆ«ï¼šRedis ç½‘ç»œ I/O ä¹Ÿæ˜¯å»¶è¿Ÿæ¥æº

```
å½“å‰ï¼šæ¯ä¸ªè¯·æ±‚éƒ½è¦è®¿é—® Redis
     ç½‘ç»œ RTT â‰ˆ 1ms Ã— 100000 è¯·æ±‚ = 100s æ€»å»¶è¿Ÿ

ä¼˜åŒ–ï¼šä½¿ç”¨æœ¬åœ°å†…å­˜ + åˆ†æ®µé¢„æ‰£

åŸç†ï¼š
  1. ç§’æ€å¼€å§‹å‰ï¼ŒRedis åº“å­˜åˆ†æˆ N æ®µ
  2. æ¯ä¸ª Flask å®ä¾‹é¢„åˆ†é…ä¸€æ®µåº“å­˜åˆ°æœ¬åœ°
  3. æœ¬åœ°æ‰£å‡æ— ç½‘ç»œå»¶è¿Ÿ
  4. æœ¬åœ°åº“å­˜ç”¨å®Œäº†æ‰å›æºåˆ° Redis
```

```python
# local_cache.py - æœ¬åœ°åº“å­˜ç®¡ç†
class LocalStockManager:
    def __init__(self, product_id: int, segment_size: int = 100):
        self.product_id = product_id
        self.segment_size = segment_size
        self.local_stock = 0
        self.lock = threading.Lock()
    
    def decr_stock(self, quantity: int = 1) -> bool:
        """
        æœ¬åœ°æ‰£å‡ï¼Œæ— ç½‘ç»œ I/O
        """
        with self.lock:
            if self.local_stock >= quantity:
                self.local_stock -= quantity
                return True
            
            # æœ¬åœ°åº“å­˜ä¸è¶³ï¼Œä» Redis é¢„å–
            if self._refill_from_redis():
                self.local_stock -= quantity
                return True
            
            return False
    
    def _refill_from_redis(self) -> bool:
        """
        ä» Redis é¢„å–ä¸€æ®µåº“å­˜
        å¦‚æœ Redis ä¹Ÿä¸è¶³ï¼Œè¿”å› False
        """
        remaining = cache.decrby(self.product_id, self.segment_size)
        
        if remaining >= 0:
            self.local_stock = self.segment_size
            return True
        else:
            # Redis ä¹Ÿä¸è¶³ï¼Œè¡¥å¿å›å»
            cache.incrby(self.product_id, self.segment_size)
            return False

# å…¨å±€å®ä¾‹ï¼ˆæ¯ä¸ª worker ä¸€ä¸ªï¼‰
stock_manager = LocalStockManager(PRODUCT_ID, segment_size=100)

# ä½¿ç”¨
@app.route('/api/seckill', methods=['POST'])
def seckill():
    if not stock_manager.decr_stock():
        return {'success': False, 'message': 'åº“å­˜ä¸è¶³'}, 409
    
    order_id = str(uuid.uuid4())
    producer.send_order({'order_id': order_id, ...})
    
    return {'success': True, 'order_id': order_id}, 200
```

**æ€§èƒ½æå‡**ï¼š

- åŸå…ˆï¼š100% è¯·æ±‚èµ° Redisï¼ˆ1ms RTTï¼‰
- ä¼˜åŒ–åï¼š99% è¯·æ±‚æœ¬åœ°å¤„ç†ï¼ˆ0.1msï¼‰ï¼Œ1% å›æº Redis
- æ€»å»¶è¿Ÿä» 200ms é™åˆ° 30ms

---

## æ€§èƒ½å¯¹æ¯”è¡¨

| æ–¹æ¡ˆ                | QPS     | å¹³å‡å»¶è¿Ÿ  | P99 å»¶è¿Ÿ | æˆæœ¬ | å¤æ‚åº¦ |
| ----------------- | ------- | ----- | ------ | -- | --- |
| Flask å•æœº          | 1000    | 300ms | 800ms  | ä½  | ä½   |
| Flask å¤šå®ä¾‹ + Nginx | 5000    | 150ms | 400ms  | ä¸­  | ä¸­   |
| FastAPI å¼‚æ­¥        | 25000   | 50ms  | 150ms  | ä¸­  | ä¸­   |
| FastAPI + æœ¬åœ°åº“å­˜    | 50000   | 20ms  | 80ms   | ä¸­  | é«˜   |
| å®Œæ•´ä¼˜åŒ–ï¼ˆå«æ•°æ®åº“åˆ†ç‰‡ï¼‰      | 100000+ | <10ms | <50ms  | é«˜  | é«˜   |

---

## æƒè¡¡åˆ†æï¼šä¸ºä»€ä¹ˆé€‰æ‹©æ–¹æ¡ˆ Bï¼ˆFastAPI å¼‚æ­¥ï¼‰

åœ¨ 6 å°æ—¶çš„é¢è¯•å‡†å¤‡ä¸­ï¼Œ**æ¨èé‡ç‚¹è®²è§£ FastAPI å¼‚æ­¥æ–¹æ¡ˆ**ï¼š

### ä¸ºä»€ä¹ˆä¸é€‰æ‹© "å®Œæ•´ä¼˜åŒ–"ï¼Ÿ

```
å®Œæ•´ä¼˜åŒ–åŒ…æ‹¬ï¼š
- æ•°æ®åº“åˆ†ç‰‡ï¼ˆshardingï¼‰
- Redis é›†ç¾¤
- å¤šæœºæˆ¿éƒ¨ç½²
- æ¶ˆæ¯é˜Ÿåˆ—é›†ç¾¤
- å®Œæ•´çš„ç›‘æ§å‘Šè­¦

é—®é¢˜ï¼š
1. æŠ•å…¥äº§å‡ºä¸æˆæ­£æ¯”
   - ä¸º 100000 QPS ä¼˜åŒ–ï¼Œä½†å®é™…éœ€è¦ 50000 QPS
   - YAGNIï¼šæ²¡æœ‰çœŸå®éœ€æ±‚ï¼Œå°±ä¸è¦åš
   
2. å¤æ‚åº¦çˆ†ç‚¸
   - è¿ç»´æˆæœ¬é«˜
   - æ•…éšœæ’æŸ¥éš¾
   - å›¢é˜Ÿå­¦ä¹ æˆæœ¬å¤§
   
3. é¢è¯•è§’åº¦
   - è¿‡åº¦è®¾è®¡ä¼šè¢«é—® "ä¸ºä»€ä¹ˆè¿™æ ·åšï¼Ÿ"
   - ç®€æ´æœ‰åŠ›çš„è®¾è®¡æ›´å®¹æ˜“è®²æ¸…æ¥š
```

### ä¸ºä»€ä¹ˆ FastAPI æ˜¯æœ€ä¼˜é€‰æ‹©ï¼Ÿ

```
æ€§ä»·æ¯”åˆ†æï¼š

éœ€æ±‚ï¼š10000-50000 QPSï¼ˆå…¸å‹ç§’æ€åœºæ™¯ï¼‰

æ–¹æ¡ˆå¯¹æ¯”ï¼š

A. æœ¬åœ°åº“å­˜æ–¹æ¡ˆ
   ä¼˜ç‚¹ï¼šå»¶è¿Ÿæœ€ä½ï¼ˆ20msï¼‰
   ç¼ºç‚¹ï¼šå¤šå®ä¾‹é—´åº“å­˜åè°ƒå¤æ‚ï¼Œå®¹æ˜“å‡º bug
   é€‚ç”¨ï¼šè¶…å¤§è§„æ¨¡ç§’æ€ï¼ˆ> 100000 QPSï¼‰

B. FastAPI å¼‚æ­¥
   ä¼˜ç‚¹ï¼š
   - ç®€æ´æ˜“ç»´æŠ¤
   - å»¶è¿Ÿ 50ms è¶³å¤Ÿï¼ˆP99 < 200ms å¯¹ç”¨æˆ·å¯æ¥å—ï¼‰
   - 25000 QPS å•æœºè¶³å¤Ÿï¼ˆ2-3 å°æœºå™¨æå®šï¼‰
   - æ‰©å±•æ€§å¥½
   
   ç¼ºç‚¹ï¼š
   - éœ€è¦å­¦ä¹ å¼‚æ­¥ç¼–ç¨‹
   - ä¾èµ–åº“æˆç†Ÿåº¦ï¼ˆä½† FastAPI å·²å¾ˆæˆç†Ÿï¼‰
   
   âœ… æœ€ä¼˜é€‰æ‹©

C. æœ¬åœ°åº“å­˜ + å…¶ä»–ä¼˜åŒ–
   ç­‰éœ€æ±‚çœŸçš„æ¥äº†å†ä¼˜åŒ–
```

---

# é˜¶æ®µ 5ï¼šé¢è¯•æ¨¡æ‹Ÿè®²è§£ï¼ˆ1 å°æ—¶ï¼‰

## é¢è¯•ç­”é¢˜æ¡†æ¶

### ç¬¬ä¸€æ­¥ï¼šéœ€æ±‚æ¾„æ¸…ï¼ˆ2 åˆ†é’Ÿï¼‰

```
"æˆ‘å…ˆç¡®è®¤ä¸€ä¸‹éœ€æ±‚...

åŠŸèƒ½éœ€æ±‚ï¼š
- ç”¨æˆ·åœ¨ç§’æ€å¼€å§‹æ—¶å¿«é€Ÿä¸‹å•
- æœ‰åº“å­˜é™åˆ¶ï¼Œå…ˆæ¥å…ˆå¾—
- ä¸‹å•åç”Ÿæˆè®¢å•å’Œæ”¯ä»˜æµç¨‹

éåŠŸèƒ½éœ€æ±‚ï¼š
- å‡è®¾æ¯ç§’ 10000 QPSï¼ˆ10 ç§’å–å®Œ 100000 ä»¶ï¼‰
- å»¶è¿Ÿè¦æ±‚ï¼šP99 < 500ms
- 99.9% å¯ç”¨æ€§
- ä¸èƒ½è¶…å–ï¼ˆå¼ºä¸€è‡´æ€§ï¼‰

æŠ€æœ¯æ ˆï¼šPythonã€Flaskã€PostgreSQLã€Redisã€RabbitMQ

æœ‰å…¶ä»–è¦æ¾„æ¸…çš„å—ï¼Ÿ"
```

### ç¬¬äºŒæ­¥ï¼šèƒ½åŠ›è¯„ä¼°ï¼ˆ2 åˆ†é’Ÿï¼‰

```
"åŸºäºè¿™äº›éœ€æ±‚ï¼Œæˆ‘éœ€è¦è¯„ä¼°ç³»ç»Ÿèƒ½åŠ›...

æµé‡åˆ†æï¼š
- 10000 QPS çš„æµé‡ï¼Œå•å° Flask åªèƒ½å¤„ç† 1000-2000 QPS
- éœ€è¦åˆ†å¸ƒå¼æ¶æ„

å­˜å‚¨åˆ†æï¼š
- 100000 è®¢å•ï¼Œæ¯æ¡ 1KBï¼Œæ€»å…± 100MB
- å¯ä»¥å•æœºå­˜å‚¨ï¼ŒçŸ­æœŸå†…å‹åŠ›ä¸å¤§

æ ¸å¿ƒç“¶é¢ˆï¼š
- åº“å­˜æ‰£å‡çš„å¹¶å‘æ§åˆ¶
- æ•°æ®åº“ I/O ä¸èƒ½åŒæ—¶å¤„ç† 10000 å†™å…¥

æ‰€ä»¥è®¾è®¡çš„å…³é”®æ˜¯ï¼šè§£å†³å¹¶å‘å†™å…¥çš„ç“¶é¢ˆ"
```

### ç¬¬ä¸‰æ­¥ï¼šé«˜å±‚è®¾è®¡ï¼ˆ5 åˆ†é’Ÿï¼‰

```
"æˆ‘ä¼šé‡‡ç”¨ å‰Šå³° + å¼‚æ­¥å¤„ç† çš„æ¶æ„...

[ç”»å›¾]

     50000 QPS
        â†“
    [Nginx LB]
        â†“
   [é™æµ: 15000]
        â†“
    [Flask Ã— 4]
        â†“
   åˆ†ä¸ºä¸¤ä¸ªæµç¨‹ï¼š

å¿«é€Ÿè·¯å¾„ï¼ˆå½±å“ç”¨æˆ·ä½“éªŒï¼‰ï¼š
  1. ç”¨æˆ·é™æµæ£€æŸ¥
  2. Redis é¢„å‡åº“å­˜
  3. è¿”å›æˆåŠŸå“åº”
  â†’ æ€»æ—¶é—´ < 50ms

å¼‚æ­¥è·¯å¾„ï¼ˆåå°å¤„ç†ï¼‰ï¼š
  1. æ¶ˆæ¯å‘é€åˆ° MQ
  2. è®¢å•æœåŠ¡æ¶ˆè´¹ MQ
  3. æ•°æ®åº“çœŸå®æ‰£å‡
  4. å‘é€ç¡®è®¤/æ”¯ä»˜é€šçŸ¥
  â†’ å¤„ç†æ—¶é—´æ— é™åˆ¶

å…³é”®è®¾è®¡ç‚¹ï¼š
- é™æµå‰Šå³°ï¼šåœ¨ç½‘å…³å±‚é™åˆ¶åˆ° 15000 QPS
- åº“å­˜é¢„å‡ï¼šRedis åŸå­æ“ä½œï¼Œç§’çº§å“åº”
- å¼‚æ­¥è§£è€¦ï¼šMQ ä¿è¯è®¢å•ä¸ä¸¢å¤±
- æœ€ç»ˆä¸€è‡´æ€§ï¼šå…è®¸çŸ­æš‚ä¸ä¸€è‡´
"
```

### ç¬¬å››æ­¥ï¼šæ·±åº¦ä¼˜åŒ–ï¼ˆ3 åˆ†é’Ÿï¼‰

```
"ç„¶åè®¨è®ºå‡ ä¸ªå…³é”®çš„æŠ€æœ¯ç»†èŠ‚...

1. ä¸ºä»€ä¹ˆç”¨ Redis é¢„å‡è€Œä¸æ˜¯æ•°æ®åº“ï¼Ÿ
   âœ“ Redis ååé‡ 100000+ QPSï¼Œæ”¯æŒåŸå­æ“ä½œ DECR
   âœ— æ•°æ®åº“ 1000-5000 QPSï¼Œè¡Œé”ä¼šä¸¥é‡ç«äº‰
   ç»“è®ºï¼šRedis æ˜¯å”¯ä¸€é€‰æ‹©

2. ä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ
   ä¸ç”¨ MQï¼šFlask ç›´æ¥å†™ DB
     - å“åº”æ—¶é—´é•¿ï¼ˆéœ€è¦ç­‰å¾… DB è¿”å›ï¼‰
     - DB å‹åŠ›å¤§ï¼ˆæ‰€æœ‰å†™éƒ½æ¥ï¼‰
     - ä¸€ä¸ªä¸‹æ¸¸æ•…éšœå¯¼è‡´æ•´ä¸ªæµç¨‹å¡ä½
   
   ç”¨ MQï¼šFlask å‘é€æ¶ˆæ¯åç«‹å³è¿”å›
     - å“åº”å¿«ï¼ˆ< 50msï¼‰
     - DB å‹åŠ›åˆ†æ•£ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
     - è§£è€¦æ€§å¥½ï¼ˆæœåŠ¡ç‹¬ç«‹éƒ¨ç½²ï¼‰
   
   âœ“ å¿…é¡»æœ‰ MQ

3. å¦‚æœ Redis ä¹ŸæŒ‚äº†å‘¢ï¼Ÿ
   é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨æœ¬åœ°å†…å­˜ + å®šæœŸåŒæ­¥
   æ¯ä¸ª Flask å®ä¾‹é¢„åˆ†é…ä¸€æ®µåº“å­˜åˆ°æœ¬åœ°å†…å­˜
   æœ¬åœ°æ‰£å‡æ— ç½‘ç»œå»¶è¿Ÿ
   
4. è¶…å–é—®é¢˜æ€ä¹ˆå¤„ç†ï¼Ÿ
   è™½ç„¶æˆ‘ä»¬ç”¨äº† Redis é¢„å‡ï¼Œä½†åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä»å¯èƒ½è¶…å–ï¼š
   
   åœºæ™¯ï¼šRedis é¢„å‡æˆåŠŸåï¼ŒMQ å‘é€å¤±è´¥
   â†’ è®¢å•ä¸¢å¤±ï¼Œåº“å­˜è¢«é”™è¯¯åœ°å‡äº†
   
   è§£å†³ï¼š
   æ–¹æ¡ˆ Aï¼šä½¿ç”¨äº‹åŠ¡ï¼ˆRedis MULTI/EXECï¼‰
   æ–¹æ¡ˆ Bï¼šMQ ä¿è¯ at-least-once é€è¾¾
   æ–¹æ¡ˆ Cï¼šåæœŸå¯¹è´¦è¡¥å¿
   
   æ¨èï¼šæ–¹æ¡ˆ B + æ–¹æ¡ˆ Cï¼ˆé€šå¸¸çš„ç”µå•†åšæ³•ï¼‰
"
```

### ç¬¬äº”æ­¥ï¼šæ•…éšœå¤„ç†ä¸ç›‘æ§ï¼ˆ2 åˆ†é’Ÿï¼‰

```
"ç„¶åè®¨è®ºè¿ç»´å’Œç›‘æ§...

å•ç‚¹æ•…éšœåœºæ™¯ï¼š

1. Flask æŸä¸ªå®ä¾‹æŒ‚äº†
   è‡ªåŠ¨æ¢å¤ï¼šNginx å¥åº·æ£€æŸ¥è‡ªåŠ¨æ‘˜é™¤è¯¥å®ä¾‹
   å½±å“ï¼šæµé‡åˆ†æ•£åˆ°å…¶ä»–å®ä¾‹ï¼Œæ€»ååé‡ä¸‹é™ 25%

2. Redis æŒ‚äº†
   ç«‹å³å½±å“ï¼šåº“å­˜é¢„å‡å¤±è´¥ï¼Œæ— æ³•ä¸‹å•
   æ¢å¤ï¼š
     a) ä¸»ä»åˆ‡æ¢ï¼ˆå·²é…ç½®ä»åº“ï¼‰
     b) ä¸´æ—¶é™çº§åˆ°æœ¬åœ°å†…å­˜ + æ‰‹åŠ¨å¯¹è´¦

3. MQ é˜Ÿåˆ—å †ç§¯
   å¯æ§ï¼šè®¢å•å¤„ç†æ˜¯å¼‚æ­¥çš„ï¼Œæ…¢ä¸€ç‚¹æ²¡å…³ç³»
   ç›‘æ§æŒ‡æ ‡ï¼šé˜Ÿåˆ—æ·±åº¦
   è§¦å‘å‘Šè­¦ï¼šé˜Ÿåˆ— > 10000 æ¡æ¶ˆæ¯

4. æ•°æ®åº“æ•…éšœ
   ç—‡çŠ¶ï¼šè®¢å•å¤„ç† 500 error
   æ¢å¤ï¼šè¯»å†™åˆ†ç¦» + ä»åº“è‡ªåŠ¨æå‡
   è¡¥å¿ï¼šå¤±è´¥è®¢å•è‡ªåŠ¨é‡è¯•

ç›‘æ§æŒ‡æ ‡ï¼š
- QPSï¼ˆæµé‡ï¼‰
- P99 å»¶è¿Ÿï¼ˆç”¨æˆ·ä½“éªŒï¼‰
- åº“å­˜å‡†ç¡®ç‡ï¼ˆé¢„å‡ vs çœŸå®ï¼‰
- MQ å †ç§¯é•¿åº¦
- Redis å†…å­˜å ç”¨
- æ•°æ®åº“è¿æ¥æ•°
"
```

### ç¬¬å…­æ­¥ï¼šæ‰©å±•è®¨è®ºï¼ˆ2-3 åˆ†é’Ÿï¼‰

```
"æœ€åï¼Œè®¨è®ºå¦‚æœéœ€æ±‚å˜äº†æ€ä¹ˆåŠ...

Q: å¦‚æœ QPS å‡åˆ° 50000 å‘¢ï¼Ÿ
A: 
  æ–¹æ¡ˆ 1ï¼šå¢åŠ  Flask å®ä¾‹åˆ° 10 å°ï¼ˆæˆæœ¬ä½ï¼‰
  æ–¹æ¡ˆ 2ï¼šåˆ‡æ¢åˆ° FastAPI å¼‚æ­¥æ¡†æ¶ï¼ˆæŠ€æœ¯å‡çº§ï¼‰
  æ¨èï¼šå…ˆç”¨æ–¹æ¡ˆ 1ï¼Œå¦‚æœæˆæœ¬æˆä¸ºç“¶é¢ˆå†å‡çº§

Q: å¦‚æœä¸èƒ½æ¥å—åº“å­˜ä¸å‡†ç¡®ï¼ˆè¶…å–ï¼‰å‘¢ï¼Ÿ
A:
  å½“å‰æ–¹æ¡ˆå…è®¸ < 1% çš„ä¸å‡†ç¡®ç‡
  å¦‚æœè¦æ±‚ 100% å‡†ç¡®ï¼š
    - ä½¿ç”¨æ•°æ®åº“è¡Œé”ï¼ˆä½†ååé‡ä¸‹é™åˆ° 1000 QPSï¼‰
    - ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼ˆRedlockï¼‰ä½†ä»æœ‰ç«äº‰
    - éœ€è¦æ ¹æ®ä¸šåŠ¡é‡æ–°æƒè¡¡
  
  ç§’æ€åœºæ™¯é€šå¸¸å…è®¸ä¸€å®šä¸å‡†ç¡®ç‡

Q: æ€ä¹ˆå¤„ç†æ¶æ„ç”¨æˆ·çš„æœºå™¨åˆ·å•ï¼Ÿ
A:
  å¤šå±‚é™æµï¼š
    1. IP å±‚é™æµï¼ˆé˜² IP åˆ·ï¼‰
    2. ç”¨æˆ·å±‚é™æµï¼ˆé˜²è´¦å·åˆ·ï¼‰
    3. è®¾å¤‡æŒ‡çº¹è¯†åˆ«ï¼ˆé˜²æœºå™¨åˆ·ï¼‰
    4. äººæœºéªŒè¯ï¼ˆå¯é€‰ï¼‰

Q: è®¢å•ç¡®è®¤å¤±è´¥åæ€ä¹ˆè¡¥å¿ï¼Ÿ
A:
  æ–¹æ¡ˆï¼šæ­»ä¿¡é˜Ÿåˆ— + äººå·¥ä»‹å…¥
  
  æ­¥éª¤ï¼š
    1. è®¢å•å¤„ç†å¤±è´¥ 3 æ¬¡åè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—
    2. å‘Šè­¦é€šçŸ¥äººå·¥å¤„ç†
    3. äººå·¥ç¡®è®¤æ˜¯å¦çœŸçš„è¶…å–æˆ–å…¶ä»–é—®é¢˜
    4. ç›¸åº”è¡¥å¿å®¢æˆ·ï¼ˆé€€æ¬¾æˆ– creditï¼‰
"
```

---

## å®Œæ•´æ¨¡æ‹Ÿç­”é¢˜ï¼ˆ3-5 åˆ†é’Ÿç‰ˆæœ¬ï¼‰

```
é¢è¯•å®˜ï¼š"è®¾è®¡ä¸€ä¸ªç§’æ€ç³»ç»Ÿ"

æˆ‘çš„å›ç­”ï¼š

"å¥½çš„ï¼Œæˆ‘å…ˆæ¾„æ¸…éœ€æ±‚ã€‚

å‡è®¾æˆ‘ä»¬è¦è®¾è®¡ä¸€ä¸ªå– 100000 ä»¶å•†å“çš„ç§’æ€ï¼Œ
é¢„è®¡ 10 ç§’å†… 100000 è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯ 10000 QPSã€‚
ç›®æ ‡æ˜¯ P99 å»¶è¿Ÿ < 500msï¼Œä¸èƒ½è¶…å–ã€‚

åŸºäºè¿™ä¸ªéœ€æ±‚ï¼Œæˆ‘è¯†åˆ«å‡ºæ ¸å¿ƒç“¶é¢ˆï¼š
å•æœºæ•°æ®åº“æœ€å¤šæ”¯æŒ 1000-5000 QPSï¼Œ
æ— æ³•å¤„ç† 10000 QPS çš„å¹¶å‘å†™å…¥ã€‚

æ‰€ä»¥æˆ‘çš„è®¾è®¡æ€è·¯æ˜¯ï¼šå‰Šå³° + å¼‚æ­¥å¤„ç†ã€‚

æ¶æ„åŒ…æ‹¬ï¼š
- Nginx ä½œä¸ºè´Ÿè½½å‡è¡¡å’Œé™æµ
- 4 ä¸ª Flask å®ä¾‹å¤„ç†è¯·æ±‚
- Redis ç¼“å­˜åº“å­˜
- RabbitMQ æ¶ˆæ¯é˜Ÿåˆ—
- PostgreSQL æ•°æ®åº“

æ ¸å¿ƒæµç¨‹åˆ†ä¸¤éƒ¨åˆ†ï¼š

ç¬¬ä¸€éƒ¨åˆ†ï¼ˆå¿«é€Ÿè·¯å¾„ï¼‰ï¼š
1. ç”¨æˆ·å‘èµ·è¯·æ±‚
2. Nginx é™æµåˆ° 15000 QPS
3. Flask æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¶…é™
4. Flask åœ¨ Redis ä¸­åŸå­æ€§åœ°æ‰£å‡åº“å­˜ï¼ˆDECRï¼‰
5. å¦‚æœæˆåŠŸï¼Œç”Ÿæˆè®¢å• IDï¼Œå‘é€æ¶ˆæ¯åˆ° MQ
6. ç«‹å³è¿”å›ç»™ç”¨æˆ·ï¼ˆ< 50msï¼‰

ç¬¬äºŒéƒ¨åˆ†ï¼ˆå¼‚æ­¥è·¯å¾„ï¼‰ï¼š
1. åç«¯è®¢å•æœåŠ¡æ¶ˆè´¹ MQ æ¶ˆæ¯
2. åœ¨æ•°æ®åº“ä¸­åˆ›å»ºå®é™…è®¢å•
3. è§¦å‘æ”¯ä»˜å’Œç‰©æµæµç¨‹
4. å¦‚æœå¤±è´¥ï¼Œé‡è¯•æˆ–è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—

ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

- é™æµï¼šé˜²æ­¢ 50000 QPS çš„æµé‡å…¨éƒ¨æ‰“åˆ°åç«¯
- Redis é¢„å‡ï¼šç§’çº§å“åº”ï¼Œååé‡è¶³å¤Ÿ
- æ¶ˆæ¯é˜Ÿåˆ—ï¼šè§£è€¦ï¼Œå¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡ç”¨æˆ·
- æ•°æ®åº“å‹åŠ›åˆ†æ•£ï¼šå†™å…¥ä»å¹¶å‘ 10000 é™åˆ°å¼‚æ­¥ 100-200

å…³äºè¶…å–é—®é¢˜ï¼š
å› ä¸ºç”¨äº† Redis åŸå­æ“ä½œï¼Œç†è®ºä¸Šä¸ä¼šè¶…å–ã€‚
ä½†åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¦‚æœ MQ å‘é€å¤±è´¥ï¼Œè®¢å•å¯èƒ½ä¸¢å¤±ã€‚
æ‰€ä»¥éœ€è¦å¯¹è´¦è¡¥å¿æœºåˆ¶ã€‚

å¦‚æœéœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œå¯ä»¥ï¼š
1. åˆ‡æ¢åˆ° FastAPI å¼‚æ­¥æ¡†æ¶ï¼ˆæå‡ 25 å€ååé‡ï¼‰
2. ä½¿ç”¨æœ¬åœ°å†…å­˜é¢„åˆ†é…åº“å­˜ï¼ˆé™ä½å»¶è¿Ÿï¼‰
3. æ•°æ®åº“åˆ†ç‰‡ï¼ˆæ”¯æŒæ›´é«˜ QPSï¼‰

ä½†å¯¹äºè¿™ä¸ªéœ€æ±‚ï¼Œå½“å‰æ–¹æ¡ˆå·²ç»è¶³å¤Ÿã€‚

æœ‰ä»€ä¹ˆæƒ³æ·±å…¥è®¨è®ºçš„å—ï¼Ÿ"
```

---

## å¸¸è§è¿½é—®åŠå›ç­”

### è¿½é—® 1ï¼š"ä¸ºä»€ä¹ˆä¸ç”¨å…¶ä»– MQ æ¯”å¦‚ Kafkaï¼Ÿ"

```
æˆ‘çš„è€ƒè™‘ï¼š
- RabbitMQï¼šå®æ—¶æ¶ˆæ¯ï¼Œæ”¯æŒ ACKï¼Œæ¶ˆè´¹ç¡®è®¤æœºåˆ¶å¥½
- Kafkaï¼šé«˜ååæ—¥å¿—ç³»ç»Ÿï¼Œé€šå¸¸ç”¨äºæ•°æ®æµå¤„ç†

è¿™ä¸ªåœºæ™¯æˆ‘ä»¬éœ€è¦ï¼š
âœ“ æ¶ˆæ¯ä¸ä¸¢å¤±ï¼ˆRabbitMQ ACK æœºåˆ¶ï¼‰
âœ“ æ¶ˆæ¯æœ‰åºï¼ˆRabbitMQ é˜Ÿåˆ—ï¼‰
âœ“ æ¶ˆè´¹ç¡®è®¤ï¼ˆRabbitMQ å†…ç½®ï¼‰
âœ“ ååé‡ 10000 å°±å¤Ÿï¼ˆRabbitMQ å®Œå…¨æ”¯æŒï¼‰

è€Œä¸éœ€è¦ï¼š
âœ— è¶…é«˜ååï¼ˆKafka çš„å¼ºé¡¹ï¼‰
âœ— æ¶ˆæ¯é‡æ”¾ï¼ˆæ—¥å¿—ç³»ç»Ÿç”¨ï¼‰
âœ— åˆ†å¸ƒå¼äº‹åŠ¡æ—¥å¿—ï¼ˆå¤ªå¤æ‚ï¼‰

æ‰€ä»¥ RabbitMQ æ˜¯æœ€åˆé€‚çš„é€‰æ‹©ã€‚

å½“ç„¶ï¼Œå¦‚æœæœ‰ç°æˆçš„ Kafka é›†ç¾¤ï¼Œ
ç”¨ Kafka ä¹Ÿä¸æ˜¯ä¸å¯ä»¥ï¼Œä½† Kafka æœ‰ç‚¹æ€é¸¡ç”¨ç‰›åˆ€ã€‚
```

### è¿½é—® 2ï¼š"å¦‚æœåŒä¸€ä¸ªç”¨æˆ·ç–¯ç‹‚åˆ·å•æ€ä¹ˆåŠï¼Ÿ"

```
å¤šå±‚é˜²å¾¡ï¼š

ç¬¬ä¸€å±‚ï¼ˆåº”ç”¨å±‚ï¼‰ï¼šç”¨æˆ·é™æµ
- æ¯ä¸ªç”¨æˆ· 10 ç§’å†…æœ€å¤š 5 ä¸ªè¯·æ±‚
- ç”¨ä»¤ç‰Œæ¡¶æˆ–æ»‘åŠ¨çª—å£å®ç°

ç¬¬äºŒå±‚ï¼ˆIP å±‚ï¼‰ï¼šIP é™æµ
- åŒä¸€ IP 10 ç§’å†…æœ€å¤š 100 ä¸ªè¯·æ±‚
- åœ¨ Nginx é…ç½®

ç¬¬ä¸‰å±‚ï¼ˆè®¾å¤‡è¯†åˆ«ï¼‰ï¼šè®¾å¤‡æŒ‡çº¹
- æ ¹æ® User-Agentã€æµè§ˆå™¨ä¿¡æ¯è¯†åˆ«
- åŒä¸€è®¾å¤‡ 10 ç§’å†…æœ€å¤š 5 ä¸ªè¯·æ±‚

ç¬¬å››å±‚ï¼ˆäººæœºè¯†åˆ«ï¼‰ï¼šå¯é€‰
- å¦‚æœç”¨æˆ·è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¦æ±‚è¾“å…¥éªŒè¯ç 
- å¢åŠ æœºå™¨åˆ·å•æˆæœ¬

è¿™æ ·å°±åŸºæœ¬é˜²ä½äº†å•ç”¨æˆ·åˆ·å•ã€‚

å¦‚æœæ˜¯é»‘äº§ï¼ˆæ•°åƒåƒµå°¸å·åŒæ—¶åˆ·ï¼‰ï¼Œ
é‚£éœ€è¦é£æ§ç³»ç»Ÿå’Œå¤§æ•°æ®åˆ†æï¼Œ
è¿™æ˜¯å¦ä¸€ä¸ªä¸“é¢˜äº†ã€‚
```

### è¿½é—® 3ï¼š"åº“å­˜é¢„å‡æˆåŠŸä½† MQ å‘é€å¤±è´¥äº†ï¼Œè®¢å•ä¸¢å¤±æ€ä¹ˆåŠï¼Ÿ"

```
è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ã€‚

åœºæ™¯ï¼š
1. Redis é¢„å‡æˆåŠŸï¼Œåº“å­˜ -1
2. MQ å‘é€å¤±è´¥ï¼Œå¼‚å¸¸è¿”å›ç»™ç”¨æˆ·
3. ç”¨æˆ·ä»¥ä¸ºä¸‹å•å¤±è´¥ï¼Œé‡æ–°å°è¯•
4. è¿™ä¸€æ¬¡ MQ å‘é€æˆåŠŸ
5. ç»“æœï¼šåº“å­˜è¢«æ‰£äº†ä¸¤æ¬¡

è§£å†³æ–¹æ¡ˆï¼š

æ–¹æ¡ˆ Aï¼šä½¿ç”¨æœ¬åœ°äº‹åŠ¡ï¼ˆä¸æ¨èï¼‰
- åœ¨ Flask ä¸­ä½¿ç”¨ Python äº‹åŠ¡
- åŒæ—¶æäº¤åˆ° Redis å’Œ MQ
- é—®é¢˜ï¼šå¦‚æœ MQ å®é™…ä¸Šå‘é€æˆåŠŸäº†ï¼Œåªæ˜¯ç½‘ç»œé—®é¢˜å‘¢ï¼Ÿ

æ–¹æ¡ˆ Bï¼šå¹‚ç­‰æ€§ + åæœŸå¯¹è´¦ï¼ˆæ¨èï¼‰
- æ¯ä¸ªè®¢å•æœ‰å”¯ä¸€ order_id
- MQ æ¶ˆè´¹ç«¯æ ¹æ® order_id å»é‡
- å³ä½¿å‘é€ä¸¤æ¬¡ï¼Œæ•°æ®åº“ä¹Ÿåªæ’å…¥ä¸€æ¡
- å®šæœŸå¯¹è´¦æ£€æŸ¥ Redis åº“å­˜ vs æ•°æ®åº“åº“å­˜

æ–¹æ¡ˆ Cï¼šä¸¤é˜¶æ®µæäº¤ï¼ˆå¯ç”¨ä½†å¤æ‚ï¼‰
- å…ˆ prepareï¼Œç¡®ä¿ä¸¤è¾¹éƒ½å‡†å¤‡å¥½
- å† commit
- é—®é¢˜ï¼šåˆ†å¸ƒå¼äº‹åŠ¡æ€§èƒ½å·®ï¼Œä¸é€‚åˆç§’æ€

æˆ‘æ¨èæ–¹æ¡ˆ Bï¼š
- ç®€æ´æœ‰æ•ˆ
- é«˜æ€§èƒ½
- æ˜“äºå®ç°å’Œç»´æŠ¤
```

---

# è‡ªæ£€æ¸…å•ä¸å·©å›ºï¼ˆå‰©ä½™æ—¶é—´ï¼‰

## âœ… ä½ åº”è¯¥èƒ½è®²æ¸…æ¥šçš„ 5 ä¸ªé—®é¢˜

å¦‚æœä½ èƒ½æ¸…æ™°åœ°å›ç­”è¿™ 5 ä¸ªï¼Œè¯´æ˜ä½ çœŸçš„ç†è§£äº†ï¼š

1. **"ä¸ºä»€ä¹ˆç”¨ Redis é¢„å‡è€Œä¸æ˜¯æ•°æ®åº“ï¼Ÿ"**

   - ç­”ï¼šRedis ååé‡ 100000+ QPSï¼ŒDB åªæœ‰ 1000-5000 QPS
   - æ·±å±‚ï¼šç†è§£æ•°æ®åº“é”ç«äº‰çš„åŸç†
2. **"å¦‚æœ Redis æŒ‚äº†æ€ä¹ˆåŠï¼Ÿ"**

   - ç­”ï¼šä¸»ä»åˆ‡æ¢ + æœ¬åœ°å†…å­˜é™çº§
   - æ·±å±‚ï¼šç†è§£é«˜å¯ç”¨çš„å¤šä¸ªæ–¹æ¡ˆ
3. **"ä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ"**

   - ç­”ï¼šå¼‚æ­¥è§£è€¦ï¼Œé™ä½å»¶è¿Ÿï¼Œåˆ†æ•£æ•°æ®åº“å‹åŠ›
   - æ·±å±‚ï¼šç†è§£åŒæ­¥ vs å¼‚æ­¥çš„æƒè¡¡
4. **"å¯èƒ½è¶…å–å—ï¼Ÿ"**

   - ç­”ï¼šç†è®ºä¸Šç”¨ Redis ä¸ä¼šï¼Œä½†åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æœ‰å…¶ä»–é£é™©
   - æ·±å±‚ï¼šç†è§£åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜
5. **"æ€æ ·ä» 10000 QPS æ‰©åˆ° 50000 QPSï¼Ÿ"**

   - ç­”ï¼šå¢åŠ å®ä¾‹ã€ç”¨å¼‚æ­¥æ¡†æ¶ã€æœ¬åœ°åº“å­˜ã€æ•°æ®åº“åˆ†ç‰‡
   - æ·±å±‚ï¼šç†è§£æ°´å¹³æ‰©å±•çš„å¤šç§æ–¹å¼

---

## ğŸ“š å­¦ä¹ ææ–™æ¨è

### ä¹¦ç±

- **ã€Šè®¾è®¡æ•°æ®å¯†é›†å‹åº”ç”¨ã€‹** - åˆ†å¸ƒå¼ç³»ç»Ÿçš„åœ£ç»ï¼ˆç¬¬ 5-9 ç« ï¼‰
- **ã€ŠMySQL æ˜¯æ€æ ·è¿è¡Œçš„ã€‹** - ç†è§£æ•°æ®åº“å¹¶å‘ï¼ˆé”ç« èŠ‚ï¼‰
- **ã€Šæ·±å…¥æµ…å‡º RabbitMQã€‹** - æ¶ˆæ¯é˜Ÿåˆ—åŸç†

### è§†é¢‘

- Grokking the System Design Interviewï¼ˆå­—èŠ‚ã€LeetCode æœ‰æ­£ç‰ˆè¯¾ç¨‹ï¼‰
- ç§’æ€ç³»ç»Ÿè®¾è®¡ï¼ˆæ˜é‡‘ã€B ç«™æœ‰å…è´¹è®²è§£ï¼‰
- Python å¼‚æ­¥ç¼–ç¨‹ï¼ˆFastAPI å®˜æ–¹æ–‡æ¡£å¾ˆå¥½ï¼‰

### å¼€æºé¡¹ç›®

- Redisï¼šç†è§£å•çº¿ç¨‹ + äº‹ä»¶é©±åŠ¨çš„é«˜æ€§èƒ½ç§˜è¯€
- RabbitMQï¼šç†è§£é˜Ÿåˆ—å’Œ ACK æœºåˆ¶
- FastAPIï¼šç°ä»£å¼‚æ­¥æ¡†æ¶çš„æœ€ä½³å®è·µ

---

## ğŸ¯ 6 å°æ—¶åçš„ä½ 

å®Œæˆè¿™ä¸ªæ–¹æ¡ˆåï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

âœ… **è®¾è®¡å±‚é¢**

- å¿«é€Ÿè¯†åˆ«ç³»ç»Ÿç“¶é¢ˆ
- æå‡º 2-3 ä¸ªå¯è¡Œçš„è§£å†³æ–¹æ¡ˆ
- ç”¨ CAP ç†è®ºåˆ†ææƒè¡¡

âœ… **ä»£ç å±‚é¢**

- å†™å‡ºå¯å·¥ä½œçš„ç§’æ€ç³»ç»Ÿ
- ç†è§£å¼‚æ­¥ç¼–ç¨‹çš„ä¼˜åŠ¿
- çŸ¥é“æ€ä¹ˆæµ‹è¯•å’Œä¼˜åŒ–

âœ… **é¢è¯•å±‚é¢**

- æ¸…æ™°è®²è§£æ¶æ„è®¾è®¡
- å›ç­”å¸¸è§è¿½é—®
- å±•ç¤ºå¯¹åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç†è§£

âœ… **å·¥ç¨‹å®è·µå±‚é¢**

- çŸ¥é“ä»€ä¹ˆæ˜¯å¿…è¦çš„ï¼ˆRedisã€MQï¼‰
- çŸ¥é“ä»€ä¹ˆå¯ä»¥å»¶è¿Ÿï¼ˆæ•°æ®åº“åˆ†ç‰‡ï¼‰
- åº”ç”¨ YAGNI åŸåˆ™åšå†³ç­–

---

## ğŸ’¡ æœ€åçš„å»ºè®®

è¿™ä¸ªæ–¹æ¡ˆéµå¾ª **YAGNI åŸåˆ™**ï¼š

âœ“ **å­¦çš„æ˜¯å¿…è¦çš„**ï¼šé™æµã€Redisã€MQã€å¼‚æ­¥ âœ— **ä¸å­¦æ²¡å¿…è¦çš„**ï¼šKafkaã€RPC æ¡†æ¶ã€åˆ†å¸ƒå¼äº‹åŠ¡ã€K8s éƒ¨ç½²

åœ¨ 6 å°æ—¶å†…é›†ä¸­çªç ´ï¼Œæ¯”æµ…å° 20 ä¸ªæŠ€æœ¯æœ‰ç”¨å¾—å¤šã€‚

**ä¸‹æ¬¡é¢è¯•æ—¶ï¼Œä½ å¯ä»¥è‡ªä¿¡åœ°è¯´ï¼š**

> "æˆ‘ä¸ä»…çŸ¥é“æ€ä¹ˆè®¾è®¡ç§’æ€ç³»ç»Ÿï¼Œè¿˜ç†è§£ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Œ ä»¥åŠåœ¨ä¸åŒéœ€æ±‚ä¸‹å¦‚ä½•æƒè¡¡å’Œä¼˜åŒ–ã€‚"

åŠ æ²¹ï¼ğŸš€

---

## åè®°

## ğŸ“Œ æ ¸å¿ƒå†…å®¹æ¢³ç†

è¿™ä»½æ–‡æ¡£åŒ…æ‹¬ï¼š

### **é˜¶æ®µ 1-2ï¼šæ€ç»´æ¡†æ¶ + æ¶æ„è®¾è®¡**ï¼ˆ2 å°æ—¶ï¼‰

- ç³»ç»Ÿè®¾è®¡çš„é€šç”¨æ€ç»´æ¡†æ¶
- ç§’æ€åœºæ™¯çš„ä¸‰ä¸ªæ ¸å¿ƒå†³ç­–ç‚¹ï¼ˆé™æµã€åº“å­˜æ‰£å‡ã€æ¶ˆæ¯é˜Ÿåˆ—ï¼‰
- å®Œæ•´çš„æ¶æ„å›¾å’Œéœ€æ±‚æ‹†è§£

### **é˜¶æ®µ 3ï¼šå¯è¿è¡Œä»£ç **ï¼ˆ2 å°æ—¶ï¼‰

- Flask + Redis + RabbitMQ çš„å®Œæ•´å®ç°
- é™æµå™¨ã€ç¼“å­˜å±‚ã€MQ å°è£…çš„ä»£ç ç¤ºä¾‹
- å‹æµ‹è„šæœ¬ï¼ˆå¯ä»¥ç›´æ¥è·‘ï¼‰

### **é˜¶æ®µ 4ï¼šæ€§èƒ½ä¼˜åŒ–**ï¼ˆ1 å°æ—¶ï¼‰

- 3 ä¸ªé€’è¿›å¼ä¼˜åŒ–æ–¹æ¡ˆï¼ˆæ°´å¹³æ‰©å±• â†’ å¼‚æ­¥æ¡†æ¶ â†’ æœ¬åœ°åº“å­˜ï¼‰
- æ€§èƒ½å¯¹æ¯”è¡¨ï¼ˆQPSã€å»¶è¿Ÿã€æˆæœ¬ã€å¤æ‚åº¦ï¼‰
- **YAGNI åŸåˆ™çš„å®é™…åº”ç”¨**ï¼šä¸ºä»€ä¹ˆä¸è¿‡åº¦ä¼˜åŒ–

### **é˜¶æ®µ 5ï¼šé¢è¯•æ¨¡æ‹Ÿ**ï¼ˆ1 å°æ—¶ï¼‰

- 5 ä¸ªé¢è¯•å¸¸è§è¿½é—®çš„æ ‡å‡†ç­”æ³•
- 3-5 åˆ†é’Ÿçš„å®Œæ•´è®²è§£æ¨¡æ¿
- è‡ªæ£€æ¸…å•ï¼ˆ5 ä¸ªæ ¸å¿ƒé—®é¢˜ï¼‰

---

## ğŸ¯ ç«‹å³å¯ç”¨çš„éƒ¨åˆ†

1. **ä»£ç å¯ä»¥ç›´æ¥è·‘**ï¼ˆå¦‚æœä½ é…ç½®å¥½ Redis + RabbitMQï¼‰
2. **é¢è¯•ç­”é¢˜æ¡†æ¶** å¯ä»¥èƒŒä¸‹æ¥ï¼Œå¥—ç”¨åˆ°å…¶ä»–ç³»ç»Ÿè®¾è®¡é¢˜
3. **æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ** å¯ä»¥åº”ç”¨åˆ°ä½ ç°åœ¨çš„å·¥ä½œç³»ç»Ÿä¸­

---

## ğŸ’¡ åç»­å»ºè®®

å› ä¸ºä½ è¯´**åªæœ‰ 6 å°æ—¶**ï¼Œè¿™ä»½æ–¹æ¡ˆæ˜¯**ç²¾å¿ƒç­›é€‰çš„**ã€‚å¦‚æœä½ è¿˜æƒ³æ·±å…¥æŸä¸ªéƒ¨åˆ†ï¼š

- **å¼‚æ­¥ç¼–ç¨‹** â†’ çœ‹ FastAPI ä»£ç ç¤ºä¾‹ï¼ˆæ–‡æ¡£å¯ä»¥è¡¥å……ï¼‰
- **åˆ†å¸ƒå¼ä¸€è‡´æ€§** â†’ çœ‹ç¬¬ 5 é˜¶æ®µçš„"è¶…å–é—®é¢˜"è®¨è®º
- **å®é™…è¿ç»´** â†’ å¯ä»¥è®¨è®ºç›‘æ§å‘Šè­¦å’Œæ•…éšœæ¢å¤

**æœ‰ä»€ä¹ˆæƒ³è¿›ä¸€æ­¥å±•å¼€çš„å—ï¼Ÿ** æ¯”å¦‚ï¼š

- è¦æˆ‘å†™ FastAPI ç‰ˆæœ¬çš„å®Œæ•´ä»£ç å—ï¼Ÿ
- æƒ³è¦æ€§èƒ½å‹æµ‹çš„è¯¦ç»†ç»“æœåˆ†æå—ï¼Ÿ
- éœ€è¦å…¶ä»–ç³»ç»Ÿè®¾è®¡é¢˜ï¼ˆå¦‚æŠ–éŸ³æ¨èã€æ”¯ä»˜ç³»ç»Ÿï¼‰çš„æ¡†æ¶å—ï¼Ÿ
